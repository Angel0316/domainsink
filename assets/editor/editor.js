(function(){var w={};w.settings={};w.post=function(a){return new A('post',a)};w.get=function(a){return new A('get',a)};var A=function(a,b){var c={method:a,url:'',before:function(){},success:function(){},error:function(){},data:false,async:true,headers:{}};this.p=this.extend(c,b);this.p=this.extend(this.p,w.settings);this.p.method=this.p.method.toUpperCase();this.prepareData();this.xhr=new XMLHttpRequest();this.xhr.open(this.p.method,this.p.url,this.p.async);this.setHeaders();var d=(typeof this.p.before==='function')?this.p.before(this.xhr):true;if(d!==false){this.send()}};A.prototype={extend:function(a,b){if(b)for(var c in b){a[c]=b[c]}return a},prepareData:function(){if(this.p.method==='POST'&&!this.isFormData())this.p.headers['Content-Type']='application/x-www-form-urlencoded';if(typeof this.p.data==='object'&&!this.isFormData())this.p.data=this.toParams(this.p.data);if(this.p.method==='GET')this.p.url=(this.p.data)?this.p.url+'?'+this.p.data:this.p.url},setHeaders:function(){this.xhr.setRequestHeader('X-Requested-With',this.p.headers['X-Requested-With']||'XMLHttpRequest');for(var a in this.p.headers){this.xhr.setRequestHeader(a,this.p.headers[a])}},isFormData:function(){return(typeof window.FormData!=='undefined'&&this.p.data instanceof window.FormData)},isComplete:function(){return!(this.xhr.status<200||this.xhr.status>=300&&this.xhr.status!==304)},send:function(){if(this.p.async){this.xhr.onload=this.loaded.bind(this);this.xhr.send(this.p.data)}else{this.xhr.send(this.p.data);this.loaded.call(this)}},loaded:function(){if(this.isComplete()){var a=this.xhr.response;var b=this.parseJson(a);a=(b)?b:a;if(typeof this.p.success==='function')this.p.success(a,this.xhr)}else{if(typeof this.p.error==='function')this.p.error(this.xhr.statusText)}},parseJson:function(a){try{var o=JSON.parse(a);if(o&&typeof o==='object'){return o}}catch(e){}return false},toParams:function(a){return Object.keys(a).map(function(k){return encodeURIComponent(k)+'='+encodeURIComponent(a[k])}).join('&')}};var B=[0];var C='data'+new Date();var D={};var E=function(a,b){return this.parse(a,b)};E.ready=function(a){if(document.readyState!='loading')a();else document.addEventListener('DOMContentLoaded',a)};E.prototype={get dom(){return true},get length(){return this.nodes.length},parse:function(a,b){var c;var d=/^\s*<(\w+|!)[^>]*>/;if(!a){c=[]}else if(a.dom){this.nodes=a.nodes;return a}else if(typeof a!=='string'){if(a.nodeType&&a.nodeType===11){c=a.childNodes}else{c=(a.nodeType||a===window)?[a]:a}}else if(d.test(a)){c=this.create(a)}else{c=this._query(a,b)}this.nodes=this._slice(c)},create:function(a){if(/^<(\w+)\s*\/?>(?:<\/\1>|)$/.test(a)){return[document.createElement(RegExp.$1)]}var b=[];var c=document.createElement('div');var d=c.childNodes;c.innerHTML=a;for(var i=0,l=d.length;i<l;i++){b.push(d[i])}return b},add:function(a){this.nodes=this.nodes.concat(this._toArray(a))},get:function(a){return this.nodes[(a||0)]||false},getAll:function(){return this.nodes},eq:function(a){return new E(this.nodes[a])},first:function(){return new E(this.nodes[0])},last:function(){return new E(this.nodes[this.nodes.length-1])},contents:function(){return this.get().childNodes},each:function(a){var b=this.nodes.length;for(var i=0;i<b;i++){a.call(this,(this.nodes[i].dom)?this.nodes[i].get():this.nodes[i],i)}return this},is:function(a){return(this.filter(a).length>0)},filter:function(b){var c;if(b===undefined){return this}else if(typeof b==='function'){c=b}else{c=function(a){if(b instanceof Node){return(b===a)}else if(b&&b.dom){return((b.nodes).indexOf(a)!==-1)}else{a.matches=a.matches||a.msMatchesSelector||a.webkitMatchesSelector;return(a.nodeType===1)?a.matches(b||'*'):false}}}return new E(this.nodes.filter(c))},not:function(b){return this.filter(function(a){return!new E(a).is(b||true)})},find:function(c){var d=[];this.each(function(a){var b=this._query(c||'*',a);for(var i=0;i<b.length;i++){d.push(b[i])}});return new E(d)},children:function(c){var d=[];this.each(function(a){if(a.children){var b=a.children;for(var i=0;i<b.length;i++){d.push(b[i])}}});return new E(d).filter(c)},parent:function(b){var c=[];this.each(function(a){if(a.parentNode)c.push(a.parentNode)});return new E(c).filter(b)},parents:function(c,d){d=this._getContext(d);var e=[];this.each(function(a){var b=a.parentNode;while(b&&b!==d){if(c){if(new E(b).is(c)){e.push(b)}}else{e.push(b)}b=b.parentNode}});return new E(e)},closest:function(b,c){c=this._getContext(c);b=(b.dom)?b.get():b;var d=[];var e=(b&&b.nodeType);this.each(function(a){do{if((e&&a===b)||new E(a).is(b))return d.push(a)}while((a=a.parentNode)&&a!==c)});return new E(d)},next:function(a){return this._getSibling(a,'nextSibling')},nextElement:function(a){return this._getSibling(a,'nextElementSibling')},prev:function(a){return this._getSibling(a,'previousSibling')},prevElement:function(a){return this._getSibling(a,'previousElementSibling')},css:function(d,e){if(e===undefined&&(typeof d!=='object')){var f=this.get();if(d==='width'||d==='height'){return(f.style)?this._getHeightOrWidth(d,f,false)+'px':undefined}else{return(f.style)?getComputedStyle(f,null)[d]:undefined}}return this.each(function(a){var b={};if(typeof d==='object')b=d;else b[d]=e;for(var c in b){if(a.style)a.style[c]=b[c]}})},attr:function(d,e,f){f=(f)?'data-':'';if(e===undefined&&(typeof d!=='object')){var g=this.get();if(g&&g.nodeType!==3){return(d==='checked')?g.checked:this._getBooleanFromStr(g.getAttribute(f+d))}else return}return this.each(function(a){var b={};if(typeof d==='object')b=d;else b[d]=e;for(var c in b){if(a.nodeType!==3){if(c==='checked')a.checked=b[c];else a.setAttribute(f+c,b[c])}}})},data:function(a,b){if(a===undefined){var c=/^data\-(.+)$/;var d=this.get().attributes;var e={};var f=function(g){return g[1].toUpperCase()};for(var h in d){if(c.test(d[h].nodeName)){var i=d[h].nodeName.match(c)[1];var j=d[h].value;i=i.replace(/-([a-z])/g,f);if(this._isObjectString(j))j=this._toObject(j);else j=(this._isNumber(j))?parseFloat(j):this._getBooleanFromStr(j);e[i]=j}}return e}return this.attr(a,b,true)},val:function(b){if(b===undefined){var c=this.get();if(c.type&&c.type==='checkbox')return c.checked;else return c.value}return this.each(function(a){a.value=b})},removeAttr:function(d){return this.each(function(b){var c=function(a){if(b.nodeType!==3)b.removeAttribute(a)};d.split(' ').forEach(c)})},removeData:function(d){return this.each(function(b){var c=function(a){if(b.nodeType!==3)b.removeAttribute('data-'+a)};d.split(' ').forEach(c)})},dataset:function(b,c){return this.each(function(a){B[this.dataindex(a)][b]=c})},dataget:function(a){return B[this.dataindex(this.get())][a]},dataindex:function(a){var b=a[C];var c=B.length;if(!b){b=a[C]=c;B[b]={}}return b},addClass:function(a){return this._eachClass(a,'add')},removeClass:function(a){return this._eachClass(a,'remove')},toggleClass:function(a){return this._eachClass(a,'toggle')},hasClass:function(b){return this.nodes.some(function(a){return(a.classList)?a.classList.contains(b):false})},empty:function(){return this.each(function(a){a.innerHTML=''})},html:function(a){return(a===undefined)?(this.get().innerHTML||''):this.empty().append(a)},text:function(b){return(b===undefined)?(this.get().textContent||''):this.each(function(a){a.textContent=b})},after:function(d){return this._inject(d,function(a,b){if(typeof a==='string'){b.insertAdjacentHTML('afterend',a)}else{var c=(a instanceof Node)?[a]:this._toArray(a).reverse();for(var i=0;i<c.length;i++){b.parentNode.insertBefore(c[i],b.nextSibling)}}return b})},before:function(d){return this._inject(d,function(a,b){if(typeof a==='string'){b.insertAdjacentHTML('beforebegin',a)}else{var c=(a instanceof Node)?[a]:this._toArray(a);for(var i=0;i<c.length;i++){b.parentNode.insertBefore(c[i],b)}}return b})},append:function(d){return this._inject(d,function(a,b){if(typeof a==='string'||typeof a==='number'){b.insertAdjacentHTML('beforeend',a)}else{var c=(a instanceof Node)?[a]:this._toArray(a);for(var i=0;i<c.length;i++){b.appendChild(c[i])}}return b})},prepend:function(d){return this._inject(d,function(a,b){if(typeof a==='string'||typeof a==='number'){b.insertAdjacentHTML('afterbegin',a)}else{var c=(a instanceof Node)?[a]:this._toArray(a).reverse();for(var i=0;i<c.length;i++){b.insertBefore(c[i],b.firstChild)}}return b})},wrap:function(d){return this._inject(d,function(a,b){var c=(typeof a==='string'||typeof a==='number')?this.create(a)[0]:(a instanceof Node)?a:this._toArray(a)[0];if(b.parentNode){b.parentNode.insertBefore(c,b)}c.appendChild(b);return new E(c)})},unwrap:function(){return this.each(function(a){var b=new E(a);return b.replaceWith(b.contents())})},replaceWith:function(f){return this._inject(f,function(a,b){var c=document.createDocumentFragment();var d=(typeof a==='string'||typeof a==='number')?this.create(a):(a instanceof Node)?[a]:this._toArray(a);for(var i=0;i<d.length;i++){c.appendChild(d[i])}var e=c.childNodes[0];b.parentNode.replaceChild(c,b);return e})},remove:function(){return this.each(function(a){if(a.parentNode)a.parentNode.removeChild(a)})},clone:function(c){var d=[];this.each(function(a){var b=this._clone(a);if(c)b=this._cloneEvents(a,b);d.push(b)});return new E(d)},show:function(){return this.each(function(a){if(a.style){if(this._getRealDisplay(a)!=='none')return;var b=a.getAttribute('displayOld');a.style.display=b||'';if(this._getRealDisplay(a)==='none'){var c=a.nodeName,body=document.body,display;if(D[c]){display=D[c]}else{var d=document.createElement(c);body.appendChild(d);display=this._getRealDisplay(d);if(display==='none')display='block';body.removeChild(d);D[c]=display}a.setAttribute('displayOld',display);a.style.display=display}}}.bind(this))},hide:function(){return this.each(function(a){if(a.style){if(!a.getAttribute('displayOld')&&a.style.display!==''){a.setAttribute("displayOld",a.style.display)}a.style.display='none'}})},scrollTop:function(a){var b=this.get();var c=(b===window);var d=(b.nodeType===9);var e=(d)?(document.scrollingElement||document.body.parentNode||document.body||document.documentElement):b;if(a!==undefined){if(c)window.scrollTo(0,a);else e.scrollTop=a;return}if(d){return(typeof window.pageYOffset!='undefined')?window.pageYOffset:((document.documentElement.scrollTop)?document.documentElement.scrollTop:((document.body.scrollTop)?document.body.scrollTop:0))}else{return(c)?window.pageYOffset:e.scrollTop}},offset:function(){return this._getDim('Offset')},position:function(){return this._getDim('Position')},width:function(a,b){return this._getSize('width','Width',a,b)},height:function(a,b){return this._getSize('height','Height',a,b)},outerWidth:function(){return this._getInnerOrOuter('width','outer')},outerHeight:function(){return this._getInnerOrOuter('height','outer')},innerWidth:function(){return this._getInnerOrOuter('width','inner')},innerHeight:function(){return this._getInnerOrOuter('height','inner')},click:function(){return this._triggerEvent('click')},focus:function(){return this._triggerEvent('focus')},trigger:function(f){return this.each(function(a){var b=f.split(' ');for(var i=0;i<b.length;i++){var c;var d={bubbles:true,cancelable:true};try{c=new window.CustomEvent(b[i],d)}catch(e){c=document.createEvent('CustomEvent');c.initCustomEvent(b[i],true,true)}a.dispatchEvent(c)}})},on:function(e,f,g){return this.each(function(a){var b=e.split(' ');for(var i=0;i<b.length;i++){var c=this._getEventName(b[i]);var d=this._getEventNamespace(b[i]);f=(g)?this._getOneHandler(f,e):f;a.addEventListener(c,f);a._e=a._e||{};a._e[d]=a._e[d]||{};a._e[d][c]=a._e[d][c]||[];a._e[d][c].push(f)}})},one:function(a,b){return this.on(a,b,true)},off:function(e,f){var g=function(a,b,c){return(a===c)};var h=function(a,b,c,d){return(b===d)};var j=function(a,b,c,d){return(a===c&&b===d)};var k=function(){return true};if(e===undefined){return this.each(function(a){this._offEvent(a,false,false,f,k)})}return this.each(function(a){var b=e.split(' ');for(var i=0;i<b.length;i++){var c=this._getEventName(b[i]);var d=this._getEventNamespace(b[i]);if(d==='_events')this._offEvent(a,c,d,f,g);else if(!c&&d!=='_events')this._offEvent(a,c,d,f,h);else this._offEvent(a,c,d,f,j)}})},serialize:function(a){var b={};var c=this.get().elements;for(var i=0;i<c.length;i++){var d=c[i];if(/(checkbox|radio)/.test(d.type)&&!d.checked)continue;if(!d.name||d.disabled||d.type==='file')continue;if(d.type==='select-multiple'){for(var z=0;z<d.options.length;z++){var e=d.options[z];if(e.selected)b[d.name]=e.value}}b[d.name]=d.value}return(a)?b:this._toParams(b)},ajax:function(a,b){if(typeof A!=='undefined'){var c=this.attr('method')||'post';var d={url:this.attr('action'),data:this.serialize(),success:a,error:b};return new A(c,d)}},_queryContext:function(a,b){b=this._getContext(b);return(b.nodeType!==3&&typeof b.querySelectorAll==='function')?b.querySelectorAll(a):[]},_query:function(a,b){if(b){return this._queryContext(a,b)}else if(/^[.#]?[\w-]*$/.test(a)){if(a[0]==='#'){var c=document.getElementById(a.slice(1));return c?[c]:[]}if(a[0]==='.'){return document.getElementsByClassName(a.slice(1))}return document.getElementsByTagName(a)}return document.querySelectorAll(a)},_getContext:function(a){a=(typeof a==='string')?document.querySelector(a):a;return(a&&a.dom)?a.get():(a||document)},_inject:function(a,b){var c=this.nodes.length;var d=[];while(c--){var e=(typeof a==='function')?a.call(this,this.nodes[c]):a;var f=(c===0)?e:this._clone(e);var g=b.call(this,f,this.nodes[c]);if(g){if(g.dom)d.push(g.get());else d.push(g)}}return new E(d)},_cloneEvents:function(a,b){var c=a._e;if(c){b._e=c;for(var d in c._events){for(var i=0;i<c._events[d].length;i++){b.addEventListener(d,c._events[d][i])}}}return b},_clone:function(b){if(typeof b==='undefined')return;if(typeof b==='string')return b;else if(b instanceof Node)return b.cloneNode(true);else if('length'in b){return[].map.call(this._toArray(b),function(a){return a.cloneNode(true)})}return b},_slice:function(a){return(!a||a.length===0)?[]:(a.length)?[].slice.call(a.nodes||a):[a]},_eachClass:function(d,e){return this.each(function(b){if(d){var c=function(a){if(b.classList)b.classList[e](a)};d.split(' ').forEach(c)}})},_triggerEvent:function(a){var b=this.get();if(b&&b.nodeType!==3)b[a]();return this},_getOneHandler:function(a,b){var c=this;return function(){a.apply(this,arguments);c.off(b)}},_getEventNamespace:function(a){var b=a.split('.');var c=(b[1])?b[1]:'_events';return(b[2])?c+b[2]:c},_getEventName:function(a){return a.split('.')[0]},_offEvent:function(a,b,c,d,e){for(var f in a._e){for(var g in a._e[f]){if(e(g,f,b,c)){var h=a._e[f][g];for(var i=0;i<h.length;i++){if(typeof d!=='undefined'&&h[i].toString()!==d.toString()){continue}a.removeEventListener(g,h[i]);a._e[f][g].splice(i,1);if(a._e[f][g].length===0)delete a._e[f][g];if(Object.keys(a._e[f]).length===0)delete a._e[f]}}}}},_getInnerOrOuter:function(a,b){return this[a](undefined,b)},_getDocSize:function(a,b){var c=a.body,html=a.documentElement;return Math.max(c['scroll'+b],c['offset'+b],html['client'+b],html['scroll'+b],html['offset'+b])},_getSize:function(b,c,d,e){if(d===undefined){var f=this.get();if(f.nodeType===3)d=0;else if(f.nodeType===9)d=this._getDocSize(f,c);else if(f===window)d=window['inner'+c];else d=this._getHeightOrWidth(b,f,e||'normal');return Math.round(d)}return this.each(function(a){d=parseFloat(d);d=d+this._adjustResultHeightOrWidth(b,a,e||'normal');new E(a).css(b,d+'px')}.bind(this))},_getHeightOrWidth:function(d,e,f){var g=d.charAt(0).toUpperCase()+d.slice(1);var h=getComputedStyle(e,null);var j=new E(e);var k=0;var l=j.parents().filter(function(a){return(getComputedStyle(a,null).display==='none')?a:false});if(h.display==='none')l.add(e);if(l.length!==0){var m='visibility: hidden !important; display: block !important;';var n=[];l.each(function(a){var b=new E(a);var c=b.attr('style');if(c!==null)n.push(c);b.attr('style',(c!==null)?c+';'+m:m)});k=j.get()['offset'+g]-this._adjustResultHeightOrWidth(d,e,f);l.each(function(a,i){var b=new E(a);if(n[i]===undefined)b.removeAttr('style');else b.attr('style',n[i])})}else{k=e['offset'+g]-this._adjustResultHeightOrWidth(d,e,f)}return k},_adjustResultHeightOrWidth:function(a,b,c){if(!b||c===false)return 0;var d=0;var e=getComputedStyle(b,null);var f=(e.boxSizing==="border-box");if(a==='height'){if(c==='inner'||(c==='normal'&&f)){d+=(parseFloat(e.borderTopWidth)||0)+(parseFloat(e.borderBottomWidth)||0)}if(c==='outer')d-=(parseFloat(e.marginTop)||0)+(parseFloat(e.marginBottom)||0)}else{if(c==='inner'||(c==='normal'&&f)){d+=(parseFloat(e.borderLeftWidth)||0)+(parseFloat(e.borderRightWidth)||0)}if(c==='outer')d-=(parseFloat(e.marginLeft)||0)+(parseFloat(e.marginRight)||0)}return d},_getDim:function(a){var b=this.get();return(b.nodeType===3)?{top:0,left:0}:this['_get'+a](b)},_getPosition:function(a){return{top:a.offsetTop,left:a.offsetLeft}},_getOffset:function(a){var b=a.getBoundingClientRect();var c=a.ownerDocument;var d=c.documentElement;var e=c.defaultView;return{top:b.top+e.pageYOffset-d.clientTop,left:b.left+e.pageXOffset-d.clientLeft}},_getSibling:function(b,c){b=(b&&b.dom)?b.get():b;var d=(b&&b.nodeType);var e;this.each(function(a){while(a=a[c]){if((d&&a===b)||new E(a).is(b)){e=a;return}}});return new E(e)},_toArray:function(a){if(a instanceof NodeList){var b=[];for(var i=0;i<a.length;i++){b[i]=a[i]}return b}else if(a===undefined)return[];else{return(a.dom)?a.nodes:a}},_toParams:function(a){var b='';for(var c in a){b+='&'+this._encodeUri(c)+'='+this._encodeUri(a[c])}return b.replace(/^&/,'')},_toObject:function(a){return(new Function("return "+a))()},_encodeUri:function(a){return encodeURIComponent(a).replace(/!/g,'%21').replace(/'/g,'%27').replace(/\(/g,'%28').replace(/\)/g,'%29').replace(/\*/g,'%2A').replace(/%20/g,'+')},_isNumber:function(a){return!isNaN(a)&&!isNaN(parseFloat(a))},_isObjectString:function(a){return(a.search(/^{/)!==-1)},_getBooleanFromStr:function(a){if(a==='true')return true;else if(a==='false')return false;return a},_getRealDisplay:function(a){if(a.currentStyle)return a.currentStyle.display;else if(window.getComputedStyle){var b=window.getComputedStyle(a,null);return b.getPropertyValue('display')}}};var G=0;var H=function(a,b){return I(a,b,[].slice.call(arguments,2))};H.version='3.1.1';H.options={};H.modules={};H.services={};H.classes={};H.plugins={};H.mixins={};H.modals={};H.lang={};H.dom=function(a,b){return new E(a,b)};H.ajax=w;H.Dom=E;H.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37};H.env={'plugin':'plugins','module':'modules','service':'services','class':'classes','mixin':'mixins'};if(typeof jQuery!=='undefined'){(function($){$.fn.redactor=function(a){return I(this.toArray(),a,[].slice.call(arguments,1))}})(jQuery)}var I=function(a,b,c){var d='redactor';var e=(Array.isArray(a))?a:(a&&a.nodeType)?[a]:document.querySelectorAll(a);var f=(typeof b==='string'||typeof b==='function');var g=[];var h;for(var i=0;i<e.length;i++){var j=e[i];var k=H.dom(j);h=k.dataget(d);if(!h&&!f){k.dataset(d,(h=new J(j,b,G)));G++}if(h&&f){var l=(b==='destroy');b=(l)?'stop':b;var m;if(typeof b==='function'){m=b.apply(h,c)}else{c.unshift(b);m=h.api.apply(h,c)}if(m!==undefined)g.push(m);if(l)k.dataset(d,false)}}return(g.length===0||g.length===1)?((g.length===0)?h:g[0]):g};H.add=function(a,b,c){if(typeof H.env[a]==='undefined')return;if(c.translations){H.lang=H.extend(true,{},H.lang,c.translations)}if(c.modals){H.modals=H.extend(true,{},H.modals,c.modals)}if(a==='mixin'){H[H.env[a]][b]=c}else{var F=function(){};F.prototype=c;if(c.mixins){for(var i=0;i<c.mixins.length;i++){H.inherit(F,H.mixins[c.mixins[i]])}}H[H.env[a]][b]=F}};H.addLang=function(a,b){if(typeof H.lang[a]==='undefined'){H.lang[a]={}}H.lang[a]=H.extend(H.lang[a],b)};H.create=function(a){var b=a.split('.');var c=[].slice.call(arguments,1);var d='classes';if(typeof H.env[b[0]]!=='undefined'){d=H.env[b[0]];a=b.slice(1).join('.')}var e=new H[d][a]();if(e.init){var f=e.init.apply(e,c);return(f)?f:e}return e};H.inherit=function(a,b){var F=function(){};F.prototype=b;var f=new F();for(var c in a.prototype){if(a.prototype.__lookupGetter__(c))f.__defineGetter__(c,a.prototype.__lookupGetter__(c));else f[c]=a.prototype[c]}a.prototype=f;a.prototype.super=b;return a};H.error=function(a){throw a;};H.extend=function(){var c={};var d=false;var i=0;var e=arguments.length;if(Object.prototype.toString.call(arguments[0])==='[object Boolean]'){d=arguments[0];i++}var f=function(a){for(var b in a){if(Object.prototype.hasOwnProperty.call(a,b)){if(d&&Object.prototype.toString.call(a[b])==='[object Object]')c[b]=H.extend(true,c[b],a[b]);else c[b]=a[b]}}};for(;i<e;i++){var g=arguments[i];f(g)}return c};H.opts={animation:true,lang:'en',direction:'ltr',spellcheck:true,structure:false,scrollTarget:false,styles:true,stylesClass:'redactor-styles',placeholder:false,source:true,showSource:false,inline:false,breakline:false,markup:'p',enterKey:true,clickToEdit:false,clickToSave:false,clickToCancel:false,focus:false,focusEnd:false,minHeight:false,maxHeight:false,maxWidth:false,plugins:[],callbacks:{},preClass:false,preSpaces:4,tabindex:false,tabAsSpaces:false,tabKey:true,autosave:false,autosaveName:false,autosaveData:false,toolbar:true,toolbarFixed:true,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarExternal:false,toolbarContext:true,air:false,formatting:['p','blockquote','pre','h1','h2','h3','h4','h5','h6'],formattingAdd:false,formattingHide:false,buttons:['html','format','bold','italic','deleted','lists','image','file','link'],buttonsTextLabeled:false,buttonsAdd:[],buttonsAddFirst:[],buttonsAddAfter:false,buttonsAddBefore:false,buttonsHide:[],buttonsHideOnMobile:[],imageUpload:false,imageUploadParam:'file',imageData:false,imageEditable:true,imageCaption:true,imagePosition:false,imageResizable:false,imageFloatMargin:'10px',imageFigure:true,fileUpload:false,fileUploadParam:'file',fileData:false,fileAttachment:false,uploadData:false,dragUpload:true,multipleUpload:true,clipboardUpload:true,uploadBase64:false,linkTarget:false,linkTitle:false,linkNewTab:false,linkNofollow:false,linkSize:30,linkValidation:true,cleanOnEnter:true,cleanInlineOnEnter:false,paragraphize:true,removeScript:true,removeNewLines:false,removeComments:true,replaceTags:{'b':'strong','strike':'del'},pastePlainText:false,pasteLinkTarget:false,pasteImages:true,pasteLinks:true,pasteClean:true,pasteKeepStyle:[],pasteKeepClass:[],pasteKeepAttrs:['td','th'],pasteBlockTags:['pre','h1','h2','h3','h4','h5','h6','table','tbody','thead','tfoot','th','tr','td','ul','ol','li','blockquote','p','figure','figcaption'],pasteInlineTags:['a','img','br','strong','ins','code','del','span','samp','kbd','sup','sub','mark','var','cite','small','b','u','em','i','abbr'],activeButtons:{b:'bold',strong:'bold',i:'italic',em:'italic',del:'deleted',strike:'deleted',u:'underline'},activeButtonsAdd:{},activeButtonsObservers:{},autoparse:true,autoparseStart:true,autoparsePaste:true,autoparseLinks:true,autoparseImages:true,autoparseVideo:true,shortcodes:{'p.':{format:'p'},'quote.':{format:'blockquote'},'pre.':{format:'pre'},'h1.':{format:'h1'},'h2.':{format:'h2'},'h3.':{format:'h3'},'h4.':{format:'h4'},'h5.':{format:'h5'},'h6.':{format:'h6'},'1.':{format:'ol'},'*.':{format:'ul'}},shortcodesAdd:false,shortcuts:{'ctrl+shift+m, meta+shift+m':{api:'module.inline.clearformat'},'ctrl+b, meta+b':{api:'module.inline.format',args:'b'},'ctrl+i, meta+i':{api:'module.inline.format',args:'i'},'ctrl+u, meta+u':{api:'module.inline.format',args:'u'},'ctrl+h, meta+h':{api:'module.inline.format',args:'sup'},'ctrl+l, meta+l':{api:'module.inline.format',args:'sub'},'ctrl+k, meta+k':{api:'module.link.open'},'ctrl+alt+0, meta+alt+0':{api:'module.block.format',args:'p'},'ctrl+alt+1, meta+alt+1':{api:'module.block.format',args:'h1'},'ctrl+alt+2, meta+alt+2':{api:'module.block.format',args:'h2'},'ctrl+alt+3, meta+alt+3':{api:'module.block.format',args:'h3'},'ctrl+alt+4, meta+alt+4':{api:'module.block.format',args:'h4'},'ctrl+alt+5, meta+alt+5':{api:'module.block.format',args:'h5'},'ctrl+alt+6, meta+alt+6':{api:'module.block.format',args:'h6'},'ctrl+shift+7, meta+shift+7':{api:'module.list.toggle',args:'ol'},'ctrl+shift+8, meta+shift+8':{api:'module.list.toggle',args:'ul'}},shortcutsAdd:false,grammarly:true,bufferLimit:100,emptyHtml:'<p></p>',markerChar:'\ufeff',imageTypes:['image/png','image/jpeg','image/gif'],inlineTags:['a','span','strong','strike','b','u','em','i','code','del','ins','samp','kbd','sup','sub','mark','var','cite','small','abbr'],blockTags:['pre','ul','ol','li','p','h1','h2','h3','h4','h5','h6','dl','dt','dd','div','table','tbody','thead','tfoot','tr','th','td','blockquote','output','figcaption','figure','address','section','header','footer','aside','article','iframe'],regex:{youtube:/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w\-\s])([\w\-]{11})(?=[^\w\-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/gi,vimeo:/(http|https)?:\/\/(?:www.|player.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^\/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:[a-zA-Z0-9_-]+)?/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,url:/(https?:\/\/(?:www\.|(?!www))[^\s\.]+\.[^\s]{2,}|www\.[^\s]+\.[^\s]{2,})/gi},input:true,zindex:false,modes:{"inline":{pastePlainText:true,pasteImages:false,enterKey:false,toolbar:false,autoparse:false,source:false,showSource:false,styles:false,air:false},"original":{styles:false}}};H.lang['en']={"format":"Format","image":"Image","file":"File","link":"Link","bold":"Bold","italic":"Italic","deleted":"Strikethrough","underline":"Underline","superscript":"Superscript","subscript":"Subscript","bold-abbr":"B","italic-abbr":"I","deleted-abbr":"S","underline-abbr":"U","superscript-abbr":"Sup","subscript-abbr":"Sub","lists":"Lists","link-insert":"Insert Link","link-edit":"Edit Link","link-in-new-tab":"Open link in new tab","unlink":"Unlink","cancel":"Cancel","close":"Close","insert":"Insert","save":"Save","delete":"Delete","text":"Text","edit":"Edit","title":"Title","paragraph":"Normal text","quote":"Quote","code":"Code","heading1":"Heading 1","heading2":"Heading 2","heading3":"Heading 3","heading4":"Heading 4","heading5":"Heading 5","heading6":"Heading 6","filename":"Name","optional":"optional","unorderedlist":"Unordered List","orderedlist":"Ordered List","outdent":"Outdent","indent":"Indent","horizontalrule":"Line","upload":"Upload","upload-label":"Drop files here or click to upload","accessibility-help-label":"Rich text editor","caption":"Caption","bulletslist":"Bullets","numberslist":"Numbers","image-position":"Position","none":"None","left":"Left","right":"Right","center":"Center","undo":"Undo","redo":"Redo"};H.buttons={html:{title:'HTML',icon:true,api:'module.source.toggle'},undo:{title:'## undo ##',icon:true,api:'module.buffer.undo'},redo:{title:'## redo ##',icon:true,api:'module.buffer.redo'},format:{title:'## format ##',icon:true,dropdown:{p:{title:'## paragraph ##',api:'module.block.format',args:{tag:'p'}},blockquote:{title:'## quote ##',api:'module.block.format',args:{tag:'blockquote'}},pre:{title:'## code ##',api:'module.block.format',args:{tag:'pre'}},h1:{title:'## heading1 ##',api:'module.block.format',args:{tag:'h1'}},h2:{title:'## heading2 ##',api:'module.block.format',args:{tag:'h2'}},h3:{title:'## heading3 ##',api:'module.block.format',args:{tag:'h3'}},h4:{title:'## heading4 ##',api:'module.block.format',args:{tag:'h4'}},h5:{title:'## heading5 ##',api:'module.block.format',args:{tag:'h5'}},h6:{title:'## heading6 ##',api:'module.block.format',args:{tag:'h6'}}}},bold:{title:'## bold-abbr ##',icon:true,tooltip:'## bold ##',api:'module.inline.format',args:{tag:'b'}},italic:{title:'## italic-abbr ##',icon:true,tooltip:'## italic ##',api:'module.inline.format',args:{tag:'i'}},deleted:{title:'## deleted-abbr ##',icon:true,tooltip:'## deleted ##',api:'module.inline.format',args:{tag:'del'}},underline:{title:'## underline-abbr ##',icon:true,tooltip:'## underline ##',api:'module.inline.format',args:{tag:'u'}},sup:{title:'## superscript-abbr ##',icon:true,tooltip:'## superscript ##',api:'module.inline.format',args:{tag:'sup'}},sub:{title:'## subscript-abbr ##',icon:true,tooltip:'## subscript ##',api:'module.inline.format',args:{tag:'sub'}},lists:{title:'## lists ##',icon:true,observe:'list',dropdown:{observe:'list',unorderedlist:{title:'&bull; ## unorderedlist ##',api:'module.list.toggle',args:'ul'},orderedlist:{title:'1. ## orderedlist ##',api:'module.list.toggle',args:'ol'},outdent:{title:'< ## outdent ##',api:'module.list.outdent'},indent:{title:'> ## indent ##',api:'module.list.indent'}}},ul:{title:'&bull; ## bulletslist ##',icon:true,api:'module.list.toggle',observe:'list',args:'ul'},ol:{title:'1. ## numberslist ##',icon:true,api:'module.list.toggle',observe:'list',args:'ol'},outdent:{title:'## outdent ##',icon:true,api:'module.list.outdent',observe:'list'},indent:{title:'## indent ##',icon:true,api:'module.list.indent',observe:'list'},image:{title:'## image ##',icon:true,api:'module.image.open'},file:{title:'## file ##',icon:true,api:'module.file.open'},link:{title:'## link ##',icon:true,observe:'link',dropdown:{observe:'link',link:{title:'## link-insert ##',api:'module.link.open'},unlink:{title:'## unlink ##',api:'module.link.unlink'}}},line:{title:'## horizontalrule ##',icon:true,api:'module.line.insert'}};var J=function(a,b,c){this.module={};this.plugin={};this.instances={};this.started=false;this.stopped=false;this.uuid=c;this.rootElement=a;this.rootOpts=b;this.dragInside=false;this.dragComponentInside=false;this.keycodes=H.keycodes;this.namespace='redactor';this.$win=H.dom(window);this.$doc=H.dom(document);this.$body=H.dom('body');this.editorReadOnly=false;this.opts=H.create('service.options',b,a);this.lang=H.create('service.lang',this);this.buildServices();this.buildModules();this.buildPlugins();this.start()};J.prototype={start:function(){this.stopped=false;this.broadcast('start');this.broadcast('startcode');if(this.opts.clickToEdit){this.broadcast('startclicktoedit')}else{this.broadcast('enable');if(this.opts.showSource)this.broadcast('startcodeshow');this.broadcast('enablefocus')}this.broadcast('started');this.started=true},stop:function(){this.started=false;this.stopped=true;this.broadcast('stop');this.broadcast('disable');this.broadcast('stopped')},isStarted:function(){return this.started},isStopped:function(){return this.stopped},buildServices:function(){var a=['options','lang'];var b=['uuid','keycodes','opts','lang','$win','$doc','$body'];var c=[];for(var d in H.services){if(a.indexOf(d)===-1){this[d]=H.create('service.'+d,this);c.push(d);b.push(d)}}for(var i=0;i<c.length;i++){var e=c[i];for(var z=0;z<b.length;z++){var f=b[z];if(e!==f){this[e][f]=this[f]}}}},buildModules:function(){for(var a in H.modules){this.module[a]=H.create('module.'+a,this);this.instances[a]=this.module[a]}},buildPlugins:function(){var a=this.opts.plugins;for(var i=0;i<a.length;i++){var b=a[i];if(typeof H.plugins[b]!=='undefined'){this.plugin[b]=H.create('plugin.'+b,this);this.instances[b]=this.plugin[b]}}},isDragInside:function(){return this.dragInside},setDragInside:function(a){this.dragInside=a},isDragComponentInside:function(){return this.dragComponentInside},setDragComponentInside:function(a){this.dragComponentInside=a},getDragComponentInside:function(){return this.dragComponentInside},isReadOnly:function(){return this.editorReadOnly},enableReadOnly:function(){this.editorReadOnly=true;this.broadcast('enablereadonly');this.component.clearActive();this.toolbar.disableButtons()},disableReadOnly:function(){this.editorReadOnly=false;this.broadcast('disablereadonly');this.toolbar.enableButtons()},callMessageHandler:function(a,b,c){var d=b.split('.');if(d.length===1){if(typeof a['on'+b]==='function'){a['on'+b].apply(a,c)}}else{d[0]='on'+d[0];var e=this.utils.checkProperty(a,d);if(typeof e==='function'){e.apply(a,c)}}},broadcast:function(a){var b=[].slice.call(arguments,1);for(var c in this.instances){this.callMessageHandler(this.instances[c],a,b)}return this.callback.trigger(a,b)},on:function(a,b){this.callback.add(a,b)},off:function(a,b){this.callback.remove(a,b)},api:function(a){if(!this.isStarted()&&a!=='start')return;if(this.isReadOnly()&&a!=='disableReadOnly')return;this.broadcast('state');var b=[].slice.call(arguments,1);var c=a.split('.');var d=(c.length===1);var e=(c[0]==='on'||c[0]==='off');var f=(!e&&c.length===2);var g=(c[0]==='plugin');var h=(c[0]==='module');if(d){if(typeof this[c[0]]==='function'){return this.callInstanceMethod(this,c[0],b)}}else if(e){return(c[0]==='on')?this.on(c[1],b[0]):this.off(c[1],b[0]||undefined)}else if(f){if(this.isInstanceExists(this,c[0])){return this.callInstanceMethod(this[c[0]],c[1],b)}else{H.error(new Error('Service "'+c[0]+'" not found'))}}else if(g){if(this.isInstanceExists(this.plugin,c[1])){return this.callInstanceMethod(this.plugin[c[1]],c[2],b)}else{H.error(new Error('Plugin "'+c[1]+'" not found'))}}else if(h){if(this.isInstanceExists(this.module,c[1])){return this.callInstanceMethod(this.module[c[1]],c[2],b)}else{H.error(new Error('Module "'+c[1]+'" not found'))}}},isInstanceExists:function(a,b){return(typeof a[b]!=='undefined')},callInstanceMethod:function(a,b,c){if(typeof a[b]==='function'){return a[b].apply(a,c)}}};H.add('mixin','formatter',{buildArgs:function(a){this.args={'class':a['class']||false,'style':a['style']||false,'attr':a['attr']||false};if(!this.args['class']&&!this.args['style']&&!this.args['attr']){this.args=false}},applyArgs:function(a,b){if(this.args){a=this[this.type](this.args,false,a,b)}else{a=this._clearAll(a,b)}return a},clearClass:function(a,b){this.selection.save();var c=(b)?H.dom(b):this.getElements(a,true);c.removeAttr('class');b=this._unwrapSpanWithoutAttr(c.getAll());this.selection.restore();return b},clearStyle:function(a,b){this.selection.save();var c=(b)?H.dom(b):this.getElements(a,true);c.removeAttr('style');b=this._unwrapSpanWithoutAttr(c.getAll());this.selection.restore();return b},clearAttr:function(a,b){this.selection.save();var c=(b)?H.dom(b):this.getElements(a,true);this._removeAllAttr(c);b=this._unwrapSpanWithoutAttr(c.getAll());this.selection.restore();return b},set:function(c,d,e,f){if(f!==false)this.selection.save();var g=(e)?H.dom(e):this.getElements(d);if(c['class']){g.removeAttr('class');g.addClass(c['class'])}if(c['style']){g.removeAttr('style');g.css(c['style']);g.each(function(a){var b=H.dom(a);b.attr('data-redactor-style-cache',b.attr('style'))})}if(c['attr']){this._removeAllAttr(g);g.attr(c['attr'])}if(f!==false)this.selection.restore();return g.getAll()},toggle:function(h,i,j,k){if(k!==false)this.selection.save();var l=(j)?H.dom(j):this.getElements(i);if(h['class']){l.toggleClass(h['class']);l.each(function(a){if(a.className==='')a.removeAttribute('class')})}var m;if(h['style']){m=h['style'];l.each(function(a){var b=H.dom(a);for(var c in m){var d=m[c];var e=b.css(c);e=(this.utils.isRgb(e))?this.utils.rgb2hex(e):e.replace(/"/g,'');d=(this.utils.isRgb(d))?this.utils.rgb2hex(d):d.replace(/"/g,'');e=this.utils.hex2long(e);d=this.utils.hex2long(d);var f=(typeof d==='string')?d.toLowerCase():d;var g=(typeof e==='string')?e.toLowerCase():e;if(f===g)b.css(c,'');else b.css(c,d)}this._convertStyleQuotes(b);if(this.utils.removeEmptyAttr(a,'style')){b.removeAttr('data-redactor-style-cache')}else{b.attr('data-redactor-style-cache',b.attr('style'))}}.bind(this))}if(h['attr']){m=h['attr'];l.each(function(a){var b=H.dom(a);for(var c in m){if(b.attr(c))b.removeAttr(c);else b.attr(c,m[c])}})}if(k!==false)this.selection.restore();return l.getAll()},add:function(c,d,e,f){if(f!==false)this.selection.save();var g=(e)?H.dom(e):this.getElements(d);if(c['class']){g.addClass(c['class'])}if(c['style']){var h=c['style'];g.each(function(a){var b=H.dom(a);b.css(h);b.attr('data-redactor-style-cache',b.attr('style'));this._convertStyleQuotes(b)}.bind(this))}if(c['attr']){g.attr(c['attr'])}if(f!==false)this.selection.restore();return g.getAll()},remove:function(c,d,e,f){if(f!==false)this.selection.save();var g=(e)?H.dom(e):this.getElements(d);if(c['class']){g.removeClass(c['class']);g.each(function(a){if(a.className==='')a.removeAttribute('class')})}if(c['style']){var h=c['style'];g.each(function(a){var b=H.dom(a);b.css(h,'');if(this.utils.removeEmptyAttr(a,'style')){b.removeAttr('data-redactor-style-cache')}else{b.attr('data-redactor-style-cache',b.attr('style'))}}.bind(this))}if(c['attr']){g.removeAttr(c['attr'])}e=this._unwrapSpanWithoutAttr(g.getAll());if(f!==false)this.selection.restore();return e},_removeAllAttr:function(d){d.each(function(a){for(var i=a.attributes.length;i-->0;){var b=a.attributes[i];var c=b.name;if(c!=='style'&&c!=='class'){a.removeAttributeNode(b)}}})},_convertStyleQuotes:function(a){var b=a.attr('style');if(b)a.attr('style',b.replace(/"/g,'\''))},_clearAll:function(a,b){if(b!==false)this.selection.save();for(var i=0;i<a.length;i++){var c=a[i];while(c.attributes.length>0){c.removeAttribute(c.attributes[0].name)}}a=this._unwrapSpanWithoutAttr(a);if(b!==false)this.selection.restore();return a},_unwrapSpanWithoutAttr:function(a){var b=[];for(var i=0;i<a.length;i++){var c=a[i];var d=c.attributes.length;if(d<=0&&c.nodeType!==3&&c.tagName==='SPAN'){H.dom(c).unwrap()}else{b.push(c)}}return b}});H.add('mixin','dom',H.Dom.prototype);H.add('mixin','component',{get cmnt(){return true}});H.add('service','options',{init:function(a,b){var c=H.dom(b);var d=H.extend({},H.opts,(b)?c.data():{},H.options);d=H.extend(true,d,a);return d}});H.add('service','lang',{init:function(a){this.app=a;this.opts=a.opts;this.vars=this._build(this.opts.lang)},rebuild:function(a){this.opts.lang=a;this.vars=this._build(a)},extend:function(a){this.vars=H.extend(this.vars,a)},parse:function(a){if(a===undefined){return''}var b=a.match(/## (.*?) ##/g);if(b){for(var i=0;i<b.length;i++){var c=b[i].replace(/^##\s/g,'').replace(/\s##$/g,'');a=a.replace(b[i],this.get(c))}}return a},get:function(a){var b='';if(typeof this.vars[a]!=='undefined'){b=this.vars[a]}else if(this.opts.lang!=='en'&&typeof H.lang['en'][a]!=='undefined'){b=H.lang['en'][a]}return b},_build:function(a){var b=H.lang['en'];if(a!=='en'){b=(H.lang[a]!==undefined)?H.lang[a]:b}return b}});H.add('service','callback',{init:function(a){this.app=a;this.opts=a.opts;this.callbacks={};if(this.opts.callbacks){this._set(this.opts.callbacks,'')}},stop:function(){this.callbacks={}},add:function(a,b){if(!this.callbacks[a])this.callbacks[a]=[];this.callbacks[a].push(b)},remove:function(a,b){if(b===undefined){delete this.callbacks[a]}else{for(var i=0;i<this.callbacks[a].length;i++){this.callbacks[a].splice(i,1)}if(Object.keys(this.callbacks[a]).length===0)delete this.callbacks[a]}},trigger:function(a,b){var c=this._loop(a,b,this.callbacks);return(typeof c==='undefined'&&b&&b[0]!==false)?b[0]:c},_set:function(a,b){for(var c in a){var d=(b==='')?c:b+'.'+c;if(typeof a[c]==='object'){this._set(a[c],d)}else{this.callbacks[d]=[];this.callbacks[d].push(a[c])}}},_loop:function(a,b,c){var d;for(var e in c){if(a===e){for(var i=0;i<c[e].length;i++){d=c[e][i].apply(this.app,b)}}}return d}});H.add('service','animate',{init:function(a){this.animationOpt=a.opts.animation},start:function(a,b,c,d){var e={duration:false,iterate:false,delay:false,timing:false,prefix:'redactor-'};e=(typeof c==='function')?e:H.extend(e,c);d=(typeof c==='function')?c:d;return new H.AnimatePlay(a,b,e,d,this.animationOpt)},stop:function(a){this.$el=H.dom(a);this.$el.removeClass('redactor-animated');var b=this.$el.attr('redactor-animate-effect');this.$el.removeClass(b);this.$el.removeAttr('redactor-animate-effect');var c=this.$el.attr('redactor-animate-hide');if(c){this.$el.addClass(c).removeAttr('redactor-animate-hide')}this.$el.off('animationend webkitAnimationEnd')}});H.AnimatePlay=function(a,b,c,d,e){this.hidableEffects=['fadeOut','flipOut','slideUp','zoomOut','slideOutUp','slideOutRight','slideOutLeft'];this.prefixes=['','-webkit-'];this.$el=H.dom(a);this.$body=H.dom('body');this.callback=d;this.animation=(!e)?this.buildAnimationOff(b):b;this.defaults=c;if(this.animation==='slideUp'){this.$el.height(this.$el.height())}return(this.isInanimate())?this.inanimate():this.animate()};H.AnimatePlay.prototype={buildAnimationOff:function(a){return(this.isHidable(a))?'hide':'show'},buildHideClass:function(){return'redactor-animate-hide'},isInanimate:function(){return(this.animation==='show'||this.animation==='hide')},isAnimated:function(){return this.$el.hasClass('redactor-animated')},isHidable:function(a){return(this.hidableEffects.indexOf(a)!==-1)},inanimate:function(){this.defaults.timing='linear';var a;if(this.animation==='show'){a=this.buildHideClass();this.$el.attr('redactor-animate-hide',a);this.$el.removeClass(a)}else{a=this.$el.attr('redactor-animate-hide');this.$el.addClass(a).removeAttr('redactor-animate-hide')}if(typeof this.callback==='function')this.callback(this);return this},animate:function(){var b=(this.defaults.delay)?this.defaults.delay:0;setTimeout(function(){this.$body.addClass('no-scroll-x');this.$el.addClass('redactor-animated');if(!this.$el.attr('redactor-animate-hide')){var a=this.buildHideClass();this.$el.attr('redactor-animate-hide',a);this.$el.removeClass(a)}this.$el.addClass(this.defaults.prefix+this.animation);this.$el.attr('redactor-animate-effect',this.defaults.prefix+this.animation);this.set(this.defaults.duration+'s',this.defaults.iterate,this.defaults.timing);this.complete()}.bind(this),b*1000);return this},set:function(a,b,c){var d=this.prefixes.length;while(d--){if(a!==false||a==='')this.$el.css(this.prefixes[d]+'animation-duration',a);if(b!==false||b==='')this.$el.css(this.prefixes[d]+'animation-iteration-count',b);if(c!==false||c==='')this.$el.css(this.prefixes[d]+'animation-timing-function',c)}},clean:function(){this.$body.removeClass('no-scroll-x');this.$el.removeClass('redactor-animated');this.$el.removeClass(this.defaults.prefix+this.animation);this.$el.removeAttr('redactor-animate-effect');this.set('','','')},complete:function(){this.$el.one('animationend webkitAnimationEnd',function(){if(this.$el.hasClass(this.defaults.prefix+this.animation))this.clean();if(this.isHidable(this.animation)){var a=this.$el.attr('redactor-animate-hide');this.$el.addClass(a).removeAttr('redactor-animate-hide')}if(this.animation==='slideUp')this.$el.height('');if(typeof this.callback==='function')this.callback(this.$el)}.bind(this))}};H.add('service','caret',{init:function(a){this.app=a},setStart:function(a){this._setCaret('Start',a)},setEnd:function(a){this._setCaret('End',a)},setBefore:function(a){this._setCaret('Before',a)},setAfter:function(a){this._setCaret('After',a)},isStart:function(a){return this._isStartOrEnd(a,'First')},isEnd:function(a){return this._isStartOrEnd(a,'Last')},setAtEnd:function(a){var b=this.inspector.parse(a);var c=b.getTag();var d=document.createRange();if(this._isInPage(a)){if(c==='a'){var e=this.utils.createInvisibleChar();a.appendChild(e);d.setStartBefore(e);d.collapse(true)}else{d.selectNodeContents(a);d.collapse(false)}this.selection.setRange(d)}},setAtStart:function(a){var b=document.createRange();var c=this.inspector.parse(a);if(this._isInPage(a)){b.setStart(a,0);b.collapse(true);if(c.isInline()||this.utils.isEmpty(a)){var d=this.utils.createInvisibleChar();b.insertNode(d);b.selectNodeContents(d);b.collapse(false)}this.selection.setRange(b)}},setAtBefore:function(a){var b=this.inspector.parse(a);var c=document.createRange();if(this._isInPage(a)){c.setStartBefore(a);c.collapse(true);if(b.isInline()){var d=this.utils.createInvisibleChar();a.parentNode.insertBefore(d,a);c.selectNodeContents(d);c.collapse(false)}this.selection.setRange(c)}},setAtAfter:function(a){var b=document.createRange();if(this._isInPage(a)){b.setStartAfter(a);b.collapse(true);var c=this.utils.createInvisibleChar();b.insertNode(c);b.selectNodeContents(c);b.collapse(false);this.selection.setRange(b)}},setAtPrev:function(a){var b=a.previousSibling;if(b){b=(b.nodeType===3&&this._isEmptyTextNode(b))?b.previousElementSibling:b;if(b)this.setEnd(b)}},setAtNext:function(a){var b=a.nextSibling;if(b){b=(b.nodeType===3&&this._isEmptyTextNode(b))?b.nextElementSibling:b;if(b)this.setStart(b)}},_setCaret:function(a,b){var c=this.inspector.parse(b);var d=c.getNode();if(d){this.component.clearActive();this['_set'+a](d,c,c.getTag())}},_setStart:function(a,b,c){if(b.isText()){this.editor.focus();return this.setAtStart(a)}else if(c==='ul'||c==='ol'){a=b.findFirstNode('li');var d=this.utils.getFirstElement(a);var e=this.inspector.parse(d);if(d&&e.isComponent()){return this.setStart(e.getComponent())}}else if(c==='dl'){a=b.findFirstNode('dt')}else if(c==='br'||c==='hr'){return this.setBefore(a)}else if(c==='td'||c==='th'){var f=b.getFirstElement(a);if(f){return this.setStart(f)}}else if(c==='table'||c==='tr'){return this.setStart(b.findFirstNode('th, td'))}else if(b.isComponentType('code')&&!b.isFigcaption()){var g=b.findLastNode('pre, code');this.editor.focus();return this.setAtStart(g)}else if(c==='figure'&&b.isComponentType('table')){var h=b.getTable();var i=this.inspector.parse(h);return this.setStart(i.findFirstNode('th, td'))}else if(!b.isComponentType('table')&&b.isComponent()&&!b.isFigcaption()){return this.component.setActive(a)}this.editor.focus();if(!this._setInline(a,'Start')){this.setAtStart(a)}},_setEnd:function(a,b,c){if(b.isText()){this.editor.focus();return this.setAtEnd(a)}else if(c==='ul'||c==='ol'){a=b.findLastNode('li');var d=this.utils.getLastElement(a);var e=this.inspector.parse(d);if(d&&e.isComponent()){return this.setEnd(e.getComponent())}}else if(c==='dl'){a=b.findLastNode('dd')}else if(c==='br'||c==='hr'){return this.setAfter(a)}else if(c==='td'||c==='th'){var f=b.getLastElement();if(f){return this.setEnd(f)}}else if(c==='table'||c==='tr'){return this.setEnd(b.findLastNode('th, td'))}else if(b.isComponentType('code')&&!b.isFigcaption()){var g=b.findLastNode('pre, code');this.editor.focus();return this.setAtEnd(g)}else if(c==='figure'&&b.isComponentType('table')){var h=b.getTable();var i=this.inspector.parse(h);return this.setEnd(i.findLastNode('th, td'))}else if(!b.isComponentType('table')&&b.isComponent()&&!b.isFigcaption()){return this.component.setActive(a)}this.editor.focus();if(!this._setInline(a,'End')){if(this.utils.isEmpty(a)){return this.setStart(a)}this.setAtEnd(a)}},_setBefore:function(a,b,c){if(a.nodeType===3){return this.setAtBefore(a)}else if(b.isInline()){return this.setAtBefore(a)}else if(b.isFirstTableCell()){return this.setAtPrev(b.getComponent())}else if(c==='td'||c==='th'){return this.setAtPrev(a)}else if(b.isFirstListItem()){return this.setAtPrev(b.getList())}else if(b.isFigcaption()){return this.setStart(b.getComponent())}else if(!b.isComponentType('table')&&b.isComponent()){return this.setAtPrev(b.getComponent())}else if(b.isBlock()){return this.setAtPrev(a)}this.editor.focus();this.setAtBefore(a)},_setAfter:function(a,b,c){if(a.nodeType===3){return this.setAtAfter(a)}else if(b.isInline()){return this.setAtAfter(a)}else if(b.isLastTableCell()){return this.setAtNext(b.getComponent())}else if(c==='td'||c==='th'){return this.setAtNext(a)}else if(b.isFirstListItem()){return this.setAtNext(b.getList())}else if(!b.isComponentType('table')&&b.isComponent()){return this.setAtNext(b.getComponent())}else if(b.isBlock()){return this.setAtNext(a)}this.editor.focus();this.setAtAfter(a)},_setInline:function(a,b){var c=this._hasInlineChild(a,(b==='Start')?'first':'last');if(c){if(b==='Start'){this.setStart(c)}else{this.setEnd(c)}return true}},_isStartOrEnd:function(a,b){var c=this.utils.getNode(a);if(!c)return false;var d=this.inspector.parse(c);c=this._getStartEndNode(c,d,b);if(c&&(c.nodeType!==3&&c.tagName!=='LI')){var e=(c.nodeType===3)?c.textContent:c.innerHTML;e=this.utils.trimSpaces(e);if(e==='')return true}if(!d.isFigcaption()&&d.isComponent()&&!d.isComponentEditable()){return true}var f=this.offset.get(c,true);if(f){return(b==='First')?(f.start===0):(f.end===this.offset.size(c,true))}else{return false}},_isInPage:function(a){if(a&&a.nodeType){return(a===document.body)?false:document.body.contains(a)}else{return false}},_hasInlineChild:function(a,b){var c=this.inspector.parse(a);var d=(b==='first')?c.getFirstNode():c.getLastNode();var e=H.dom(d);if(d&&d.nodeType!==3&&this.inspector.isInlineTag(d.tagName)&&!e.hasClass('redactor-component')&&!e.hasClass('non-editable')){return d}},_isEmptyTextNode:function(a){var b=a.textContent.trim().replace(/\n/,'');b=this.utils.removeInvisibleChars(b);return(b==='')},_getStartEndNode:function(a,b,c){if(b.isFigcaption()){a=b.getFigcaption()}else if(b.isTable()){a=b['find'+c+'Node']('th, td')}else if(b.isList()){a=b['find'+c+'Node']('li')}else if(b.isComponentType('code')){a=b.findLastNode('pre, code')}return a}});H.add('service','selection',{init:function(a){this.app=a},is:function(){var a=this.get();if(a){var b=a.anchorNode;var c=this.inspector.parse(b);return(c.isInEditor()||c.isEditor())}return false},isCollapsed:function(){var a=this.get();var b=this.getRange();if(a&&a.isCollapsed)return true;else if(b&&b.toString().length===0)return true;return false},isBackwards:function(){var a=false;var b=this.get();if(b&&!b.isCollapsed){var c=document.createRange();c.setStart(b.anchorNode,b.anchorOffset);c.setEnd(b.focusNode,b.focusOffset);a=c.collapsed;c.detach()}return a},isIn:function(a){var b=H.dom(a).get();var c=this.getCurrent();return(c&&b)?b.contains(c):false},isText:function(){var a=this.get();if(a){var b=a.anchorNode;var c=this.getBlock(b);var d=this.getBlocks();if((c&&this.inspector.isTableCellTag(c.tagName))||(c===false&&d.length===0)){return true}}return false},isAll:function(a){var b=this.utils.getNode(a);if(!b)return false;var c=this.editor.isEditor(b);var d=this.inspector.parse(b);if(!d.isFigcaption()&&this.component.isNonEditable(b)&&this.component.isActive(b)){return true}if(c){var e=this.editor.getElement();var f=e.html().replace(/<p><\/p>$/i,'');var g=this.getHtml(false).length;var h=f.length;if(g!==h){return false}}if((c&&this.editor.isEmpty())||this.isCollapsed()){return false}var i=this.offset.get(b,true);var j=this.offset.size(b,true);if(!c&&d.isComponentType('code')){j=this.getText().trim().length}if(i&&i.start===0&&i.end===j){return true}return false},hasNonEditable:function(){var a=this.getHtml();var b=H.dom('<div>').html(a);return(!this.isCollapsed()&&b.find('.non-editable').length!==0)},setRange:function(a){var b=window.getSelection();b.removeAllRanges();b.addRange(a)},setAll:function(a){var b=this.utils.getNode(a);if(!b)return;var c=this.inspector.parse(b);this.component.clearActive();this.editor.focus();this.editor.saveScroll();this.editor.disableNonEditables();if(b&&b.tagName==='TABLE'){var d=c.findFirstNode('td, th');var e=c.findLastNode('td, th');H.dom(d).prepend(this.marker.build('start'));H.dom(e).append(this.marker.build('end'));this.restoreMarkers()}else if(!c.isFigcaption()&&this.component.isNonEditable(b)){this.component.setActive(b)}else{if(c.isComponentType('code')){b=c.getComponentCodeElement();b.focus()}var f=document.createRange();f.selectNodeContents(b);this.setRange(f)}this.editor.enableNonEditables();this.editor.restoreScroll()},get:function(){var a=window.getSelection();return(a.rangeCount>0)?a:null},getRange:function(){var a=this.get();return(a)?((a.getRangeAt(0))?a.getRangeAt(0):null):null},getTextBeforeCaret:function(a){a=(typeof a==='undefined')?1:a;var b=this.editor.getElement().get();var c=this.getRange();var d=false;if(c){c=c.cloneRange();c.collapse(true);c.setStart(b,0);d=c.toString().slice(-a)}return d},getTextAfterCaret:function(a){a=(typeof a==='undefined')?1:a;var b=this.editor.getElement().get();var c=this.getRange();var d=false;if(c){var e=c.cloneRange();e.selectNodeContents(b);e.setStart(c.endContainer,c.endOffset);d=e.toString().slice(0,a)}return d},getPosition:function(){var a=this.getRange();var b={top:0,left:0,width:0,height:0};if(window.getSelection&&a.getBoundingClientRect){a=a.cloneRange();var c=(a.startOffset-1);a.setStart(a.startContainer,(c<0)?0:c);var d=a.getBoundingClientRect();b={top:d.top,left:d.left,width:(d.right-d.left),height:(d.bottom-d.top)}}return b},getCurrent:function(){var a=false;var b=this.get();var c=this.component.getActive();if(c){a=c}else if(b&&this.is()){var d=this.inspector.parse(b.anchorNode);a=(!d.isEditor())?b.anchorNode:false}return a},getParent:function(){var a=false;var b=this.getCurrent();if(b){var c=b.parentNode;var d=this.inspector.parse(c);a=(!d.isEditor())?c:false}return a},getElement:function(a){var b=a||this.getCurrent();while(b){var c=this.inspector.parse(b);if(c.isElement()&&c.isInEditor()){return b}b=b.parentNode}return false},getInline:function(a){var b=a||this.getCurrent();var c=false;while(b){if(this._isInlineNode(b)){c=b}b=b.parentNode}return c},getInlineFirst:function(a){var b=a||this.getCurrent();while(b){if(this._isInlineNode(b)){return b}b=b.parentNode}return false},getInlineAll:function(a){var b=a||this.getCurrent();var c=[];while(b){if(this._isInlineNode(b)){c.push(b)}b=b.parentNode}return c},getBlock:function(a){var b=a||this.getCurrent();while(b){var c=this.inspector.parse(b);var d=this.inspector.isBlockTag(b.tagName);if(d&&c.isInEditor(b)){return b}b=b.parentNode}return false},getInlinesAllSelected:function(a){if(this.isAll())return[];var b=this.getInlines({all:true});var c=this.getNodes({textnodes:true,inline:false});var d=this.getText().replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");var e=[];if(c.length!==0){return e}if(d===''){e=b}else if(b.length>1){for(var i=0;i<b.length;i++){if(this._isTextSelected(b[i],d)){e.push(b[i])}}}else if(b.length===1){if(this._isTextSelected(b[0],d)){e=b}}e=(a&&a.tags)?this._filterNodesByTags(e,a.tags):e;return e},getInlines:function(a){var b=this.getNodes();var c=[];for(var i=0;i<b.length;i++){var d;if(a&&a.all){d=b[i];while(d){if(this._isInlineNode(d)&&!this._isInNodesArray(c,d)){c.push(d)}d=d.parentNode}}else{d=this.getInline(b[i]);if(d&&!this._isInNodesArray(c,d)){c.push(d)}}}c=(a&&a.tags)?this._filterNodesByTags(c,a.tags):c;c=(a&&a.inside)?this._filterInlinesInside(c,a):c;return c},getBlocks:function(a){var b=this.getNodes();var c=this.getBlock();b=(b.length===0&&c)?[c]:b;var d=[];for(var i=0;i<b.length;i++){var e=this.getBlock(b[i]);if(e&&!this._isInNodesArray(d,e)){d.push(e)}}d=(a&&a.tags)?this._filterNodesByTags(d,a.tags):d;d=(a&&a.first)?this._filterBlocksFirst(d,a):d;return d},getElements:function(a){var b=this.getNodes({textnodes:false});var c=this.getBlock();b=(b.length===0&&c)?[c]:b;var d=[];for(var i=0;i<b.length;i++){if(!this._isInNodesArray(d,b[i])){d.push(b[i])}}d=(a&&a.tags)?this._filterNodesByTags(d,a.tags):d;return d},getNodes:function(a){var b=[];var c=this.component.getActive();if(c){b=this._getNodesComponent(c)}else if(this.isCollapsed()){var d=this.getCurrent();b=(d)?[d]:[]}else if(this.is()&&!c){b=this._getRangeSelectedNodes()}b=this._filterServicesNodes(b);b=this._filterEditor(b);b=(a&&a.tags)?this._filterNodesByTags(b,a.tags):b;b=(a&&a.textnodes)?this._filterNodesTexts(b,a):b;b=(a&&!a.textnodes)?this._filterNodesElements(b):b;return b},getText:function(){var a=this.get();return(a)?this.utils.removeInvisibleChars(a.toString()):''},getHtml:function(a){var b='';var c=this.get();if(c){var d=document.createElement('div');var e=c.rangeCount;for(var i=0;i<e;++i){d.appendChild(c.getRangeAt(i).cloneContents())}b=d.innerHTML;b=(a!==false)?this.cleaner.output(b):b;b=b.replace(/<p><\/p>$/i,'')}return b},clear:function(){this.component.clearActive();this.get().removeAllRanges()},collapseToStart:function(){var a=this.get();if(a&&!a.isCollapsed)a.collapseToStart()},collapseToEnd:function(){var a=this.get();if(a&&!a.isCollapsed)a.collapseToEnd()},saveActiveComponent:function(){var a=this.component.getActive();if(a){this.savedComponent=a;return true}return false},restoreActiveComponent:function(){if(this.savedComponent){this.component.setActive(this.savedComponent);return true}return false},save:function(){this._clearSaved();var a=this.getElement();if(a&&(a.tagName==='TD'||a.tagName==='TH')&&a.innerHTML===''){this.savedElement=a}else if(!this.saveActiveComponent()){this.saved=this.offset.get()}},restore:function(){if(!this.saved&&!this.savedComponent&&!this.savedElement)return;this.editor.saveScroll();if(this.savedElement){this.caret.setStart(this.savedElement)}else if(!this.restoreActiveComponent()){this.offset.set(this.saved)}this._clearSaved();this.editor.restoreScroll()},saveMarkers:function(){this._clearSaved();if(!this.saveActiveComponent()){this.marker.insert()}},restoreMarkers:function(){this.editor.saveScroll();if(!this.restoreActiveComponent()){this.marker.restore()}this._clearSaved();this.editor.restoreScroll()},_getNextNode:function(a){if(a.hasChildNodes())return a.firstChild;while(a&&!a.nextSibling){a=a.parentNode}if(!a)return null;return a.nextSibling},_getNodesComponent:function(a){var b=this.getCurrent();var c=this.inspector.parse(b);return(c.isFigcaption())?[c.getFigcaption()]:[a]},_getRangeSelectedNodes:function(){var a=[];var b=this.getRange();var c=b.startContainer;var d=b.startContainer;var e=b.endContainer;var f=this.editor.getElement();if(d===f.get()&&this.isAll()){a=this.utils.getChildNodes(f)}else if(c==e){a=[c]}else{while(c&&c!=e){a.push(c=this._getNextNode(c))}c=b.startContainer;while(c&&c!=b.commonAncestorContainer){a.unshift(c);c=c.parentNode}}return a},_isInNodesArray:function(a,b){return(a.indexOf(b)!==-1)},_filterEditor:function(a){var b=[];for(var i=0;i<a.length;i++){var c=this.inspector.parse(a[i]);if(c.isInEditor()){b.push(a[i])}}return b},_filterServicesNodes:function(a){var b=[];for(var i=0;i<a.length;i++){var c=H.dom(a[i]);var d=false;if(a[i]&&a[i].nodeType===3&&this.utils.isEmpty(a[i]))d=true;if(c.hasClass('redactor-script-tag')||c.hasClass('redactor-component-caret')||c.hasClass('redactor-selection-marker')||c.hasClass('non-editable'))d=true;if(!d){b.push(a[i])}}return b},_filterNodesTexts:function(a,b){var c=[];for(var i=0;i<a.length;i++){if(a[i].nodeType===3||(b.keepbr&&a[i].tagName==='BR')){var d=this.getInline(a[i]);var e=(d&&b&&b.inline===false);if(!e){c.push(a[i])}}}return c},_filterNodesElements:function(a){var b=[];for(var i=0;i<a.length;i++){if(a[i].nodeType!==3){b.push(a[i])}}return b},_filterNodesByTags:function(a,b,c){var d=[];for(var i=0;i<a.length;i++){if(c&&a[i].nodeType===3){d.push(a[i])}else if(a[i].nodeType!==3){var e=a[i].tagName.toLowerCase();if(b.indexOf(e.toLowerCase())!==-1){d.push(a[i])}}}return d},_filterBlocksFirst:function(a){var b=[];for(var i=0;i<a.length;i++){var c=H.dom(a[i]);var d=c.parent().get();var e=(c.parent().hasClass('redactor-in'));var f=(d&&(d.tagName==='TD'||d.tagName==='TH'));if(e||f){b.push(a[i])}}return b},_filterInlinesInside:function(a){var b=[];for(var i=0;i<a.length;i++){if(window.getSelection().containsNode(a[i],true)){b.push(a[i])}}return b},_isTextSelected:function(a,b){var c=this.utils.removeInvisibleChars(a.textContent);return(b===c||c.search(b)!==-1||b.search(new RegExp('^'+c))!==-1||b.search(new RegExp(c+'$'))!==-1)},_isInlineNode:function(a){var b=this.inspector.parse(a);return(this.inspector.isInlineTag(a.tagName)&&b.isInEditor())},_clearSaved:function(){this.saved=false;this.savedComponent=false;this.savedElement=false}});H.add('service','element',{init:function(a){this.app=a;this.rootElement=a.rootElement;this.$element={};this.type='inline'},start:function(){this._build();this._buildType()},isType:function(a){return(a===this.type)},getType:function(){return this.type},getElement:function(){return this.$element},_build:function(){this.$element=H.dom(this.rootElement)},_buildType:function(){var a=this.$element.get().tagName;this.type=(a==='TEXTAREA')?'textarea':this.type;this.type=(a==='DIV')?'div':this.type;this.type=(this.opts.inline)?'inline':this.type}});H.add('service','editor',{init:function(a){this.app=a;this.scrolltop=false;this.pasting=false},start:function(){this._build()},focus:function(){if(!this.isFocus()&&!this._isContenteditableFocus()){this.saveScroll();this.$editor.focus();this.restoreScroll()}},startFocus:function(){this.caret.setStart(this.getFirstNode())},endFocus:function(){this.caret.setEnd(this.getLastNode())},isPasting:function(){return this.pasting},enablePasting:function(){this.pasting=true},disablePasting:function(){this.pasting=false},saveScroll:function(){this.scrolltop=this._getScrollTarget().scrollTop()},restoreScroll:function(){if(this.scrolltop!==false){this._getScrollTarget().scrollTop(this.scrolltop);this.scrolltop=false}},disableNonEditables:function(){this.$noneditables=this.$editor.find('[contenteditable=false]');this.$noneditables.attr('contenteditable',true)},enableNonEditables:function(){if(this.$noneditables){setTimeout(function(){this.$noneditables.attr('contenteditable',false)}.bind(this),1)}},getFirstNode:function(){return this.$editor.contents()[0]},getLastNode:function(){var a=this.$editor.contents();return a[a.length-1]},isSourceMode:function(){var a=this.source.getElement();return a.hasClass('redactor-source-open')},isEditor:function(a){var b=H.dom(a).get();return(b===this.$editor.get())},isEmpty:function(a){return this.utils.isEmptyHtml(this.$editor.html(),false,a)},isFocus:function(){var a=H.dom(document.activeElement);var b=(this.$editor.find('.redactor-component-active').length!==0);return(b||a.closest('.redactor-in-'+this.uuid).length!==0)},setEmpty:function(){this.$editor.html(this.opts.emptyHtml)},getElement:function(){return this.$editor},_build:function(){var a=this.element.getElement();var b=(this.element.isType('textarea'))?'<div>':a.get();this.$editor=H.dom(b)},_getScrollTarget:function(){return(this.opts.scrollTarget)?H.dom(this.opts.scrollTarget):this.$doc},_isContenteditableFocus:function(){var a=this.selection.getBlock();var b=(a)?H.dom(a).closest('[contenteditable=true]').not('.redactor-in'):[];return(b.length!==0)}});H.add('service','container',{init:function(a){this.app=a},start:function(){this._build()},getElement:function(){return this.$container},_build:function(){var a=(this.element.isType('inline'))?'<span>':'<div>';this.$container=H.dom(a)}});H.add('service','source',{init:function(a){this.app=a;this.$source={};this.content=''},start:function(){this._build();this._buildName();this._buildStartedContent()},getElement:function(){return this.$source},getCode:function(){return this.$source.val()},getName:function(){return this.$source.attr('name')},getStartedContent:function(){return this.content},setCode:function(a){return this.insertion.set(a,true,false)},isNameGenerated:function(){return(this.name)},_build:function(){var a=this.element.getElement();var b=this.element.isType('textarea');var c=(b)?a.get():'<textarea>';this.$source=H.dom(c)},_buildName:function(){var a=this.element.getElement();this.name=a.attr('name');this.$source.attr('name',(this.name)?this.name:'content-'+this.uuid)},_buildStartedContent:function(){var a=this.element.getElement();var b=(this.element.isType('textarea'))?a.val():a.html();this.content=b.trim()}});H.add('service','statusbar',{init:function(a){this.app=a;this.$statusbar={};this.items=[]},start:function(){this.$statusbar=H.dom('<ul>');this.$statusbar.attr('dir',this.opts.direction)},add:function(a,b){return this.update(a,b)},update:function(a,b){var c;if(typeof this.items[a]!=='undefined'){c=this.items[a]}else{c=H.dom('<li>');this.$statusbar.append(c);this.items[a]=c}return c.html(b)},get:function(a){return(this.items[a])?this.items[a]:false},remove:function(a){if(this.items[a]){this.items[a].remove();delete this.items[a]}},getItems:function(){return this.items},removeItems:function(){this.items={};this.$statusbar.html('')},getElement:function(){return this.$statusbar}});H.add('service','toolbar',{init:function(a){this.app=a;this.buttons=[];this.dropdownOpened=false;this.buttonsObservers={}},start:function(){if(this.is()){this.opts.activeButtons=(this.opts.activeButtonsAdd)?this._extendActiveButtons():this.opts.activeButtons;this.create()}},stopObservers:function(){this.buttonsObservers={}},create:function(){this.$wrapper=H.dom('<div>');this.$toolbar=H.dom('<div>')},observe:function(){if(!this.is())return;this.setButtonsInactive();var a,observer;for(var b in this.buttonsObservers){observer=this.buttonsObservers[b];a=this.getButton(b);this.app.broadcast('button.'+observer+'.observe',a)}var c=this.opts.activeButtons;var d=this.selection.getInlinesAllSelected();var e=this.selection.getInline();if(this.selection.isCollapsed()&&e){d.push(e)}var f=this._inlinesToTags(d);for(var g in c){if(f.indexOf(g)!==-1){a=this.getButton(c[g]);a.setActive()}}},is:function(){return!(!this.opts.toolbar||(this.detector.isMobile()&&this.opts.air))},isAir:function(){return(this.is())?this.$toolbar.hasClass('redactor-air'):false},isFixed:function(){return(this.is())?this.$toolbar.hasClass('redactor-toolbar-fixed'):false},isContextBar:function(){var a=this.$body.find('#redactor-context-toolbar-'+this.uuid);return a.hasClass('open')},isTarget:function(){return(this.opts.toolbarFixedTarget!==document)},getElement:function(){return this.$toolbar},getWrapper:function(){return this.$wrapper},getDropdown:function(){return this.dropdownOpened},getTargetElement:function(){return H.dom(this.opts.toolbarFixedTarget)},getButton:function(a){var b=this._findButton('.re-'+a);return(b.length!==0)?b.dataget('data-button-instance'):false},getButtonByIndex:function(a){var b=this.$toolbar.find('.re-button').eq(a);return(b.length!==0)?b.dataget('data-button-instance'):false},getButtons:function(){var c=[];this._findButtons().each(function(a){var b=H.dom(a);c.push(b.dataget('data-button-instance'))});return c},getButtonsKeys:function(){var c=[];this._findButtons().each(function(a){var b=H.dom(a);c.push(b.attr('data-re-name'))});return c},addButton:function(a,b,c,d,e){c=c||'end';var f=this._getButtonIndex(a);var g=H.create('toolbar.button',this.app,a,b);if(b.observe){this.opts.activeButtonsObservers[a]={observe:b.observe,button:g}}if(e!==true){if(f===0)c='first';else if(f!==-1){var h=this.getButtonByIndex(f-1);if(h){c='after';d=h}}}if(this.is()){if(c==='first')this.$toolbar.prepend(g);else if(c==='after')d.after(g);else if(c==='before')d.before(g);else this.$toolbar.append(g)}return g},addButtonFirst:function(a,b){return this.addButton(a,b,'first')},addButtonAfter:function(a,b,c){var d=this.getButton(a);return(d)?this.addButton(b,c,'after',d):this.addButton(b,c)},addButtonBefore:function(a,b,c){var d=this.getButton(a);return(d)?this.addButton(b,c,'before',d):this.addButton(b,c)},addButtonObserver:function(a,b){this.buttonsObservers[a]=b},setButtons:function(a){this.buttons=a},setDropdown:function(a){this.dropdownOpened=a},setButtonsInactive:function(){var a=this.getButtons();for(var i=0;i<a.length;i++){a[i].setInactive()}},setButtonsActive:function(){var a=this.getButtons();for(var i=0;i<a.length;i++){a[i].setActive()}},disableButtons:function(){var a=this.getButtons();for(var i=0;i<a.length;i++){a[i].disable()}},enableButtons:function(){var a=this.getButtons();for(var i=0;i<a.length;i++){a[i].enable()}},_getButtonIndex:function(a){var b=this.buttons.indexOf(a);return(b===-1)?false:b},_findButton:function(a){return(this.is())?this.$toolbar.find(a):H.dom()},_findButtons:function(){return(this.is())?this.$toolbar.find('.re-button'):H.dom()},_extendActiveButtons:function(){return H.extend({},this.opts.activeButtons,this.opts.activeButtonsAdd)},_inlinesToTags:function(a){var b=[];for(var i=0;i<a.length;i++){b.push(a[i].tagName.toLowerCase())}return b}});H.add('class','toolbar.button',{mixins:['dom'],init:function(a,b,c){this.app=a;this.opts=a.opts;this.lang=a.lang;this.$body=a.$body;this.toolbar=a.toolbar;this.detector=a.detector;this.obj=c;this.name=b;this.dropdown=false;this.tooltip=false;this._init()},isActive:function(){return this.hasClass('redactor-button-active')},isDisabled:function(){return this.hasClass('redactor-button-disabled')},hasIcon:function(){return(this.obj.icon&&!this.opts.buttonsTextLabeled)},setDropdown:function(a){this.obj.dropdown=a;this.obj.message=false;this.dropdown=H.create('toolbar.dropdown',this.app,this.name,this.obj.dropdown);this.attr('data-dropdown',true)},setMessage:function(a,b){this.obj.message=a;this.obj.args=b;this.obj.dropdown=false},setApi:function(a,b){this.obj.api=a;this.obj.args=b;this.obj.dropdown=false},setTitle:function(a){this.obj.title=this.lang.parse(a);this.obj.tooltip=this.obj.title;this.attr({'alt':this.obj.tooltip,'aria-label':this.obj.tooltip});if(!this.attr('data-re-icon'))this.html(this.obj.title)},setTooltip:function(a){this.obj.tooltip=this.lang.parse(a);this.attr({'alt':this.obj.tooltip,'aria-label':this.obj.tooltip})},setIcon:function(a){if(this.opts.buttonsTextLabeled)return;this.obj.icon=true;this.$icon=H.dom(a);this.html('');this.append(this.$icon);this.attr('data-re-icon',true);this.addClass('re-button-icon');this.setTooltip(this.obj.title);this._buildTooltip()},setActive:function(){this.addClass('redactor-button-active')},setInactive:function(){this.removeClass('redactor-button-active')},hideTooltip:function(){this.$body.find('.re-button-tooltip').remove()},getDropdown:function(){return this.dropdown},disable:function(){this.addClass('redactor-button-disabled')},enable:function(){this.removeClass('redactor-button-disabled')},toggle:function(e){if(e)e.preventDefault();if(this.isDisabled())return;if(this.obj.dropdown){this.dropdown.toggle(e)}else if(this.obj.api){this.app.api(this.obj.api,this.obj.args,this.name)}else if(this.obj.message){this.app.broadcast(this.obj.message,this.obj.args,this.name)}this.hideTooltip()},_init:function(){this._parseTitle();this._parseTooltip();this._build();this._buildCallback();this._buildAttributes();this._buildObserver();if(this.hasIcon()){this._buildIcon();this._buildTooltip()}else{this.html(this.obj.title)}},_parseTooltip:function(){this.obj.tooltip=(this.obj.tooltip)?this.lang.parse(this.obj.tooltip):this.obj.title},_parseTitle:function(){this.obj.title=this.lang.parse(this.obj.title)},_build:function(){this.parse('<a>');this.addClass('re-button re-'+this.name);this.attr('data-re-name',this.name);this.dataset('data-button-instance',this);if(this.obj.dropdown)this.setDropdown(this.obj.dropdown)},_buildCallback:function(){this.on('click',this.toggle.bind(this))},_buildAttributes:function(){var a={'href':'#','alt':this.obj.tooltip,'rel':this.name,'role':'button','aria-label':this.obj.tooltip,'tabindex':'-1'};this.attr(a)},_buildObserver:function(){if(typeof this.obj.observe!=='undefined'){this.toolbar.addButtonObserver(this.name,this.obj.observe)}},_buildIcon:function(){var a=this.obj.icon;var b=(/(<([^>]+)>)/ig.test(a));this.$icon=(b)?H.dom(a):H.dom('<i>');if(!b)this.$icon.addClass('re-icon-'+this.name);this.append(this.$icon);this.attr('data-re-icon',true);this.addClass('re-button-icon')},_buildTooltip:function(){if(this.detector.isDesktop()){this.tooltip=H.create('toolbar.button.tooltip',this.app,this)}}});H.add('class','toolbar.button.tooltip',{mixins:['dom'],init:function(a,b){this.app=a;this.opts=a.opts;this.$body=a.$body;this.toolbar=a.toolbar;this.$button=b;this.created=false;this._init()},open:function(){if(this.$button.hasClass('redactor-button-disabled')||this.$button.hasClass('redactor-button-active'))return;this.created=true;this.parse('<span>');this.addClass('re-button-tooltip');this.$body.append(this);this.html(this.$button.attr('alt'));var a=this.$button.offset();var b='absolute';var c=this.$button.height();var d=this.$button.width();var e=4;this.css({top:(a.top+c+e)+'px',left:(a.left+d/2-this.width()/2)+'px',position:b});this.show()},close:function(){if(!this.created||this.$button.hasClass('redactor-button-disabled'))return;this.remove();this.created=false},_init:function(){this.$button.on('mouseover',this.open.bind(this));this.$button.on('mouseout',this.close.bind(this))}});H.add('class','toolbar.dropdown',{mixins:['dom'],init:function(a,b,c){this.app=a;this.uuid=a.uuid;this.opts=a.opts;this.$win=a.$win;this.$doc=a.$doc;this.$body=a.$body;this.animate=a.animate;this.toolbar=a.toolbar;this.name=b;this.started=false;this.items=c;this.$items=[]},toggle:function(e){if(!this.started){this._build()}if(this.isOpened()&&this.isActive()){this.close(false)}else{this.open(e)}},isOpened:function(){var a=this.$body.find('.redactor-dropdown-'+this.uuid+'.open');return(a.length!==0&&a.attr('data-re-name')===this.name)},isActive:function(){var a=this.$body.find('#redactor-dropdown-'+this.uuid+'-'+this.name+'.open');return(a.length!==0)},getName:function(){return this.attr('data-re-name')},getItem:function(a){return this.$items[a]},getItemsByClass:function(a){var b=[];for(var c in this.$items){if(typeof this.$items[c]==='object'&&this.$items[c].hasClass(a)){b.push(this.$items[c])}}return b},open:function(e){this._closeAll();this.$btn=this.toolbar.getButton(this.name);this.app.broadcast('dropdown.open',e,this,this.$btn);this.toolbar.setDropdown(this);this.show();this.removeClass('redactor-animate-hide');this.addClass('open');this._observe();this.$btn.hideTooltip();this.$btn.setActive();this.$doc.on('keyup.redactor.dropdown-'+this.uuid,this._handleKeyboard.bind(this));this.$doc.on('click.redactor.dropdown-'+this.uuid+' touchstart.redactor.dropdown-'+this.uuid,this.close.bind(this));this.updatePosition();this.app.broadcast('dropdown.opened',e,this,this.$btn)},close:function(e,a){if(e){var b=H.dom(e.target);if(this._isButton(e)||b.hasClass('redactor-dropdown-not-close')||b.hasClass('redactor-dropdown-item-disabled')){e.preventDefault();return}}this.app.broadcast('dropdown.close',this,this.$btn);this.toolbar.setDropdown(false);this.$btn.setInactive();if(a===false){this._close()}else{this.animate.start(this,'fadeOut',this._close.bind(this))}},updatePosition:function(){var a=this.toolbar.isFixed();var b=this.$btn.offset();b.top=(a)?this.$btn.position().top:b.top;var c=this.$btn.height();var d=this.$btn.width();var e=(a)?'fixed':'absolute';var f=2;var g=0;var h=(b.left+g);var i=parseFloat(this.css('width'));var j=(this.$win.width()<(h+i))?(i-d):0;this.css({position:e,top:(b.top+c+f)+'px',left:(h-j)+'px'})},_build:function(){this.parse('<div>');this.attr('dir',this.opts.direction);this.attr('id','redactor-dropdown-'+this.uuid+'-'+this.name);this.attr('data-re-name',this.name);this.addClass('redactor-dropdown redactor-dropdown-'+this.uuid+' redactor-dropdown-'+this.name);this.dataset('data-dropdown-instance',this);var a=(this.items.dom||typeof this.items==='string');if(a)this._buildDom();else this._buildItems();this.$body.append(this);this.started=true},_buildDom:function(){this.html('').append(H.dom(this.items))},_buildItems:function(){this.items=(this.name==='format')?this._buildFormattingItems():this.items;for(var a in this.items){var b=this.items[a];if(a==='observe'){this.attr('data-observe',this.items[a])}else{var c=H.create('toolbar.dropdown.item',this.app,a,b,this);this.$items[a]=c;this.append(c)}}},_buildFormattingItems:function(){for(var a in this.items){if(this.opts.formatting.indexOf(a)===-1)delete this.items[a]}if(this.opts.formattingHide){for(var a in this.items){if(this.opts.formattingHide.indexOf(a)!==-1)delete this.items[a]}}if(this.opts.formattingAdd){for(var a in this.opts.formattingAdd){this.items[a]=this.opts.formattingAdd[a]}}return this.items},_handleKeyboard:function(e){if(e.which===27)this.close()},_isButton:function(e){var a=H.dom(e.target);var b=a.closest('.re-button');return(b.get()===this.$btn.get())},_close:function(){this.$btn.setInactive();this.$doc.off('.redactor.dropdown-'+this.uuid);this.removeClass('open');this.addClass('redactor-animate-hide');this.app.broadcast('dropdown.closed',this,this.$btn)},_closeAll:function(){this.$body.find('.redactor-dropdown-'+this.uuid+'.open').each(function(a){var b=H.dom(a);var c=b.dataget('data-dropdown-instance');c._close()})},_observe:function(){var a=this.attr('data-observe');if(a){this.app.broadcast('dropdown.'+a+'.observe',this)}}});H.add('class','toolbar.dropdown.item',{mixins:['dom'],init:function(a,b,c,d){this.app=a;this.lang=a.lang;this.dropdown=d;this.name=b;this.obj=c;this._init()},setTitle:function(a){this.$span.html(a)},getTitle:function(){return this.$span.html()},enable:function(){this.removeClass('redactor-dropdown-item-disabled')},disable:function(){this.addClass('redactor-dropdown-item-disabled')},toggle:function(e){if(e)e.preventDefault();if(this.hasClass('redactor-dropdown-item-disabled'))return;if(this.obj.message){this.app.broadcast(this.obj.message,this.obj.args,this.name)}else if(this.obj.api){this.app.api(this.obj.api,this.obj.args,this.name)}},_init:function(){this.parse('<a>');this.attr('href','#');this.addClass('redactor-dropdown-item-'+this.name);if(this.obj.classname){this.addClass(this.obj.classname)}this.attr('data-re-name',this.name);this.on('click',this.toggle.bind(this));this.$span=H.dom('<span>');this.append(this.$span);this.setTitle(this.lang.parse(this.obj.title))}});H.add('service','cleaner',{init:function(a){this.app=a;this.opts=a.opts;this.storedComponents=[];this.storedImages=[];this.storedLinks=[];this.deniedTags=['font','html','head','link','title','body','meta','applet'];this.convertRules={};this.unconvertRules={};this.reComments=/<!--[\s\S]*?-->/g;this.reSpacedEmpty=/^(||\s||<br\s?\/?>||&nbsp;)$/i;this.reScriptTag=/<script(.*?[^>]?)>([\w\W]*?)<\/script>/gi},addConvertRules:function(a,b){this.convertRules[a]=b},addUnconvertRules:function(a,b){this.unconvertRules[a]=b},input:function(a,b,c){a=this.encodePreCode(a);a=a.replace(/\$/g,'&#36;');a=a.replace(/&amp;/g,'&');var d=H.create('cleaner.figure',this.app);a=d.convert(a,this.convertRules);a=this.storeComponents(a);a=this.replaceTags(a,this.opts.replaceTags);a=this._setSpanAttr(a);a=this._setStyleCache(a);a=this.removeTags(a,this.deniedTags);a=(this.opts.removeScript)?this._removeScriptTag(a):this._replaceScriptTag(a);a=(this.opts.removeComments)?this.removeComments(a):a;a=(this._isSpacedEmpty(a))?this.opts.emptyHtml:a;a=this.restoreComponents(a);a=this._cleanWrapped(a);a=(b)?this.paragraphize(a):a;return a},output:function(a,b){a=this.removeInvisibleSpaces(a);if(this._isSpacedEmpty(a))return'';if(this._isParagraphEmpty(a))return'';a=this.removeServiceTagsAndAttrs(a,b);a=this.storeComponents(a);a=this.removeSpanWithoutAttributes(a);a=this.removeFirstBlockBreaklineInHtml(a);a=(this.opts.removeScript)?a:this._unreplaceScriptTag(a);a=(this.opts.preClass)?this._setPreClass(a):a;a=(this.opts.linkNofollow)?this._setLinkNofollow(a):a;a=(this.opts.removeNewLines)?this.cleanNewLines(a):a;a=this.restoreComponents(a);var c=H.create('cleaner.figure',this.app);a=c.unconvert(a,this.unconvertRules);a=this.removeEmptyAttributes(a,['style','class','rel','alt','title']);a=this.cleanSpacesInPre(a);a=this.tidy(a);a=a.replace(/&amp;/g,'&');a=(a.replace(/\n/g,'')==='')?'':a;return a},paste:function(d){d=this.storeComponents(d);var e=this.deniedTags.concat(['iframe']);d=this.removeTags(d,e);d=d.replace(new RegExp("<\!doctype([\\s\\S]+?)>",'gi'),'');d=d.replace(new RegExp("<style([\\s\\S]+?)</style>",'gi'),'');d=d.replace(new RegExp("</p><br /><p",'gi'),'</p><p');var f=this._isHtmlMsWord(d);d=this._cleanGDocs(d);d=(f)?this._cleanMsWord(d):d;if(!this.opts.pasteClean){d=this.restoreComponents(d);return d}if(this.opts.pastePlainText){d=this.restoreComponents(d);return this.pastePlainText(d)}var g=this.opts.pasteBlockTags.concat(this.opts.pasteInlineTags);d=this.removeTagsExcept(d,g);d=(this.opts.pasteLinks)?d:this.removeTags(d,['a']);d=(this.opts.pasteImages)?d:this.removeTags(d,['img']);var h=this.utils.buildWrapper(d);var i=h.find('*');var j=(this.opts.pasteKeepStyle.length!==0)?','+this.opts.pasteKeepStyle.join(','):'';i.not('[data-redactor-style-cache]'+j).removeAttr('style');var k=(this.opts.pasteKeepClass.length!==0)?','+this.opts.pasteKeepClass.join(','):'';i.not('[data-redactor-style-cache]'+k).removeAttr('class');var l=(this.opts.pasteKeepAttrs.length!==0)?','+this.opts.pasteKeepAttrs.join(','):'';i.not('img, a, [data-redactor-style-cache]'+l).each(function(a){while(a.attributes.length>0){a.removeAttribute(a.attributes[0].name)}});if(this.opts.pasteLinks&&this.opts.pasteLinkTarget!==false){h.find('a').attr('target',this.opts.pasteLinkTarget)}h.find('[data-redactor-style-cache]').each(function(a){var b=a.getAttribute('data-redactor-style-cache');a.setAttribute('style',b)});h.find('span').each(function(a){if(a.attributes.length===0){H.dom(a).unwrap()}});h.find(this.opts.inlineTags.join(',')).each(function(a){if(a.attributes.length===0&&this.utils.isEmptyHtml(a.innerHTML)){H.dom(a).unwrap()}}.bind(this));h.find('ul, ol').each(function(a){var b=a.previousSibling;if(b&&b.tagName==='LI'){var c=H.dom(b);c.find('p').unwrap();c.append(a)}});d=this.utils.getWrapperHtml(h);d=d.replace(/<li><p>/gi,'<li>');d=d.replace(/<\/p><\/li>/gi,'</li>');d=d.replace(/<p>&nbsp;<\/p>/gi,'<p></p>');d=d.replace(/<p><br\s?\/?><\/p>/gi,'<p></p>');if(f){d=d.replace(/<p><\/p>/gi,'');d=d.replace(/<p>\s<\/p>/gi,'')}d=this.restoreComponents(d);return d},pastePlainText:function(a){a=(this.opts.pasteLinks)?this.storeLinks(a):a;a=(this.opts.pasteImages)?this.storeImages(a):a;a=this.getPlainText(a);a=this._replaceNlToBr(a);a=(this.opts.pasteLinks)?this.restoreLinks(a):a;a=(this.opts.pasteImages)?this.restoreImages(a):a;return a},tidy:function(a){return a},paragraphize:function(a){var b=H.create('cleaner.paragraphize',this.app);return b.convert(a)},getFlatText:function(a){var b=H.dom('<div>');if(!a.nodeType&&!a.dom){a=a.toString();a=a.trim();b.html(a)}else{b.append(a)}a=b.get().textContent||b.get().innerText||'';return(a===undefined)?'':a},getPlainText:function(a){a=a.replace(/<!--[\s\S]*?-->/gi,'');a=a.replace(/<style[\s\S]*?style>/gi,'');a=a.replace(/<p><\/p>/g,'');a=a.replace(/<\/div>|<\/li>|<\/td>/gi,'\n');a=a.replace(/<\/p>/gi,'\n\n');a=a.replace(/<\/H[1-6]>/gi,'\n\n');var b=document.createElement('div');b.innerHTML=a;a=b.textContent||b.innerText;return a.trim()},replaceTags:function(b,c){if(c){var d=this;var e=Object.keys(c);var f=this.utils.buildWrapper(b);f.find(e.join(',')).each(function(a){d.utils.replaceToTag(a,c[a.tagName.toLowerCase()])});b=this.utils.getWrapperHtml(f)}return b},replaceNbspToSpaces:function(a){return a.replace('&nbsp;',' ')},replaceBlocksToBr:function(a){a=a.replace(/<\/div>|<\/li>|<\/td>|<\/p>|<\/H[1-6]>/gi,'<br>');return a},cleanNewLines:function(a){return a.replace(/\r?\n/g,"")},cleanSpacesInPre:function(a){return a.replace('&nbsp;&nbsp;&nbsp;&nbsp;','    ')},removeInvisibleSpaces:function(a){a=this.utils.removeInvisibleChars(a);a=a.replace(/&#65279;/gi,'');return a},removeNl:function(a){a=a.replace(/\n/g," ");a=a.replace(/\s+/g,"\s");return a},removeBrAtEnd:function(a){a=a.replace(/<br\s?\/?>$/gi,' ');a=a.replace(/<br\s?\/?><li/gi,'<li');return a},removeTags:function(c,d){var e=(d)?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi;var f=(!d)?'':function(a,b){return d.indexOf(b.toLowerCase())===-1?a:''};return c.replace(e,f)},removeTagsExcept:function(c,d){if(d===undefined)return c.replace(/(<([^>]+)>)/gi,'');var e=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;return c.replace(e,function(a,b){return d.indexOf(b.toLowerCase())===-1?'':a})},removeComments:function(a){return a.replace(this.reComments,'')},removeServiceTagsAndAttrs:function(d,e){var f=this.utils.buildWrapper(d);var g=this;if(e!==false){f.find('.redactor-selection-marker').each(function(a){var b=H.dom(a);var c=g.utils.removeInvisibleChars(b.text());return(c==='')?b.remove():b.unwrap()})}f.find('[data-redactor-style-cache]').removeAttr('data-redactor-style-cache');return this.utils.getWrapperHtml(f)},removeSpanWithoutAttributes:function(b){var c=this.utils.buildWrapper(b);c.find('span').removeAttr('data-redactor-span data-redactor-style-cache').each(function(a){if(a.attributes.length===0)H.dom(a).unwrap()});return this.utils.getWrapperHtml(c)},removeFirstBlockBreaklineInHtml:function(a){return a.replace(new RegExp('</li><br\\s?/?>','gi'),'</li>')},removeEmptyAttributes:function(a,b){var c=this.utils.buildWrapper(a);for(var i=0;i<b.length;i++){c.find('['+b[i]+'=""]').removeAttr(b[i])}return this.utils.getWrapperHtml(c)},encodeHtml:function(a){a=a.replace(/<br\s?\/?>/g,"\n");a=a.replace(/&nbsp;/g,' ');a=a.replace(/”/g,'"');a=a.replace(/“/g,'"');a=a.replace(/‘/g,'\'');a=a.replace(/’/g,'\'');a=this.encodeEntities(a);a=a.replace(/\$/g,'&#36;');if(this.opts.preSpaces){a=a.replace(/\t/g,new Array(this.opts.preSpaces+1).join(' '))}return a},encodePreCode:function(a){var b=a.match(new RegExp('<code(.*?)>(.*?)<pre(.*?)>(.*?)</pre>(.*?)</code>','gi'));if(b!==null){for(var i=0;i<b.length;i++){var c=b[i].match(new RegExp('<pre(.*?)>([\\w\\W]*?)</pre>','i'));a=a.replace(c[0],this.encodeEntities(c[0]))}}var d=this.utils.buildWrapper(a);d.find('code code').replaceWith(this._encodeOuter.bind(this));d.find('code pre').replaceWith(this._encodeOuter.bind(this));d.find('pre pre').replaceWith(this._encodeOuter.bind(this));d.find('code, pre').each(this._encodePreCodeLine.bind(this));a=this.utils.getWrapperHtml(d);a=this._decodeMarkers(a);return a},encodeEntities:function(a){a=this.decodeEntities(a);a=a.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');return a},encodePhpCode:function(a){a=a.replace('<?php','&lt;?php');a=a.replace('<?','&lt;?');a=a.replace('?>','?&gt;');return a},decodeEntities:function(a){return String(a).replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&amp;/g,'&')},storeComponents:function(a){var b=this.utils.getElementsFromHtml(a,'figure','table');return this._storeMatched(a,b,'Components','figure')},restoreComponents:function(a){return this._restoreMatched(a,'Components','figure')},storeLinks:function(a){var b=this.utils.getElementsFromHtml(a,'a');return this._storeMatched(a,b,'Links','a')},storeImages:function(a){var b=this.utils.getElementsFromHtml(a,'img');return this._storeMatched(a,b,'Images','img')},restoreLinks:function(a){return this._restoreMatched(a,'Links','a')},restoreImages:function(a){return this._restoreMatched(a,'Images','img')},_cleanWrapped:function(a){a=a.replace(new RegExp('<p><figure([\\w\\W]*?)</figure></p>','gi'),'<figure$1</figure>');return a},_cleanGDocs:function(a){a=a.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2");a=a.replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3");a=a.replace(/<span[^>]*(font-style: italic; font-weight: bold|font-weight: bold; font-style: italic)[^>]*>([\w\W]*?)<\/span>/gi,'<b><i>$2</i></b>');a=a.replace(/<span[^>]*(font-style: italic; font-weight: 700|font-weight: 700; font-style: italic)[^>]*>([\w\W]*?)<\/span>/gi,'<b><i>$2</i></b>');a=a.replace(/<span[^>]*font-style: italic[^>]*>([\w\W]*?)<\/span>/gi,'<i>$1</i>');a=a.replace(/<span[^>]*font-weight: bold[^>]*>([\w\W]*?)<\/span>/gi,'<b>$1</b>');a=a.replace(/<span[^>]*font-weight: 700[^>]*>([\w\W]*?)<\/span>/gi,'<b>$1</b>');return a},_cleanMsWord:function(e){e=e.replace(/<!--[\s\S]+?-->/gi,'');e=e.replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|img|meta|link|style|\w:\w+)(?=[\s\/>]))[^>]*>/gi,'');e=e.replace(/<(\/?)s>/gi,"<$1strike>");e=e.replace(/&nbsp;/gi,' ');e=e.replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,function(a,b){return(b.length>0)?b.replace(/./," ").slice(Math.floor(b.length/2)).split("").join("\u00a0"):''});var f=this.utils.buildWrapper(e);f.find('p').each(function(a){var b=H.dom(a);var c=b.attr('style');var d=/mso-list:\w+ \w+([0-9]+)/.exec(c);if(d){b.data('_listLevel',parseInt(d[1],10))}});this._parseWordLists(f);f.find('[style]').removeAttr('style');f.find('[align]').removeAttr('align');f.find('[name]').removeAttr('name');f.find('span').unwrap();f.find("[class^='Mso']").removeAttr('class');f.find('a').filter(function(a){return!a.hasAttribute('href')}).unwrap();e=this.utils.getWrapperHtml(f);e=e.replace(/<p[^>]*><\/p>/gi,'');e=e.replace(/<li>·/gi,'<li>');e=e.trim();e=e.replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,'/$1>\n<$2');var g='';var h=e.split(/\n/);for(var i=0;i<h.length;i++){var j=(h[i]!==''&&h[i].search(/>$/)===-1)?' ':'\n';g+=h[i]+j}return g},_parseWordLists:function(j){var k=0;var l=null;j.find('p').each(function(a){var b=H.dom(a);var c=b.data('_listLevel');if(c!==null){var d=b.text();var e='<ul></ul>';if(/^\s*\w+\./.test(d)){var f=/([0-9])\./.exec(d);if(f){var g=parseInt(f[1],10);e=(g>1)?'<ol start="'+g+'"></ol>':'<ol></ol>'}else{e='<ol></ol>'}}if(c>k){if(k===0){b.before(e);l=b.prev()}else{var h=H.dom(e);l.append(h)}}if(c<k){for(var i=0;i<(k-c);i++){l=l.parent()}}b.find('span').first().unwrap();l.append('<li>'+b.html()+'</li>');b.remove();k=c}else{k=0}})},_isSpacedEmpty:function(a){return(a.search(this.reSpacedEmpty)!==-1)},_isParagraphEmpty:function(a){return(a.search(/^<p><\/p>$/i)!==-1)},_isHtmlMsWord:function(a){return a.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)},_setSpanAttr:function(a){var b=this.utils.buildWrapper(a);b.find('span').attr('data-redactor-span',true);return this.utils.getWrapperHtml(b)},_setStyleCache:function(c){var d=this.utils.buildWrapper(c);d.find('[style]').each(function(a){var b=H.dom(a);b.attr('data-redactor-style-cache',b.attr('style'))});return this.utils.getWrapperHtml(d)},_setPreClass:function(a){var b=this.utils.buildWrapper(a);b.find('pre').addClass(this.opts.preClass);return this.utils.getWrapperHtml(b)},_setLinkNofollow:function(a){var b=this.utils.buildWrapper(a);b.find('a').attr('rel','nofollow');return this.utils.getWrapperHtml(b)},_replaceScriptTag:function(a){return a.replace(this.reScriptTag,'<pre class="redactor-script-tag" $1>$2</pre>')},_unreplaceScriptTag:function(a){return a.replace(/<pre class="redactor-script-tag"(.*?[^>]?)>([\w\W]*?)<\/pre>/gi,'<script$1>$2</script>')},_replaceNlToBr:function(a){return a.replace(/\n/g,'<br />')},_removeScriptTag:function(a){return a.replace(this.reScriptTag,'')},_storeMatched:function(a,b,c,d){this['stored'+c]=[];if(b){for(var i=0;i<b.length;i++){this['stored'+c][i]=b[i];a=a.replace(b[i],'####'+d+i+'####')}}return a},_restoreMatched:function(a,b,c){if(this['stored'+b]){for(var i=0;i<this['stored'+b].length;i++){a=a.replace('####'+c+i+'####',this['stored'+b][i])}}return a},_decodeMarkers:function(a){var b='<span id="selection-marker-$1" class="redactor-selection-marker">​</span>';return a.replace(/&lt;span\sid="selection-marker-(start|end)"\sclass="redactor-selection-marker"&gt;(.*?[^>]?)&lt;\/span&gt;/g,b)},_encodeOuter:function(a){return this.encodeEntities(a.outerHTML)},_encodePreCodeLine:function(a){var b=a.firstChild;if(a.tagName=='PRE'&&(b&&b.tagName==='CODE'))return;var c=this.decodeEntities(a.innerHTML);c=c.replace(/&nbsp;/g,' ').replace(/<br\s?\/?>/g,'\n');c=(this.opts.preSpaces)?c.replace(/\t/g,new Array(this.opts.preSpaces+1).join(' ')):c;a.textContent=c}});H.add('class','cleaner.figure',{init:function(a){this.app=a;this.opts=a.opts;this.utils=a.utils},convert:function(a,b){var c=this.utils.buildWrapper(a);c.find('img').each(this._convertImage.bind(this));c.find('hr').each(this._convertLine.bind(this));c.find('iframe').each(this._convertIframe.bind(this));c.find('table').each(this._convertTable.bind(this));c.find('form').each(this._convertForm.bind(this));c.find('figure pre').each(this._convertCode.bind(this));c.find('[data-redactor-type=variable]').addClass('redactor-component');c.find('[data-redactor-type=wicons]').addClass('redactor-component');c.find('figure').not('.redactor-component, .redactor-figure-code').each(this._convertWidget.bind(this));c.find('figure pre').each(this._setContenteditableCode.bind(this));c.find('.redactor-component, .non-editable').attr('contenteditable',false);c.find('figcaption, td, th').attr('contenteditable',true);c.find('.redactor-component, figcaption').attr('tabindex','-1');this._acceptExtraRules(c,b);return this.utils.getWrapperHtml(c)},unconvert:function(b,c){var d=this.utils.buildWrapper(b);d.find('th, td, figcaption, figure, pre, code, .redactor-component').removeAttr('contenteditable tabindex');d.find('figure').removeClass('redactor-component redactor-component-active redactor-uploaded-figure');d.find('[data-redactor-type=variable]').removeClass('redactor-component');d.find('figure[data-redactor-type=line]').unwrap();d.find('figure[data-redactor-type=widget]').each(this._unconvertWidget.bind(this));d.find('figure[data-redactor-type=form]').each(this._unconvertForm.bind(this));d.find('figure[data-redactor-type=table]').each(this._unconvertTable.bind(this));d.find('figure[data-redactor-type=image]').removeAttr('rel').each(this._unconvertImages.bind(this));d.find('img').removeAttr('data-redactor-type').removeClass('redactor-component');d.find('.non-editable').removeAttr('contenteditable');d.find('figure').each(this._removeTypes.bind(this));d.find('span.redactor-component-caret').remove();if(this.opts.breakline){d.find('[data-redactor-tag="br"]').each(function(a){if(a.lastChild&&a.lastChild.tagName!=='BR'){a.appendChild(document.createElement('br'))}}).unwrap()}this._acceptExtraRules(d,c);b=this.utils.getWrapperHtml(d);b=b.replace(/<br\s?\/?>$/,'');return b},_convertImage:function(a){var b=H.dom(a);if(this._isNonEditable(b))return;if(!b.attr('data-image')){b.attr('data-image',this.utils.getRandomId())}var c=b.closest('a');var d=b.closest('figure');var e=(d.children().not('a, img, br, figcaption').length===0);if(!e)return;if(d.length===0){d=(c.length!==0)?c.wrap('<figure>'):b.wrap('<figure>')}else{if(d.hasClass('redactor-uploaded-figure')){d.removeClass('redactor-uploaded-figure')}else{d.addClass('redactor-keep-figure')}}this._setFigure(d,'image')},_convertTable:function(a){if(this._isNonEditable(a))return;var b=this._wrapFigure(a);this._setFigure(b,'table')},_convertLine:function(a){if(this._isNonEditable(a))return;var b=this._wrapFigure(a);this._setFigure(b,'line')},_convertForm:function(a){if(this._isNonEditable(a))return;var b=this.utils.replaceToTag(a,'figure');this._setFigure(b,'form')},_convertIframe:function(a){if(this._isNonEditable(a))return;var b=a.getAttribute('src');var c=(b&&(b.match(this.opts.regex.youtube)||b.match(this.opts.regex.vimeo)));var d=this._wrapFigure(a);if(c){this._setFigure(d,'video')}},_convertCode:function(a){if(this._isNonEditable(a))return;var b=this._wrapFigure(a);this._setFigure(b,'code')},_convertWidget:function(a){if(this._isNonEditable(a))return;var b=H.dom(a);b.addClass('redactor-component');b.attr('data-redactor-type','widget');b.attr('data-widget-code',encodeURI(a.innerHTML.trim()))},_unconvertForm:function(a){this.utils.replaceToTag(a,'form')},_unconvertTable:function(a){var b=H.dom(a);b.unwrap()},_unconvertWidget:function(a){var b=H.dom(a);b.html(decodeURI(b.attr('data-widget-code')));b.removeAttr('data-widget-code')},_unconvertImages:function(a){var b=H.dom(a);b.removeClass('redactor-component');var c=(b.closest('li').length!==0);var d=(b.closest('table').length!==0);var e=(b.find('figcaption').length!==0);var f=b.attr('style');var g=!(f===null||f==='');var h=(b.attr('class')!=='');if(c||(d&&!e&&!g&&!h)){b.unwrap()}},_removeTypes:function(a){var b=H.dom(a);var c=b.attr('data-redactor-type');var d=['image','widget','line','video','code','form','table'];if(c&&d.indexOf(c)!==-1){b.removeAttr('data-redactor-type')}if(b.hasClass('redactor-keep-figure')){b.removeClass('redactor-keep-figure')}else if(this.opts.imageFigure===false){var e=(b.find('figcaption').length!==0);if(!e){b.unwrap()}}},_wrapFigure:function(a){var b=H.dom(a);var c=b.closest('figure');return(c.length===0)?b.wrap('<figure>'):c},_setFigure:function(a,b){a.addClass('redactor-component');a.attr('data-redactor-type',b)},_setContenteditableCode:function(a){if(this._isNonEditable(a))return;var b=H.dom(a);var c=b.children('code').first();var d=(c.length!==0)?c:b;d.attr('contenteditable',true).attr('tabindex','-1')},_acceptExtraRules:function(a,b){for(var c in b){if(typeof b[c]==='function'){b[c](a)}}},_isNonEditable:function(a){return(H.dom(a).closest('.non-editable').length!==0)}});H.add('class','cleaner.paragraphize',{init:function(a){this.app=a;this.opts=a.opts;this.utils=a.utils;this.element=a.element;this.stored=[];this.remStart='#####replace';this.remEnd='#####';this.paragraphizeTags=['table','div','pre','form','ul','ol','h1','h2','h3','h4','h5','h6','dl','blockquote','figcaption','address','section','header','footer','aside','article','object','style','script','iframe','select','input','textarea','button','option','map','area','math','hr','fieldset','legend','hgroup','nav','figure','details','menu','summary','p']},convert:function(a){var b=this._isConverted(a);return(b===true)?this._convert(a):b},_convert:function(a){var b=(this.opts.breakline)?'sdivtag':this.opts.markup;a=this._storeTags(a);a=a.trim();if(this.opts.breakline){a=a.replace(new RegExp('\\n#####','gi'),'xnonbreakmarkerz#####');a=a.replace(new RegExp('#####\\n\\n','gi'),"#####\nxnonbreakmarkerz");a=a.replace(new RegExp('#####\\n','gi'),"#####xnonbreakmarkerz");a=a.replace(/<br\s?\/?>\n/gi,"<br>");a=a.replace(/\n/g,"<br>");a=a.replace(/xnonbreakmarkerz/gi,"\n")}else{a=a.replace(/[\n]+/g,"\n")}a=this._trimEmptyLines(a);a=(this.opts.breakline)?a:a.replace(/<br\s?\/?>\n/gi,"xbreakmarkerz\n");a=a.replace(/(?:\r\n|\r|\n)/g,"xparagraphmarkerz");a=a.replace(/xparagraphmarkerz/gi,"</"+b+">\n<"+b+">");a=(this.opts.breakline)?a:a.replace(/xbreakmarkerz/gi,"<br>");a='<'+b+'>'+a+'</'+b+'>';a=a.replace(new RegExp('<'+b+'>#####','gi'),'#####');a=a.replace(new RegExp('#####</'+b+'>','gi'),'#####');a=this._restoreTags(a);a=(this.opts.breakline)?a:a.replace(new RegExp('<'+b+'><br\\s?/?></'+b+'>','gi'),'<'+b+'></'+b+'>');a=a.replace(new RegExp('<sdivtag>','gi'),'<div data-redactor-tag="br">');a=a.replace(new RegExp('sdivtag','gi'),'div');return a},_storeTags:function(d){var e=this;var f=this.utils.buildWrapper(d);if(this.opts.breakline){f.find('p').each(function(a){var b=H.dom(a);var c=(b.closest('figure[data-redactor-type=widget],figure[data-redactor-type=form],.non-editable').length===0);if(c){b.append('<br><br>');b.unwrap()}})}f.find(this.paragraphizeTags.join(', ')).each(function(a,i){var b=document.createTextNode("\n"+e.remStart+i+e.remEnd+"\n");e.stored.push(a.outerHTML);a.parentNode.replaceChild(b,a)});return this.utils.getWrapperHtml(f)},_restoreTags:function(a){for(var i=0;i<this.stored.length;i++){this.stored[i]=this.stored[i].replace(/\$/g,'&#36;');a=a.replace(this.remStart+i+this.remEnd,this.stored[i])}return a},_trimEmptyLines:function(a){var b='';var c=a.split("\n");for(var i=0;i<c.length;i++){if(c[i].trim()!==''){b+=c[i]+"\n"}}return b.replace(/\n$/,'')},_isConverted:function(a){if(this._isDisabled(a))return a;else if(this._isEmptyHtml(a))return this.opts.emptyHtml;else return true},_isDisabled:function(){return(this.opts.paragraphize===false||this.element.isType('inline'))},_isEmptyHtml:function(a){return(a===''||a==='<p></p>'||a==='<div></div>')}});H.add('service','detector',{init:function(a){this.app=a;this.userAgent=navigator.userAgent.toLowerCase()},isWebkit:function(){return/webkit/.test(this.userAgent)},isFirefox:function(){return(this.userAgent.indexOf('firefox')>-1)},isIe:function(v){if(document.documentMode||/Edge/.test(navigator.userAgent))return'edge';var a;a=RegExp('msie'+(!isNaN(v)?('\\s'+v):''),'i').test(navigator.userAgent);if(!a)a=!!navigator.userAgent.match(/Trident.*rv[ :]*11\./);return a},isMobile:function(){return/(iPhone|iPod|Android)/.test(navigator.userAgent)},isDesktop:function(){return!/(iPhone|iPod|iPad|Android)/.test(navigator.userAgent)},isIpad:function(){return/iPad/.test(navigator.userAgent)}});H.add('service','offset',{init:function(a){this.app=a},get:function(a,b){var c={start:0,end:0,newline:false};var d=this.utils.getNode(a);if(!d)return false;var e=this.editor.isEditor(d);var f=(e)?true:this.selection.isIn(d);var g=this.selection.getRange();if(!e&&!f){c=false}else if(this.selection.is()&&f){var h=H.dom(g.startContainer);var i=(h.hasClass('redactor-component'))?g.startOffset:0;var j=g.cloneRange();j.selectNodeContents(d);j.setEnd(g.startContainer,g.startOffset);var k=this._getString(g,b);c.newline=(k.search(/^\n/)!==-1&&k.trim()==='');c.start=this._getString(j,b).length-i;c.end=c.start+k.length+i}return c},set:function(a,b){if(this._setComponentOffset(b))return;this.component.clearActive();var c=this.utils.getNode(b);if(!c)return;var d=this.size(c);var e=0,range=document.createRange();a.newline=(typeof a.newline==='undefined')?false:a.newline;a.end=(a.end>d)?d:a.end;range.setStart(c,0);range.collapse(true);var f=[c],foundStart=false,stop=false;while(!stop&&(c=f.pop())){if(c.nodeType==3){var g=e+c.length;var h=(c.nodeValue.search(/^\n/)!==-1&&c.nodeValue.trim()==='');if(!foundStart&&!this._isFigcaptionNext(c)&&(a.newline===false&&!h)&&a.start>=e&&a.start<=g){range.setStart(c,a.start-e);foundStart=true}if(foundStart&&a.end>=e&&a.end<=g){range.setEnd(c,a.end-e);stop=true}e=g}else{var i=c.childNodes.length;while(i--){f.push(c.childNodes[i])}}}this.selection.setRange(range)},size:function(a,b){var c=this.utils.getNode(a);if(c){var d=document.createRange();var e=d.cloneRange();e.selectNodeContents(c);return this._getString(e,b).length}return 0},_getString:function(a,b){var c=a.toString();c=(this.editor.isEmpty())?c.replace(/\uFEFF/g,''):c;c=(b)?c.trim():c;return c},_setComponentOffset:function(a){return(this.component.isNonEditable(a))?this.component.setActive(a):false},_isFigcaptionNext:function(a){var b=a.nextSibling;return(a.nodeValue.trim()===''&&b&&b.tagName==='FIGCAPTION')}});H.add('service','inspector',{init:function(a){this.app=a},parse:function(a){return H.create('inspector.parser',this.app,this,a)},isText:function(a){if(typeof a==='string'&&!/^\s*<(\w+|!)[^>]*>/.test(a)){return true}var b=H.dom(a).get();return(b&&b.nodeType===3)},isInlineTag:function(a,b){var c=this._extendTags(this.opts.inlineTags,b);return(this._isTag(a)&&c.indexOf(a.toLowerCase())!==-1)},isBlockTag:function(a,b){var c=this._extendTags(this.opts.blockTags,b);return(this._isTag(a)&&c.indexOf(a.toLowerCase())!==-1)},isTableCellTag:function(a){return(['td','th'].indexOf(a.toLowerCase())!==-1)},isHeadingTag:function(a){return(['h1','h2','h3','h4','h5','h6'].indexOf(a.toLowerCase())!==-1)},_isTag:function(a){return(a!==undefined&&a)},_extendTags:function(a,b){a=a.concat(a);if(b){for(var i=0;i<b.length;i++){a.push(b[i])}}return a}});H.add('class','inspector.parser',{init:function(a,b,c){this.app=a;this.uuid=a.uuid;this.opts=a.opts;this.utils=a.utils;this.editor=a.editor;this.selection=a.selection;this.inspector=b;this.el=c;this.$el=H.dom(this.el);this.node=this.$el.get();this.$component=this.$el.closest('.redactor-component','.redactor-in')},isEditor:function(){return(this.node===this.editor.getElement().get())},isInEditor:function(){return(this.$el.parents('.redactor-in-'+this.uuid).length!==0)},isComponent:function(){return(this.$component.length!==0)},isComponentType:function(a){return(this.getComponentType()===a)},isComponentActive:function(){return(this.isComponent()&&this.$component.hasClass('redactor-component-active'))},isComponentEditable:function(){var a=['code','table'];var b=this.getComponentType();return(this.isComponent()&&a.indexOf(b)!==-1)},isFigcaption:function(){return this.getFigcaption()},isPre:function(){return this.getPre()},isCode:function(){var a=this.$el.closest('code');var b=a.parent('pre');return(a.length!==0&&b.length===0)},isList:function(){return this.getList()},isFirstListItem:function(){return this._getLastOrFirstListItem('first')},isLastListItem:function(){return this._getLastOrFirstListItem('last')},isFirstTableCell:function(){return this._getLastOrFirstTableCell('first')},isLastTableCell:function(){return this._getLastOrFirstTableCell('last')},isTable:function(){return(this.isComponentType('table')||this.getTable())},isHeading:function(){return this.getHeading()},isBlockquote:function(){return this.getBlockquote()},isDl:function(){return this.getDl()},isParagraph:function(){return this.getParagraph()},isLink:function(){return this.getLink()},isFile:function(){return this.getFile()},isText:function(){return this.inspector.isText(this.el)},isInline:function(){var a=this.opts.inlineTags;return(this.isElement())?(a.indexOf(this.node.tagName.toLowerCase())!==-1):false},isBlock:function(){var a=this.opts.blockTags;return(this.isElement())?(a.indexOf(this.node.tagName.toLowerCase())!==-1):false},isElement:function(){return(this.node&&this.node.nodeType&&this.node.nodeType!==3)},hasParent:function(a){return(this.$el.closest(a.join(',')).length!==0)},getNode:function(){return this.node},getTag:function(){return(this.isElement())?this.node.tagName.toLowerCase():false},getComponent:function(){return(this.isComponent())?this.$component.get():false},getComponentType:function(){return(this.isComponent())?this.$component.attr('data-redactor-type'):false},getFirstNode:function(){return this.utils.getFirstNode(this.node)},getLastNode:function(){return this.utils.getLastNode(this.node)},getFirstElement:function(){return this.utils.getFirstElement(this.node)},getLastElement:function(){return this.utils.getLastElement(this.node)},getFigcaption:function(){return this._getClosestNode('figcaption')},getPre:function(){return this._getClosestNode('pre')},getCode:function(){return this._getClosestNode('code')},getList:function(){return this._getClosestNode('ul, ol')},getParentList:function(){return this._getClosestUpNode('ul, ol')},getListItem:function(){return this._getClosestNode('li')},getTable:function(){if(this.getComponentType('table')){return this.$component.find('table').get()}else{return this._getClosestNode('table')}},getTableCell:function(){var a=this.$el.closest('td, th');return(a.length!==0)?a.get():false},getComponentCodeElement:function(){return(this.isComponentType('code'))?this.$component.find('pre code, pre').last().get():false},getImageElement:function(){return(this.isComponentType('image'))?this.$component.find('img').get():false},getParagraph:function(){return this._getClosestNode('p')},getHeading:function(){return this._getClosestNode('h1, h2, h3, h4, h5, h6')},getDl:function(){return this._getClosestNode('dl')},getBlockquote:function(){return this._getClosestNode('blockquote')},getLink:function(){var a=(this.isComponent()&&!this.isFigcaption());var b=this.isComponentType('table');if(b||!a){var c=this._getClosestElement('a');return(c&&!c.attr('data-file'))?c.get():false}return false},getFile:function(){var a=this.isComponent();var b=this.isComponentType('table');if(b||!a){var c=this._getClosestElement('a');return(c&&c.attr('data-file'))?c.get():false}return false},findFirstNode:function(a){return this.$el.find(a).first().get()},findLastNode:function(a){return this.$el.find(a).last().get()},_getLastOrFirstListItem:function(a){var b=this.getList();var c=this.getTag();if(b&&c==='li'){var d=H.dom(b).find('li')[a]().get();if(d&&this.node===d){return true}}return false},_getLastOrFirstTableCell:function(a){var b=this.getTable();var c=this.getTag();if(b&&(c==='td'||c==='th')){var d=H.dom(b).find('td, th')[a]().get();if(d&&this.node===d){return true}}return false},_getClosestUpNode:function(a){var b=this.$el.parents(a,'.redactor-in').last();return(b.length!==0)?b.get():false},_getClosestNode:function(a){var b=this.$el.closest(a,'.redactor-in');return(b.length!==0)?b.get():false},_getClosestElement:function(a){var b=this.$el.closest(a,'.redactor-in');return(b.length!==0)?b:false}});H.add('service','marker',{init:function(a){this.app=a},build:function(a,b){var c=document.createElement('span');c.id='selection-marker-'+this._getPos(a);c.className='redactor-selection-marker';c.innerHTML=this.opts.markerChar;return(b)?c.outerHTML:c},buildHtml:function(a){return this.build(a,true)},insert:function(a){this.remove();var b=(a!=='both'&&(a==='start'||this.selection.isCollapsed()));if(!this.selection.is())this.editor.focus();var c=this.selection.getRange();if(c){var d=this.build('start');var e=this.build('end');var f=c.cloneRange();if(!b){f.collapse(false);f.insertNode(e)}f.setStart(c.startContainer,c.startOffset);f.collapse(true);f.insertNode(d);c.setStartAfter(d);if(!b){c.setEndBefore(e)}this.selection.setRange(c);return d}},find:function(a,b){var c=this.editor.getElement();var d=(b||c).find('span#selection-marker-'+this._getPos(a));return(d.length!==0)?d.get():false},restore:function(){var a=this.find('start');var b=this.find('end');var c=this.selection.getRange();if(!c||!this.selection.is()){this.editor.focus();c=document.createRange()}if(a){var d=(b)?b.previousSibling:false;var e=a.nextSibling;e=(e&&e.nodeType===3&&e.textContent.replace(/[\n\t]/g,'')==='')?false:e;if(!b){if(e){c.selectNodeContents(e);c.collapse(true)}else{this._restoreInject(c,a)}}else if(e&&e.id==='selection-marker-end'){this._restoreInject(c,a)}else{if(d&&e){c.selectNodeContents(d);c.collapse(false);c.setStart(e,0)}else if(d&&!e){c.selectNodeContents(d);c.collapse(false);c.setStartAfter(a)}else{c.setStartAfter(a);c.setEndBefore(b)}}this.selection.setRange(c);if(a)a.parentNode.removeChild(a);if(b)b.parentNode.removeChild(b)}},remove:function(){var a=this.find('start');var b=this.find('end');if(a)a.parentNode.removeChild(a);if(b)b.parentNode.removeChild(b)},_getPos:function(a){return(a===undefined)?'start':a},_restoreInject:function(a,b){var c=this.utils.createInvisibleChar();H.dom(b).after(c);a.selectNodeContents(c);a.collapse(false)}});H.add('service','component',{init:function(a){this.app=a;this.activeClass='redactor-component-active'},create:function(a,b){return H.create(a+'.component',this.app,b)},build:function(a){var b=H.dom(a);var c;var d=b.attr('data-redactor-type');if(d){c=this.create(d,a)}return(c)?c:a},remove:function(a,b){var c=H.dom(a).closest('.redactor-component');var d=c.attr('data-redactor-type');var e=c.parent();var f=this.inspector.parse(e);var g=this.utils.findSiblings(c,'prev');var h=this.utils.findSiblings(c,'next');var i=this.app.broadcast(d+'.delete',c);if(i!==false){c.remove();this.app.broadcast(d+'.deleted',c);this.app.broadcast('contextbar.close');this.app.broadcast('imageresizer.stop');if(b!==false){var j=f.getTableCell();if(j&&this.utils.isEmptyHtml(j.innerHTML)){this.caret.setStart(j)}else if(h)this.caret.setStart(h);else if(g)this.caret.setEnd(g);else{this.editor.startFocus()}}if(this.editor.isEmpty()){this.editor.setEmpty();this.editor.startFocus();this.app.broadcast('empty')}}},isNonEditable:function(a){var b=this.inspector.parse(a);return(b.isComponent()&&!b.isComponentEditable())},isActive:function(a){var b;if(a){var c=this.inspector.parse(a);b=H.dom(c.getComponent());return b.hasClass(this.activeClass)}else{b=this._find();return(b.length!==0)}},getActive:function(a){var b=this._find();return(b.length!==0)?((a)?b:b.get()):false},setActive:function(a){this.clearActive();this.editor.focus();var b=this.inspector.parse(a);var c=b.getComponent();var d=H.dom(c);if(!b.isFigcaption()){var e=d.find('.redactor-component-caret');if(e.length===0){e=this._buildCaret();d.prepend(e)}this.caret.setAtStart(e.get())}d.addClass(this.activeClass)},clearActive:function(){var a=this._find();a.removeClass(this.activeClass);a.find('.redactor-component-caret').remove();this.app.broadcast('imageresizer.stop')},setOnEvent:function(e,a){this.clearActive();var b=this.inspector.parse(e.target);if(b.isFigcaption()||b.isComponentEditable()){return}if(b.isComponent()){this.setActive(e.target);if(a!==true)e.preventDefault()}},executeScripts:function(){var a=this.editor.getElement();var b=a.find('[data-redactor-type]').find("script").getAll();for(var i=0;i<b.length;i++){if(b[i].src!==''){var c=b[i].src;this.$doc.find('head script[src="'+c+'"]').remove();var d=H.dom('<script>');d.attr('src',c);d.attr('async defer');if(c.search('instagram')!==-1)d.attr('onload','window.instgrm.Embeds.process()');var e=document.getElementsByTagName('head')[0];if(e)e.appendChild(d.get())}else{eval(b[i].innerHTML)}}},_find:function(){return this.editor.getElement().find('.'+this.activeClass)},_buildCaret:function(){var a=H.dom('<span>');a.addClass('redactor-component-caret');a.attr('contenteditable',true);return a}});H.add('service','insertion',{init:function(a){this.app=a},set:function(a,b,c){a=(b!==false)?this.cleaner.input(a):a;a=(b!==false)?this.cleaner.paragraphize(a):a;var d=this.editor.getElement();d.html(a);if(c!==false)this.editor.endFocus();return a},insertNode:function(a,b){this.editor.focus();var c=(this.utils.isFragment(a))?a:this.utils.createFragment(a);this._collapseSelection();this._insertFragment(c);this._setCaret(b,c);return this._sendNodes(c.nodes)},insertBreakLine:function(){return this.insertNode(document.createElement('br'),'after')},insertNewline:function(){return this.insertNode(document.createTextNode('\n'),'after')},insertText:function(a){return this.insertHtml(this.cleaner.getFlatText(a))},insertChar:function(a){return this.insertNode(a,'after')},insertRaw:function(a){return this.insertHtml(a,false)},insertToEnd:function(a,b){if(!a)return;if(a.nodeType===3&&a.nodeValue.search(/^\n/)!==-1){a=a.previousElementSibling}var c=H.dom(a);if(c.attr('data-redactor-type')===b){var d=(this.opts.breakline)?'<br>':'<p>';var e=H.dom(d);c.after(e);this.caret.setStart(e)}},insertPoint:function(e){var a,data;var b=this.marker.build('start');var c=false;var x=e.clientX,y=e.clientY;if(document.caretPositionFromPoint){var d=document.caretPositionFromPoint(x,y);var f=document.getSelection();data=this.inspector.parse(d.offsetNode);if(data.isInEditor()){a=f.getRangeAt(0);a.setStart(d.offsetNode,d.offset);a.collapse(true);a.insertNode(b);c=true}}else if(document.caretRangeFromPoint){a=document.caretRangeFromPoint(x,y);data=this.inspector.parse(a.startContainer);if(data.isInEditor()){a.insertNode(b);c=true}}return c},insertToPoint:function(e,a,b){var c=(b===true)?true:this.insertPoint(e);if(!c){var d=this.editor.getLastNode();H.dom(d).after(this.marker.build('start'))}this.component.clearActive();this.selection.restoreMarkers();return this.insertHtml(a)},insertToOffset:function(a,b){this.offset.set({start:a,end:a});return this.insertHtml(b)},insertHtml:function(a,b){if(!this.opts.input)return;var c=this.utils.parseHtml(a);if(this.selection.isAll()){return this._insertToAllSelected(c)}if(!this.selection.is()){var d=H.dom('<p>');var e=this.editor.getElement();e.append(d);this.caret.setStart(d)}var f=this.selection.isCollapsed();var g=this.selection.isText();var h=this.selection.getCurrent();var i=this.inspector.parse(h);this._collapseSelection();c=this._getCleanedInput(c,i,b);var j=this._isFigure(c.html);var k=this._isComponentSpan(c.html);var l=this.inspector.isText(c.html);var m,except;if(this.editor.isEmpty()){return this._insertToEmptyEditor(c.html)}else if(i.isComponent()&&!i.isComponentEditable()){return this._insertToWidget(h,i,c.html)}else if(k){return this.insertNode(c.nodes,'end')}else if(j&&!g&&!i.isList()){if(i.isInline()){return this._insertToInline(h,c)}m=this.utils.createFragment(c.html);this.utils.splitNode(h,m);this.caret.setEnd(m.last);return this._sendNodes(m.nodes)}else if(i.isCode()){return this._insertToCode(c,h,b)}else if(i.isPre()){return this._insertToPre(c,b)}else if(i.isHeading()||i.isFigcaption()){c.html=(b!==false)?this.cleaner.removeTagsExcept(c.html,['a']):c.html;c.html=(b!==false)?this.cleaner.replaceNbspToSpaces(c.html):c.html;m=this.utils.createFragment(c.html);return this.insertNode(m,'end')}else if(l){if(!g&&this.opts.markup!=='br'&&this._hasBlocksAndImages(c.nodes)){c.html=(b!==false)?this.cleaner.paragraphize(c.html):c.html;m=this.utils.createFragment(c.html);this.utils.splitNode(h,m);this.caret.setEnd(m.last);return this._sendNodes(m.nodes)}c.html=(b!==false)?c.html.replace(/\n/g,'<br>'):c.html;m=this.utils.createFragment(c.html);return this.insertNode(m.nodes,'end')}else if(!f&&!j){c.html=(b!==false)?this.cleaner.paragraphize(c.html):c.html;m=this.utils.createFragment(c.html);return this.insertNode(m,'end')}else if(i.isInline()&&!this._isPlainHtml(c.html)){return this._insertToInline(h,c)}else if(i.isBlockquote()||i.isDl()){except=this.opts.inlineTags;except.concat(['br']);c.html=(b!==false)?this.cleaner.replaceBlocksToBr(c.html):c.html;c.html=(b!==false)?this.cleaner.removeTagsExcept(c.html,except):c.html;m=this.utils.createFragment(c.html);return this.insertNode(m,'end')}else if(i.isParagraph()){if(this._isPlainHtml(c.html)){return this.insertNode(c.nodes,'end')}c.html=(b!==false)?this.cleaner.paragraphize(c.html):c.html;m=this.utils.createFragment(c.html);this.utils.splitNode(h,m);this.caret.setEnd(m.last);return this._sendNodes(m.nodes)}else if(i.isList()){except=this.opts.inlineTags;except=except.concat(['br','li','ul','ol','img']);c.html=(b!==false)?this.cleaner.replaceBlocksToBr(c.html):c.html;c.html=(b!==false)?this.cleaner.removeTagsExcept(c.html,except):c.html;c.html=(b!==false)?this.cleaner.removeBrAtEnd(c.html):c.html;m=this.utils.createFragment(c.html);c.nodes=m.nodes;if(this._containsTags(c.html,['ul','ol','li'])){var n=this.selection.getElement(h);if(n&&n.tagName==='LI'&&this.caret.isStart(n)){c.nodes=H.dom(m.nodes).unwrap('ul, ol').getAll();H.dom(n).before(c.nodes);var o=c.nodes[c.nodes.length-1];this.caret.setEnd(o);return this._sendNodes(c.nodes)}else if(this._isPlainHtml(c.html)){return this.insertNode(m,'end')}else{m=this._buildList(c,n,m);this.utils.splitNode(h,m,true);this.caret.setEnd(m.last);return this._sendNodes(m.nodes)}}}return this.insertNode(c.nodes,'end')},_insertToAllSelected:function(a){var b=this.set(a.html);var c=this.utils.parseHtml(b);return this._sendNodes(c.nodes)},_insertToEmptyEditor:function(a){a=this.cleaner.paragraphize(a);var b=this.utils.createFragment(a);var c=this.editor.getElement();c.html('');c.append(b.frag);this.caret.setEnd(c);return this._sendNodes(b.nodes)},_insertToInline:function(a,b){var c=this.utils.createFragment(b.html);this.utils.splitNode(a,c,false,true);this.caret.setEnd(c.last);return this._sendNodes(c.nodes)},_insertToCode:function(a,b,c){a.html=(c!==false)?this.cleaner.encodeHtml(a.html):a.html;a.html=(c!==false)?this.cleaner.removeNl(a.html):a.html;var d=this.utils.createFragment(a.html);var e=this.insertNode(d,'end');this.utils.normalizeTextNodes(b);return e},_insertToPre:function(a,b){a.html=(b!==false)?this.cleaner.encodeHtml(a.html):a.html;var c=this.utils.createFragment(a.html);return this.insertNode(c,'end')},_insertToWidget:function(a,b,c){c=(this._isComponentSpan(c))?c:this.cleaner.paragraphize(c);var d=this.utils.createFragment(c);var e=b.getComponent();var f=H.dom(e);f.after(d.frag);f.remove();this.caret.setEnd(d.last);return this._sendNodes(d.nodes)},_insertFragment:function(a){var b=this.selection.getRange();if(b){if(this.selection.isCollapsed()){var c=b.startContainer;if(c.nodeType!==3&&c.tagName==='BR'){this.caret.setAfter(c);c.parentNode.removeChild(c)}}else{b.deleteContents()}b.insertNode(a.frag)}},_sendNodes:function(a){for(var i=0;i<a.length;i++){var b=a[i];var c=(b.nodeType!==3&&typeof b.getAttribute==='function')?b.getAttribute('data-redactor-type'):false;if(c){this.app.broadcast(c+'.inserted',this.component.build(b))}}this.app.broadcast('inserted',a);this.component.executeScripts();return a},_setCaret:function(a,b){var c=this._isLastInline(b);if(a){a=(c&&a==='end')?'after':a;this.caret['set'+this.utils.ucfirst(a)](b.last)}else if(a!==false){if(c)this.caret.setAfter(b.last)}},_isLastInline:function(a){if(a.last){var b=this.inspector.parse(a.last);return b.isInline()}return false},_getCleanedInput:function(a,b,c){var d=(b.isCode()||b.isPre());a.html=(!d&&c!==false)?this.cleaner.input(a.html):a.html;a=(!d&&c!==false)?this.utils.parseHtml(a.html):a;return a},_getContainer:function(a){return H.dom(this.utils.createTmpContainer(a))},_buildList:function(a,b,c){var d=a.nodes;var e=d[0];if(e&&e.nodeType!==3&&e.tagName==='li'){var f=H.dom(b);var g=f.get().tagName.toLowerCase();var h=H.dom('<'+g+' />');h.append(c.nodes);return this.utils.createFragment(h.get().outerHTML)}return c},_containsTags:function(a,b){return(this._getContainer(a).find(b.join(',')).length!==0)},_collapseSelection:function(){},_hasFigureOrTable:function(a){return(this._getContainer(a).find('figure, table').length!==0)},_hasBlocks:function(a){return(this._getContainer(a).find(this.opts.blockTags.join(',')).length!==0)},_hasBlocksAndImages:function(a){return(this._getContainer(a).find(this.opts.blockTags.join(',')+',img').length!==0)},_isPlainHtml:function(a){return(this._getContainer(a).find(this.opts.blockTags.join(',')+', img').length===0)},_isFigure:function(a){if(this._isHtmlString(a)){return(H.dom(a).closest('figure').length!==0)}},_isComponentSpan:function(a){if(this._isHtmlString(a)){return(H.dom(a).closest('span.redactor-component').length!==0)}},_isHtmlString:function(a){return!(typeof a==='string'&&!/^\s*<(\w+|!)[^>]*>/.test(a))}});H.add('service','block',{mixins:['formatter'],init:function(a){this.app=a},format:function(a){this.type=(a.type)?a.type:'set';this.tag=(typeof a==='string')?a:a.tag;this.tag=this._prepareTag(this.tag);this.tag=this.tag.toLowerCase();if(typeof a==='string')this.args=false;else this.buildArgs(a);return this._format()},getBlocks:function(a){return this.selection.getBlocks({tags:a||this._getTags(),first:true})},getElements:function(a){var b=this.selection.getBlock();if(!this.selection.isCollapsed()&&b&&(b.tagName==='TD'||b.tagName==='TH')){return this._wrapInsideTable('div')}else{return H.dom(this.getBlocks(a))}},clearFormat:function(b){this.selection.save();var c=this.getElements(b||this._getTags());c.each(function(a){while(a.attributes.length>0){a.removeAttribute(a.attributes[0].name)}});this.selection.restore();return c.getAll()},_format:function(){this.selection.save();var a=this.getBlocks();var b=this.selection.getBlock();var c=[];var d,replacedTag,f,g;if(a.length===1&&a[0].tagName==='DIV'){d=this._getTextNodesData();if(!d||d.nodes.length===0){c=this._replaceBlocks(a);c=this._sendNodes(c);setTimeout(function(){this.selection.restore()}.bind(this),0);return c}replacedTag=this._getReplacedTag('set');f=H.dom('<'+replacedTag+'>');g=d.last.nextSibling;if(g&&g.tagName==='BR'){H.dom(g).remove()}for(var i=0;i<d.nodes.length;i++){f.append(d.nodes[i])}this.utils.splitNode(a[0],[f.get()]);c=this._sendNodes([f.get()]);if(this.utils.isEmptyHtml(f.html())){this.caret.setStart(f)}else{setTimeout(function(){this.selection.restore()}.bind(this),0)}return c}else if(a.length>0){c=this._replaceBlocks(a);c=this._sendNodes(c);setTimeout(function(){this.selection.restore()}.bind(this),0);return c}else if(!this.selection.isCollapsed()&&b&&(b.tagName==='TD'||b.tagName==='TH')){replacedTag=this._getReplacedTag('set');f=this._wrapInsideTable(replacedTag);this.selection.setAll(f);return this._sendNodes([f.get()])}else if(this.selection.isCollapsed()&&b&&(b.tagName==='TD'||b.tagName==='TH')){var e=this._getChildTextNodes(b);replacedTag=this._getReplacedTag('set');var f=H.dom('<'+replacedTag+'>');H.dom(e.first).before(f);for(var i=0;i<e.nodes.length;i++){f.append(e.nodes[i])}var g=f.get().nextSibling;if(g&&g.tagName==='BR'){H.dom(g).remove()}return this._sendNodes([f.get()])}return c},_wrapInsideTable:function(a){var b=this._getTextNodesData();var c=H.dom('<'+a+'>');H.dom(b.first).before(c);for(var i=0;i<b.nodes.length;i++){c.append(b.nodes[i])}var d=c.get().nextSibling;if(d&&d.tagName==='BR'){H.dom(d).remove()}return c},_prepareTag:function(a){return(typeof a==='undefined')?this.opts.markup:a},_sendNodes:function(a){if(a.length>0){a=this.applyArgs(a,false);a=this._combinePre(a);a=this._cleanBlocks(a)}return a},_getTags:function(){return['div','p','blockquote','pre','h1','h2','h3','h4','h5','h6']},_replaceBlocks:function(a){var b=[];var c=(this._isToggleFormatType(a))?'toggle':'set';var d=this._getReplacedTag(c);for(var i=0;i<a.length;i++){var e=this.utils.replaceToTag(a[i],d);b.push(e.get())}return b},_getReplacedTag:function(a){var b=(a==='toggle')?this.opts.markup:this.tag;return(this.opts.breakline&&b==='p')?'div':b},_getChildTextNodes:function(a){var b=a.childNodes;var c=b[0];var d=[];for(var i=0;i<=b.length;i++){var e=b[i];if(e&&e.nodeType!==3&&this.inspector.isBlockTag(e.tagName)){break}d.push(e)}return{nodes:d,first:c}},_getTextNodesData:function(){var a=this.selection.getNodes({textnodes:true,keepbr:true});if(a.length===0)return false;var b=a[0];var c=a[a.length-1];var d=c;var e=false;while(!e){var f=this.selection.getInline(d);d=(f)?f.nextSibling:d.nextSibling;if(!d){e=true}else if(d.nodeType!==3&&(d.tagName==='BR'||this.inspector.isBlockTag(d.tagName))){e=true}else{a.push(d)}}return{nodes:a,first:b,last:c}},_isToggleFormatType:function(a){var b=0;var c=a.length;for(var i=0;i<c;i++){if(a[i]&&this.tag===a[i].tagName.toLowerCase())b++}return(b===c)},_combinePre:function(a){var b=[];for(var i=0;i<a.length;i++){var c=a[i].nextElementSibling;if(c&&a[i].tagName==='PRE'&&c.tagName==='PRE'){var d=H.dom(a[i]);var e=H.dom(c);var f=document.createTextNode('\n');d.append(f);d.append(e);e.unwrap('pre')}b.push(a[i])}return b},_cleanBlocks:function(a){var b=['h1','h2','h3','h4','h5','h6'];var c=this.opts.inlineTags;for(var i=0;i<a.length;i++){var d=a[i].tagName.toLowerCase();var e=H.dom(a[i]);if(b.indexOf(d)!==-1){e.find('span').not('.redactor-component, .non-editable, .redactor-selection-marker').unwrap()}else if(d==='pre'){e.find(c.join(',')).not('.redactor-selection-marker').unwrap()}if(this.opts.breakline&&d==='div'){e.attr('data-redactor-tag','br')}else{e.removeAttr('data-redactor-tag')}this.utils.normalizeTextNodes(a[i])}return a}});H.add('service','inline',{mixins:['formatter'],init:function(a){this.app=a},format:function(a){if(!this._isFormat())return[];this.type=(a.type)?a.type:'set';this.tag=(typeof a==='string')?a:a.tag;this.tag=this.tag.toLowerCase();this.tag=this.arrangeTag(this.tag);if(typeof a==='string')this.args=false;else this.buildArgs(a);var b=(this.selection.isCollapsed())?this.formatCollapsed():this.formatUncollapsed();return b},_isFormat:function(){var a=this.selection.getCurrent();var b=this.inspector.parse(a);var c=(b.isComponent()&&!b.isComponentType('table')&&!b.isFigcaption());if(!a||b.isPre()||b.isCode()||c){return false}return true},arrangeTag:function(a){var b=this.opts.replaceTags;for(var c in b){if(a===c)a=b[c]}return a},formatCollapsed:function(){var a=[];var b=this.selection.getInlineFirst();var c=this.selection.getInlines({all:true});var d=H.dom(b);var e,parent,$secondPart,extractedContent;if(!b){a=this.insertInline(a)}else{var f=this.inspector.parse(b);var g=this.utils.isEmptyHtml(b.innerHTML);if(g){if(b.tagName.toLowerCase()===this.tag){if(this.hasSameArgs(b)){this.caret.setAfter(b);d.remove();var h=this.selection.getElement();this.utils.normalizeTextNodes(h)}else if(this.tag==='span'){a=this.applyArgs([b],false);this.caret.setStart(b)}else{a=this.insertInline(a)}}else{if(f.hasParent([this.tag])){e=d.closest(this.tag);parent=e.get();if(this.hasSameArgs(parent)){e.unwrap();this.caret.setStart(b)}else{a=this.insertInline(a)}}else{a=this.insertInline(a)}}}else{if(b.tagName.toLowerCase()===this.tag){if(this.hasSameArgs(b)){extractedContent=this.utils.extractHtmlFromCaret(b);$secondPart=H.dom('<'+this.tag+' />');$secondPart=this.utils.cloneAttributes(b,$secondPart);d.after($secondPart.append(extractedContent));this.caret.setAfter(b)}else{a=this.insertInline(a)}}else{if(f.hasParent([this.tag])){e=d.closest(this.tag);parent=e.get();if(this.hasSameArgs(parent)){extractedContent=this.utils.extractHtmlFromCaret(parent,parent);$secondPart=H.dom('<'+this.tag+' />');$secondPart=this.utils.cloneAttributes(parent,$secondPart);var j,$last;var z=0;c=c.reverse();for(var i=0;i<c.length;i++){if(c[i]!==parent){$last=H.dom('<'+c[i].tagName.toLowerCase()+'>');if(z===0){j=$last}else{j.append($last)}z++}}e.after($secondPart.append(extractedContent));e.after(j);this.caret.setStart($last)}else{a=this.insertInline(a)}}else{a=this.insertInline(a)}}}}return a},insertInline:function(a){var b=document.createElement(this.tag);a=this.insertion.insertNode(b,'start');return this.applyArgs(a,false)},hasSameArgs:function(a){if(a.attributes.length===0&&this.args===false){return true}else{var b=true;if(this.args){var c=0;for(var d in this.args){var e=H.dom(a);var f=(this.args[d]);var g=this.utils.toParams(f);var h=e.attr(d);if(f){if(d==='style'){g=g.trim().replace(/;$/,'');var j=this.utils.styleToObj(e.attr('style'));var k=g.split(';');var l=0;for(var i=0;i<k.length;i++){var m=k[i].split(':');var n=m[0].trim();var o=m[1].trim();if(n.search(/color/)!==-1){var p=e.css(n);if(p&&(p===o||this.utils.rgb2hex(p)===o)){l++}}else if(e.css(n)===o){l++}}if(l===k.length&&Object.keys(j).length===k.length){c++}}else{if(h===g){c++}}}else{if(!h||h===''){c++}}}b=(c===Object.keys(this.args).length)}return b}},formatUncollapsed:function(){var a=this.selection.getInlines({all:true,inside:true});this.selection.save();this._convertTags('u');this._convertTags('del');this._convertToStrike(a);this.selection.restore();document.execCommand('strikethrough');this._clearDecoration();this.selection.save();var b=this._revertToInlines();b=this.applyArgs(b,false);for(var i=0;i<b.length;i++){var c=b[i];var d=c.tagName.toLowerCase();var e=c.attributes.length;if(d===this.tag&&e===0&&this.args){H.dom(c).unwrap();b.splice(i,1)}}this.selection.restore();this._clearEmptyStyle();b=this._normalizeBlocks(b);return b},_convertTags:function(c){if(this.tag!==c){var d=this.editor.getElement();d.find(c).each(function(a){var b=this.utils.replaceToTag(a,'span');b.addClass('redactor-convertable-'+c)}.bind(this))}},_revertTags:function(c){var d=this.editor.getElement();d.find('span.redactor-convertable-'+c).each(function(a){var b=this.utils.replaceToTag(a,c);b.removeClass('redactor-convertable-'+c);if(this.utils.removeEmptyAttr(b,'class'))b.removeAttr('class')}.bind(this))},_convertToStrike:function(a){var b=this.selection.getText().replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");for(var i=0;i<a.length;i++){var c=this.arrangeTag(a[i].tagName.toLowerCase());var d=a[i];var e=H.dom(d);var f=this.hasSameArgs(d);if(c===this.tag){if(this.tag==='span'&&this._isTextSelected(d,b)){e.addClass('redactor-convertable-apply')}else if(f){this._replaceToStrike(e)}else if(this.tag==='span'){e.addClass('redactor-unconvertable-apply')}else if(!f){e.addClass('redactor-convertable-apply')}}}},_replaceToStrike:function(a){a.replaceWith(function(){return H.dom('<strike>').append(a.contents())})},_revertToInlines:function(){var c=[];var d=this.editor.getElement();if(this.tag!=='u')d.find('u').unwrap();d.find('.redactor-convertable-apply').each(function(a){var b=H.dom(a);b.find('strike').unwrap();this._forceRemoveClass(b,'redactor-convertable-apply');c.push(a)}.bind(this));d.find('span.redactor-unconvertable-apply').each(function(a){var b=H.dom(a);this._forceRemoveClass(b,'redactor-unconvertable-apply')}.bind(this));d.find('strike').each(function(a){var b=this.utils.replaceToTag(a,this.tag);c.push(b.get())}.bind(this));this._revertTags('u');this._revertTags('del');return c},_normalizeBlocks:function(b){var c=this.opts.inlineTags;var d=this.selection.getBlocks();if(d){for(var i=0;i<d.length;i++){if(d[i].tagName==='PRE'){var e=H.dom(d[i]);e.find(c.join(',')).not('.redactor-selection-marker').each(function(a){if(b.indexOf(a)!==-1){b=this.utils.removeFromArrayByValue(b,a)}H.dom(a).unwrap()}.bind(this))}}}return b},_clearDecoration:function(){var c=this.editor.getElement();c.find(this.opts.inlineTags.join(',')).each(function(a){if(a.style.textDecoration==='line-through'||a.style.textDecorationLine==='line-through'){var b=H.dom(a);b.css('textDecorationLine','');b.css('textDecoration','');b.wrap('<strike>')}})},_clearEmptyStyle:function(){var a=this.getInlines();for(var i=0;i<a.length;i++){this._clearEmptyStyleAttr(a[i]);var b=a[i].childNodes;if(b){for(var z=0;z<b.length;z++){this._clearEmptyStyleAttr(b[z])}}}},_clearEmptyStyleAttr:function(a){if(a.nodeType!==3&&this.utils.removeEmptyAttr(a,'style')){a.removeAttribute('style');a.removeAttribute('data-redactor-style-cache')}},_forceRemoveClass:function(a,b){a.removeClass(b);if(this.utils.removeEmptyAttr(a,'class'))a.removeAttr('class')},_isTextSelected:function(a,b){var c=this.utils.removeInvisibleChars(a.textContent);return(b===c||b.search(new RegExp('^'+this.utils.escapeRegExp(c)+'$'))!==-1)},getInlines:function(a){return(a)?this.selection.getInlines({tags:a,all:true}):this.selection.getInlines({all:true})},getElements:function(a){return H.dom(this.getInlines(a))},clearFormat:function(){this.selection.save();var a=this.selection.getInlines({all:true});for(var i=0;i<a.length;i++){var b=H.dom(a[i]);var c=this.selection.getInline(a[i]);if(c){b.unwrap()}}this.selection.restore()}});H.add('service','autoparser',{init:function(a){this.app=a},observe:function(){var e=this.editor.getElement();var f=e.find('.redactor-autoparser-object').each(function(a){var b=H.dom(a);b.removeClass('redactor-autoparser-object');if(b.attr('class')==='')b.removeAttr('class')});if(f.length>0){f.each(function(a){var b;var c=false;var d=a.tagName;if(d==='A')b='link';else if(d==='IMG')b='image';else if(d==='IFRAME')b='video';if(b){c=H.create(b+'.component',this.app,a);this.app.broadcast(b+'.inserted',c);this.app.broadcast('autoparse',b,c)}}.bind(this))}},format:function(e,a){if(this._isKey(a)){this._format(a===this.keycodes.ENTER)}},parse:function(a){var b=['figure','pre','iframe','code','a','img'];var c=[];var z=0;a=this.cleaner.encodePreCode(a);for(var i=0;i<b.length;i++){var d=(b[i]==='img')?'<'+b[i]+'[^>]*>':'<'+b[i]+'([\\w\\W]*?)</'+b[i]+'>';var e=a.match(new RegExp(d,'gi'));if(e!==null){for(var y=0;y<e.length;y++){a=a.replace(e[y],'#####replaceparse'+z+'#####');c.push(e[y]);z++}}}if(this.opts.autoparseImages&&a.match(this.opts.regex.imageurl)){var f=a.match(this.opts.regex.imageurl);for(var i=0;i<f.length;i++){a=a.replace(f[i],'<img class="redactor-autoparser-object" src="'+f[i]+'">')}}if(this.opts.autoparseVideo&&(a.match(this.opts.regex.youtube)||a.match(this.opts.regex.vimeo))){var g='<iframe width="500" height="281" src="';var h='" frameborder="0" allowfullscreen></iframe>';var j,re;if(a.match(this.opts.regex.youtube)){j='//www.youtube.com/embed/$1';re=this.opts.regex.youtube}else if(a.match(this.opts.regex.vimeo)){j='//player.vimeo.com/video/$2';re=this.opts.regex.vimeo}var k=this.component.create('video',g+j+h);a=a.replace(re,k.get().outerHTML)}if(this.opts.autoparseLinks&&a.match(this.opts.regex.url)){a=this._formatLinks(a)}a=this._restoreReplaced(c,a);a=this._restoreReplaced(c,a);return a},_isKey:function(a){return(a===this.keycodes.ENTER||a===this.keycodes.SPACE)},_format:function(a){var b=this.selection.getParent();var c=H.dom(b);var d=(b&&c.closest('figure, pre, code, img, a, iframe').length!==0);if(d||!this.selection.isCollapsed()){return}var e=this.utils.createInvisibleChar();var f=this.selection.getRange();f.insertNode(e);var g=this.selection.getCurrent();var h=this.inspector.parse(g);var i=H.dom(g);e.parentNode.removeChild(e);if(g&&g.nodeType===3){var j=g.textContent;var k;if(this.opts.autoparseImages&&j.match(this._convertToRegExp(this.opts.regex.imageurl))){var l=h.isList();var m=j.match(this.opts.regex.imageurl);var n=(l)?undefined:'<figure><img></figure>';var o=this.component.create('image',n);o.setSrc(m[0]);o.addClass('redactor-autoparser-object');j=j.replace(m[0],o.get().outerHTML);k='image'}else if(this.opts.autoparseVideo&&(j.match(this._convertToRegExp(this.opts.regex.youtube))||j.match(this._convertToRegExp(this.opts.regex.vimeo)))){var p='<iframe width="500" height="281" src="';var q='" frameborder="0" allowfullscreen></iframe>';var r,re;if(j.match(this.opts.regex.youtube)){r='//www.youtube.com/embed/$1';re=this.opts.regex.youtube}else if(j.match(this.opts.regex.vimeo)){r='//player.vimeo.com/video/$2';re=this.opts.regex.vimeo}var s=this.component.create('video',p+r+q);s.addClass('redactor-autoparser-object');j=j.replace(re,s.get().outerHTML);k='video'}else if(this.opts.autoparseLinks&&j.match(this._convertToRegExp(this.opts.regex.url))){j=this._formatLinks(j,a);k='link'}if(k){if(a){this.selection.save();i.replaceWith(j);this.selection.restore()}else{i.replaceWith(j)}var t=this.editor.getElement();var u=t.find('.redactor-autoparser-object').removeClass('redactor-autoparser-object');u=(k==='link')?H.create('link.component',this.app,u):u;if(k==='link'){if(!a)this.caret.setAfter(u);this.app.broadcast('link.inserted',u)}else{this.caret.setAfter(u);var v=u.clone();u.remove();u=this.insertion.insertHtml(v);u=this.component.build(u)}this.app.broadcast('autoparse',k,u)}}},_formatLinks:function(a,b){var c=a.match(this.opts.regex.url);var d={};for(var i=0;i<c.length;i++){if(b&&c[i].search(/\.$/)!==-1){c[i]=c[i].replace(/\.$/,'')}var e=c[i],text=e;var f=(e.match(/(https?|ftp):\/\//i)!==null)?'':'http://';var g=(["/","&","="].indexOf(e.slice(-1))!==-1)?"":"\\b";var h=(this.opts.pasteLinkTarget!==false)?' target="'+this.opts.pasteLinkTarget+'"':'';text=(text.length>this.opts.linkSize)?text.substring(0,this.opts.linkSize)+'...':text;text=(text.search('%')===-1)?decodeURIComponent(text):text;var j='('+e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+g+')';var k=' class="redactor-autoparser-object"';d[j]='<a href="'+f+e.trim()+'"'+h+k+'>'+text.trim()+'</a>'}for(var l in d){a=a.replace(new RegExp(l,'g'),d[l])}return a},_restoreReplaced:function(a,b){for(var i=0;i<a.length;i++){b=b.replace('#####replaceparse'+i+'#####',a[i])}return b},_convertToRegExp:function(a){return new RegExp(String(a).replace(/^\//,'').replace(/\/ig$/,'').replace(/\/gi$/,'')+'$','gi')}});H.add('service','storage',{init:function(a){this.app=a;this.data=[]},observeImages:function(){var a=this.editor.getElement();var b=a.find('[data-image]');b.each(this._addImage.bind(this))},observeFiles:function(){var a=this.editor.getElement();var b=a.find('[data-file]');b.each(this._addFile.bind(this))},setStatus:function(a,b){this.data[a].status=b},getChanges:function(){var a=this.editor.getElement();for(var b in this.data){var c=this.data[b];var d=a.find('[data-'+c.type+'="'+c.id+'"]');this.setStatus(c.id,(d.length===0)?false:true)}return this.data},add:function(a,b){var c=H.dom(b);var d=c.attr('data-'+a);this.data[d]={type:a,status:true,node:c.get(),id:c.attr('data-'+a)}},_addImage:function(a){this.add('image',a)},_addFile:function(a){this.add('file',a)}});H.add('service','utils',{init:function(a){this.app=a},isEmpty:function(a){var b=false;a=H.dom(a).get();if(a){b=(a.nodeType===3)?(a.textContent.trim().replace(/\n/,'')===''):(a.innerHTML==='')}return b},isEmptyHtml:function(a,b,c){a=this.removeInvisibleChars(a);a=a.replace(/&nbsp;/gi,'');a=a.replace(/<\/?br\s?\/?>/g,((b)?'br':''));a=a.replace(/\s/g,'');a=a.replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,'');a=a.replace(/^<div>[^\W\w\D\d]*?<\/div>$/i,'');if(c){a=a.replace(/<ul(.*?[^>])>$/i,'ul');a=a.replace(/<ol(.*?[^>])>$/i,'ol')}a=a.replace(/<hr(.*?[^>])>$/i,'hr');a=a.replace(/<iframe(.*?[^>])>$/i,'iframe');a=a.replace(/<source(.*?[^>])>$/i,'source');a=a.replace(/<[^\/>][^>]*><\/[^>]+>/gi,'');a=a.replace(/<[^\/>][^>]*><\/[^>]+>/gi,'');a=a.trim();return a===''},trimSpaces:function(a){return a=this.removeInvisibleChars(a.trim())},createInvisibleChar:function(){return document.createTextNode(this.opts.markerChar)},searchInvisibleChars:function(a){return a.search(/^\uFEFF$/g)},removeInvisibleChars:function(a){return a.replace(/\uFEFF/g,'')},trimInvisibleChars:function(a){if(!this.selection.isCollapsed())return;var b=this.selection.getCurrent();var c=(a==='left')?this.selection.getTextBeforeCaret():this.selection.getTextAfterCaret();var d=(b&&b.nodeType===3&&this.searchInvisibleChars(c)===0);if(d){if(a==='left'){H.dom(b).replaceWith(b.textContent.trim())}else{var e=this.offset.get();this.offset.set({start:e.start+1,end:e.end+1})}}},buildWrapper:function(a){return H.dom('<div>').html(a)},getWrapperHtml:function(a){var b=a.html();a.remove();return b},createTmpContainer:function(a){var b=H.dom('<div>');if(typeof a==='string'){b.html(a)}else{b.append(H.dom(a).clone(true))}return b.get()},createFragment:function(a){var b=this.createTmpContainer(a);var c=document.createDocumentFragment(),node,firstNode,lastNode;var d=[];var i=0;while((node=b.firstChild)){i++;var n=c.appendChild(node);if(i===1)firstNode=n;d.push(n);lastNode=n}return{frag:c,first:firstNode,last:lastNode,nodes:d}},isFragment:function(a){return(typeof a==='object'&&a.frag)},parseHtml:function(a){var b=this.createTmpContainer(a);return{html:b.innerHTML,nodes:b.childNodes}},splitNode:function(a,b,c,d){b=(this.isFragment(b))?b.frag:b;var e;if(d){e=(this.inspector.isInlineTag(a.tagName))?a:this.selection.getInline(a)}else{e=(this.inspector.isBlockTag(a.tagName))?a:this.selection.getBlock(a)}var f=H.dom(e);if(!d&&this.isEmptyHtml(e.innerHTML,true)){f.after(b);f.remove();return b}var g=f.get().tagName.toLowerCase();var h=this.caret.isEnd(e);var i=this.caret.isStart(e);if(!h&&!i){var j=this.extractHtmlFromCaret(d);var k=H.dom('<'+g+' />');k=this.cloneAttributes(e,k);f.after(k.append(j))}if(i){return f.before(b)}else{if(c){return f.append(b)}else{b=f.after(b);var l=f.html();l=this.removeInvisibleChars(l);l=l.replace(/&nbsp;/gi,'');if(l==='')f.remove();return b}}},extractHtmlFromCaret:function(a,b){var c=this.selection.getRange();if(c){b=(b)?b:((a)?this.selection.getInline():this.selection.getBlock());if(b){var d=c.cloneRange();d.selectNodeContents(b);d.setStart(c.endContainer,c.endOffset);return d.extractContents()}}},createMarkup:function(a){var b=document.createElement(this.opts.markup);if(this.opts.breakline)b.setAttribute('data-redactor-tag','br');var c=H.dom(a);c.after(b);this.caret.setStart(b)},getNode:function(a){var b=H.dom(a).get();var c=this.editor.getElement().get();return(typeof a==='undefined')?c:((b)?b:false)},findSiblings:function(a,b){a=H.dom(a).get();b=(b==='next')?'nextSibling':'previousSibling';while(a=a[b]){if((a.nodeType===3&&a.textContent.trim()==='')||a.tagName==='BR'){continue}return a}return false},getElementsFromHtml:function(d,e,f){var g=document.createElement("div");g.innerHTML=d;var h=g.querySelectorAll(e);var j=function(a,b){if(typeof this.length!=='number')return;if(typeof a!=='function')return;var c=[];if(typeof this=='object'){for(var i=0;i<this.length;i++){if(i in this)c[i]=a.call(b||this,this[i],i,this);else return}}return c};return j.call(h,function(a){var b=a.getAttribute('data-redactor-type');if(f&&b&&b===f){}else return a.outerHTML})},getChildNodes:function(a,b,c){a=(a&&a.nodeType&&a.nodeType===11)?a:H.dom(a).get();var d=a.childNodes;var e=[];if(d){for(var i=0;i<d.length;i++){if(c===true&&d[i].nodeType===3)continue;else if(d[i].nodeType===3&&this.isEmpty(d[i]))continue;e.push(d[i]);if(b!==false){var f=this.getChildNodes(d[i],c);if(f.length>0){e=e.concat(f)}}}}return e},getChildElements:function(a){return this.getChildNodes(a,true,true)},getFirstNode:function(a){return this._getFirst(this.getChildNodes(a,false))},getLastNode:function(a){return this._getLast(this.getChildNodes(a,false))},getFirstElement:function(a){return this._getFirst(this.getChildNodes(a,false,true))},getLastElement:function(a){return this._getLast(this.getChildNodes(a,false,true))},replaceToTag:function(d,e){var f=H.dom(d);return f.replaceWith(function(a){var b=H.dom('<'+e+'>').append(H.dom(a).contents());if(a.attributes){var c=a.attributes;for(var i=0;i<c.length;i++){b.attr(c[i].nodeName,c[i].value)}}return b})},ucfirst:function(a){return a.charAt(0).toUpperCase()+a.slice(1)},removeFromArrayByValue:function(b,c){var a=arguments,len=a.length,ax;while(len>1&&b.length){c=a[--len];while((ax=b.indexOf(c))!==-1){b.splice(ax,1)}}return b},removeEmptyAttr:function(a,b){var c=H.dom(a);if(typeof c.attr(b)==='undefined'||c.attr(b)===null)return true;else if(c.attr(b)===''){c.removeAttr(b);return true}return false},cloneAttributes:function(a,b){a=H.dom(a).get();b=H.dom(b);var c=a.attributes;var d=c.length;while(d--){var e=c[d];b.attr(e.name,e.value)}return b},toParams:function(a){if(typeof a!=='object')return a;var b=Object.keys(a);if(!b.length)return'';var c='';for(var i=0;i<b.length;i++){var d=b[i];c+=d+':'+a[d]+';'}return c},styleToObj:function(a){var b={};if(a){var c=a.replace(/;$/,'').split(';');for(var i=0;i<c.length;i++){var d=c[i].split(':');b[d[0].trim()]=d[1].trim()}}return b},checkProperty:function(a){var b=(arguments[1]&&Array.isArray(arguments[1]))?arguments[1]:[].slice.call(arguments,1);for(var i=0;i<b.length;i++){if(!a||(typeof a[b[i]]==='undefined')){return false}a=a[b[i]]}return a},extendData:function(e,f){for(var g in f){if(g==='elements'){var h=H.dom(f[g]);h.each(function(a){var b=H.dom(a);if(a.tagName==='FORM'){var c=b.serialize(true);for(var z in c){e=this._setData(e,z,c[z])}}else{var d=(b.attr('name'))?b.attr('name'):b.attr('id');e=this._setData(e,d,b.val())}}.bind(this))}else{e=this._setData(e,g,f[g])}}return e},_setData:function(a,b,c){if(a instanceof FormData)a.append(b,c);else a[b]=c;return a},normalizeTextNodes:function(a){a=H.dom(a).get();if(a)a.normalize()},isRgb:function(a){return(a.search(/^rgb/i)===0)},rgb2hex:function(a){a=a.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i);return(a&&a.length===4)?"#"+("0"+parseInt(a[1],10).toString(16)).slice(-2)+("0"+parseInt(a[2],10).toString(16)).slice(-2)+("0"+parseInt(a[3],10).toString(16)).slice(-2):''},hex2long:function(a){if(a.search(/^#/)!==-1&&a.length===4){a='#'+a[1]+a[1]+a[2]+a[2]+a[3]+a[3]}return a},escapeRegExp:function(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,'\\$&')},getRandomId:function(){var a='';var b='abcdefghijklmnopqrstuvwxyz0123456789';for(var i=0;i<12;i++){a+=b.charAt(Math.floor(Math.random()*b.length))}return a},_getFirst:function(a){return(a.length!==0)?a[0]:false},_getLast:function(a){return(a.length!==0)?a[a.length-1]:false}});H.add('service','progress',{init:function(a){this.app=a;this.$box=null;this.$bar=null},show:function(){if(!this._is())this._build();this.$box.show()},hide:function(){if(this._is()){this.animate.start(this.$box,'fadeOut',this._destroy.bind(this))}},update:function(a){this.show();this.$bar.css('width',a+'%')},_is:function(){return(this.$box!==null)},_build:function(){this.$bar=H.dom('<span />');this.$box=H.dom('<div id="redactor-progress" />');this.$box.append(this.$bar);this.$body.append(this.$box)},_destroy:function(){if(this._is())this.$box.remove();this.$box=null;this.$bar=null}});H.add('module','starter',{init:function(a){this.app=a;this.opts=a.opts;this.plugin=a.plugin;this.module=a.module},onstart:function(){var a=['element','container','source','editor','statusbar','toolbar'];var b=['element','container','source','editor','statusbar','contextbar','input'];this._startStop('start',this.app,a);this._startStop('start',this.module,b)},onstop:function(){var a=['observer','element','container','source','editor','contextbar'];this._startStop('stop',this.module,a)},onenable:function(){var a=['observer','toolbar'];var b=this.opts.plugins;this._startStop('start',this.module,a);this._startStop('start',this.plugin,b)},ondisable:function(){var a=['observer','toolbar'];var b=this.opts.plugins;this._startStop('stop',this.module,a);this._startStop('stop',this.plugin,b)},_startStop:function(a,b,c){for(var i=0;i<c.length;i++){if(typeof b[c[i]]!=='undefined'){this.app.callInstanceMethod(b[c[i]],a)}}}});H.add('module','element',{init:function(a){this.app=a;this.uuid=a.uuid;this.opts=a.opts;this.namespace=a.namespace;this.element=a.element;this.rootOpts=H.extend({},true,H.options,a.rootOpts)},start:function(){this._build();this._buildModes();this._buildMarkup()},stop:function(){var a=this.element.getElement();a.removeData(this.namespace+'-uuid')},_build:function(){var a=this.element.getElement();a.data(this.namespace+'-uuid',this.uuid)},_buildModes:function(){var a=this.element.getType();if(a==='inline')this._redefineOptions(this.opts.modes['inline']);if(a==='div')this._redefineOptions(this.opts.modes['original']);if(a!=='inline'){if(this._isRootOption('styles')&&this.rootOpts.styles)this.opts.styles=true;if(this._isRootOption('source')&&!this.rootOpts.source)this.opts.showSource=false}},_buildMarkup:function(){var a=this.element.getType();if(a==='inline'){this.opts.emptyHtml=''}else if(this.opts.breakline){this.opts.markup='div';this.opts.emptyHtml='<div data-redactor-tag="br">'+this.opts.markerChar+'</div>'}else{this.opts.emptyHtml='<'+this.opts.markup+'></'+this.opts.markup+'>'}},_redefineOptions:function(a){for(var b in a){this.opts[b]=a[b]}},_isRootOption:function(){return(typeof this.rootOpts['styles']!=='undefined')}});H.add('module','editor',{init:function(a){this.app=a;this.uuid=a.uuid;this.opts=a.opts;this.editor=a.editor;this.source=a.source;this.element=a.element;this.component=a.component;this.container=a.container;this.inspector=a.inspector;this.autoparser=a.autoparser;this.placeholder=false;this.events=false},onenable:function(){this.enable()},ondisable:function(){this.disable()},onenablefocus:function(){this._enableFocus()},oncontextmenu:function(e){this.component.setOnEvent(e,true)},onclick:function(e){this.component.setOnEvent(e)},onkeyup:function(e){var a=this.inspector.parse(e.target);if(!a.isComponent()){this.component.clearActive()}},onenablereadonly:function(){this._enableReadOnly()},ondisablereadonly:function(){this._disableReadOnly()},onautoparseobserve:function(){this.autoparser.observe()},onplaceholder:{build:function(){this._buildPlaceholder()},toggle:function(){this._togglePlacehodler()}},start:function(){this._build();this._buildEvents();this._buildOptions();this._buildAccesibility()},stop:function(){var a=this.editor.getElement();var b=this.container.getElement();var c=['redactor-in','redactor-in-'+this.uuid,'redactor-structure','redactor-placeholder',this.opts.stylesClass];var d=['redactor-focus','redactor-blur','redactor-over','redactor-styles-on','redactor-styles-off','redactor-toolbar-on','redactor-text-labeled-on','redactor-source-view'];a.removeAttr('spellcheck');a.removeAttr('dir');a.removeAttr('contenteditable');a.removeAttr('placeholder');a.removeAttr('data-gramm_editor');a.removeClass(c.join(' '));b.removeClass(d.join(' '));this._destroyEvents();if(a.get().classList.length===0)a.removeAttr('class')},enable:function(){var a=this.editor.getElement();var b=this.container.getElement();a.addClass('redactor-in redactor-in-'+this.uuid);a.attr({'contenteditable':true});if(this.opts.structure){a.addClass('redactor-structure')}if(this.opts.toolbar&&!this.opts.air&&!this.opts.toolbarExternal){b.addClass('redactor-toolbar-on')}this._disableBrowsersEditing()},disable:function(){var a=this.editor.getElement();var b=this.container.getElement();a.removeClass('redactor-in redactor-in-'+this.uuid);a.removeClass('redactor-structure');a.removeAttr('contenteditable');b.addClass('redactor-toolbar-on')},_build:function(){var a=this.editor.getElement();var b=this.element.getElement();var c=this.container.getElement();c.addClass('redactor-blur');if(!this.opts.grammarly){a.attr('data-gramm_editor',false)}if(this.opts.styles){a.addClass(this.opts.stylesClass);c.addClass('redactor-styles-on')}else{c.addClass('redactor-styles-off')}if(this.opts.buttonsTextLabeled){c.addClass('redactor-text-labeled-on')}if(this.element.isType('textarea'))b.before(a)},_buildEvents:function(){this.events=H.create('editor.events',this.app)},_buildOptions:function(){var a=this.editor.getElement();a.attr('dir',this.opts.direction);if(this.opts.tabindex)a.attr('tabindex',this.opts.tabindex);if(this.opts.minHeight)a.css('min-height',this.opts.minHeight);if(this.opts.maxHeight)a.css('max-height',this.opts.maxHeight);if(this.opts.maxWidth)a.css({'max-width':this.opts.maxWidth,'margin':'auto'})},_buildAccesibility:function(){var a=this.editor.getElement();a.attr({'aria-labelledby':'redactor-voice-'+this.uuid,'role':'presentation'})},_buildPlaceholder:function(){this.placeholder=H.create('editor.placeholder',this.app)},_enableFocus:function(){if(this.opts.showSource)this._enableFocusSource();else this._enableFocusEditor()},_enableFocusSource:function(){var a=this.source.getElement();if(this.opts.focus){a.focus();a.get().setSelectionRange(0,0)}else if(this.opts.focusEnd){a.focus()}},_enableFocusEditor:function(){if(this.opts.focus){setTimeout(this.editor.startFocus.bind(this.editor),100)}else if(this.opts.focusEnd){setTimeout(this.editor.endFocus.bind(this.editor),100)}},_togglePlacehodler:function(){if(this.placeholder)this.placeholder.toggle()},_disableBrowsersEditing:function(){try{document.execCommand('enableObjectResizing',false,false);document.execCommand('enableInlineTableEditing',false,false);document.execCommand("AutoUrlDetect",false,false);var a=this.editor.getElement();var b=a.get();if(b.addEventListener)b.addEventListener('mscontrolselect',function(e){e.preventDefault()});else b.attachEvent('oncontrolselect',function(e){e.returnValue=false})}catch(e){}},_destroyEvents:function(){if(this.events){this.events.destroy()}},_enableReadOnly:function(){var a=this.editor.getElement();this._getEditables(a).removeAttr('contenteditable');a.removeAttr('contenteditable');a.addClass('redactor-read-only');if(this.events)this.events.destroy()},_disableReadOnly:function(){var a=this.editor.getElement();this._getEditables(a).attr({'contenteditable':true});a.removeClass('redactor-read-only');a.attr({'contenteditable':true});this._buildEvents()},_getEditables:function(a){return a.find('figcaption, td, th')}});H.add('class','editor.placeholder',{init:function(a){this.app=a;this.opts=a.opts;this.editor=a.editor;this.element=a.element;this.build()},build:function(){var a=this.element.getElement();var b=this.editor.getElement();if(this.opts.placeholder!==false||a.attr('placeholder')){var c=(this.opts.placeholder!==false)?this.opts.placeholder:a.attr('placeholder');b.attr('placeholder',c);this.toggle()}},toggle:function(){return(this.editor.isEmpty(true))?this.show():this.hide()},show:function(){var a=this.editor.getElement();a.addClass('redactor-placeholder')},hide:function(){var a=this.editor.getElement();a.removeClass('redactor-placeholder')}});H.add('class','editor.events',{init:function(a){this.app=a;this.opts=a.opts;this.$doc=a.$doc;this.uuid=a.uuid;this.source=a.source;this.editor=a.editor;this.cleaner=a.cleaner;this.container=a.container;this.insertion=a.insertion;this.inspector=a.inspector;this.selection=a.selection;this.component=a.component;this.blurNamespace='.redactor-blur.'+this.uuid;this.eventsList=['paste','click','contextmenu','keydown','keyup','mouseup','touchstart','cut','copy','dragenter','dragstart','drop','dragover','dragleave'];this._init()},destroy:function(){var a=this.editor.getElement();a.off('.redactor-focus');this.$doc.off('keyup'+this.blurNamespace+' mousedown'+this.blurNamespace);this._loop('off')},focus:function(e){var a=this.container.getElement();if(this.editor.isPasting()||a.hasClass('redactor-focus'))return;a.addClass('redactor-focus');a.removeClass('redactor-blur');this.app.broadcast('observe',e);this.app.broadcast('focus',e);this.isFocused=true;this.isBlured=false},blur:function(e){var a=this.container.getElement();var b=H.dom(e.target);var c=['.redactor-in-'+this.uuid,'.redactor-toolbar','.redactor-dropdown','.redactor-context-toolbar','#redactor-modal','#redactor-image-resizer'];this.app.broadcast('originalblur',e);if(this.app.stopBlur)return;if(!this.app.isStarted()||this.editor.isPasting())return;if(b.closest(c.join(',')).length!==0)return;if(!this.isBlured&&!a.hasClass('redactor-blur')){a.removeClass('redactor-focus');a.addClass('redactor-blur');this.app.broadcast('blur',e);this.isFocused=false;this.isBlured=true}},cut:function(e){var a=this.selection.getCurrent();var b=this.inspector.parse(a);this.app.broadcast('state',e);if(this.component.isNonEditable(a)){this._passSelectionToClipboard(e,b,true);e.preventDefault()}},copy:function(e){var a=this.selection.getCurrent();var b=this.inspector.parse(a);this.app.broadcast('state',e);if(this.component.isNonEditable(a)){this._passSelectionToClipboard(e,b,false);e.preventDefault()}},drop:function(e){e=e.originalEvent||e;e.stopPropagation();this._removeOverClass();if(this.opts.dragUpload===false){e.preventDefault();return}if(this.app.isDragComponentInside()){var a=H.dom(this.app.getDragComponentInside());var b=a.clone(true);this.insertion.insertToPoint(e,b);a.remove();this.app.setDragComponentInside(false);this.app.broadcast('state',e);this.app.broadcast('drop',e);this.app.broadcast('image.observe',e);e.preventDefault();return}else if(this.app.isDragInside()&&this.opts.input){this.insertion.insertPoint(e);var c=e.dataTransfer;var d=c.getData('text/html');var f=this.selection.getRange();if(f){var g=this.selection.getBlocks();f.deleteContents();for(var i=0;i<g.length;i++){if(g[i].innerHTML==='')H.dom(g[i]).remove()}}H.create('input.paste',this.app,e,true,d,true);this.app.broadcast('state',e);this.app.broadcast('drop',e);this.app.setDragInside(false);e.preventDefault();return}this.app.broadcast('state',e);this.app.broadcast('paste',e,e.dataTransfer);this.app.broadcast('drop',e)},dragenter:function(e){e.preventDefault()},dragstart:function(e){this.app.setDragComponentInside(false);this.app.setDragInside(false);var a=this.inspector.parse(e.target);if(a.isComponent()&&!a.isComponentEditable()&&!a.isFigcaption()){this.app.setDragComponentInside(a.getComponent())}else if(this.selection.is()&&!this.selection.isCollapsed()){this.app.setDragInside(true);this._setDragData(e)}this.app.broadcast('dragstart',e)},dragover:function(e){this.app.broadcast('dragover',e)},dragleave:function(e){this.app.broadcast('dragleave',e)},paste:function(e){this.app.broadcast('paste',e)},contextmenu:function(e){this.editor.disableNonEditables();setTimeout(function(){this.editor.enableNonEditables();this.app.broadcast('contextmenu',e)}.bind(this),0)},click:function(e){if(e.detail===3){e.preventDefault();var a=this.selection.getBlock();var b=document.createRange();b.selectNodeContents(a);this.selection.setRange(b)}var c=H.dom(e.target);if(c.hasClass('redactor-in')){var d=c.offset().top;var f=parseFloat(c.css('padding-bottom'));var g=c.height();var h=d+g-f*2;if(h<e.pageY){this.app.broadcast('bottomclick',e)}}this.app.broadcast('state',e);this.app.broadcast('click',e)},keydown:function(e){this.app.broadcast('state',e);var a=this.app.broadcast('keydown',e);if(a===false){return e.preventDefault()}},keyup:function(e){this.app.broadcast('keyup',e)},mouseup:function(e){this.app.broadcast('observe',e);this.app.broadcast('state',e)},touchstart:function(e){this.app.broadcast('observe',e);this.app.broadcast('state',e)},_init:function(){var a=this.editor.getElement();a.on('focus.redactor-focus click.redactor-focus',this.focus.bind(this));this.$doc.on('keyup'+this.blurNamespace+' mousedown'+this.blurNamespace,this.blur.bind(this));this._loop('on')},_removeOverClass:function(){var a=this.editor.getElement();a.removeClass('over')},_loop:function(a){var b=this.editor.getElement();for(var i=0;i<this.eventsList.length;i++){var c=this.eventsList[i]+'.redactor-events';var d=this.eventsList[i];b[a](c,this[d].bind(this))}},_passAllToClipboard:function(e){var a=e.clipboardData;var b=this.source.getCode();a.setData('text/html',b);a.setData('text/plain',b.toString().replace(/\n$/,""))},_passSelectionToClipboard:function(e,a,b){var c=e.clipboardData;var d=a.getComponent();var f=H.dom(d);var g=f.clone();g.find('.redactor-component-caret').remove();g.removeClass('redactor-component-active');g.removeAttr('contenteditable');g.removeAttr('tabindex');var h=g.get().outerHTML;if(b)this.component.remove(d);c.setData('text/html',h);c.setData('text/plain',h.toString().replace(/\n$/,""))},_setDragData:function(e){e=e.originalEvent||e;var a=e.dataTransfer;a.effectAllowed='move';a.setData('text/Html',this.selection.getHtml())}});H.add('module','container',{init:function(a){this.app=a;this.uuid=a.uuid;this.opts=a.opts;this.lang=a.lang;this.element=a.element;this.container=a.container},start:function(){this._build();this._buildAccesibility()},stop:function(){var a=this.element.getElement();var b=this.container.getElement();b.after(a);b.remove();a.show()},_build:function(){var a=this.element.getElement();var b=this.container.getElement();b.addClass('redactor-box');b.attr('dir',this.opts.direction);if(this.element.isType('inline'))b.addClass('redactor-inline');a.after(b);b.append(a)},_buildAccesibility:function(){var a=this.container.getElement();var b=H.dom('<span />');b.addClass('redactor-voice-label');b.attr({'id':'redactor-voice-'+this.uuid,'aria-hidden':false});b.html(this.lang.get('accessibility-help-label'));a.prepend(b)}});H.add('module','source',{init:function(a){this.app=a;this.uuid=a.uuid;this.opts=a.opts;this.utils=a.utils;this.element=a.element;this.source=a.source;this.editor=a.editor;this.toolbar=a.toolbar;this.cleaner=a.cleaner;this.component=a.component;this.container=a.container;this.autoparser=a.autoparser;this.selection=a.selection;this.syncedHtml=''},onstartcode:function(){var a=this.source.getStartedContent();var b=this.editor.getElement();var c=this.source.getElement();if(this.opts.autoparse&&this.opts.autoparseStart){a=this.autoparser.parse(a)}var d=this.cleaner.input(a,true,true);var e=this.cleaner.output(d);b.html(d);c.val(e);this.syncedHtml=e;this.app.broadcast('placeholder.build');this.app.broadcast('autoparseobserve');this.component.executeScripts()},onstartcodeshow:function(){this.show()},ontrytosync:function(){this.sync()},start:function(){this._build();this._buildClasses()},stop:function(){var a=this.element.getElement();var b=this.source.getElement();a.removeClass('redactor-source redactor-source-open');b.off('input.redactor-source');b.removeAttr('data-gramm_editor');if(b.get().classList.length===0)b.removeAttr('class');if(!this.source.isNameGenerated())a.removeAttr('name');if(!this.element.isType('textarea'))b.remove()},getCode:function(){return this.source.getCode()},toggle:function(){if(!this.opts.source)return;var a=this.source.getElement();return(a.hasClass('redactor-source-open'))?this.hide():this.show()},show:function(){if(!this.opts.source)return;var a=this.editor.getElement();var b=this.source.getElement();var c=this.container.getElement();var d=b.val();if(this.app.isStarted())d=this.app.broadcast('source.open',d);var e=H.create('source.selection',this.app);var f=e.insertMarkersToEditor();f=this.cleaner.output(f,false);f=f.trim();var g=a.height();a.hide();b.height(g);b.val(d.trim());b.show();b.addClass('redactor-source-open');b.on('input.redactor-source-events',this._onChangedSource.bind(this));b.on('keydown.redactor-source-events',this._onTabKey.bind(this));b.on('focus.redactor-source-events',this._onFocus.bind(this));c.addClass('redactor-source-view');e.setSelectionOffsetSource(f);setTimeout(function(){this._disableButtons();this._setActiveSourceButton()}.bind(this),100);if(this.app.isStarted())this.app.broadcast('source.opened')},hide:function(){if(!this.opts.source)return;var a=this.editor.getElement();var b=this.source.getElement();var c=this.container.getElement();var d=b.val();var e=H.create('source.selection',this.app);d=e.insertMarkersToSource(d);d=this.cleaner.input(d,true);d=(this.utils.isEmptyHtml(d))?this.opts.emptyHtml:d;d=this.app.broadcast('source.close',d);this._enableButtons();this._setInactiveSourceButton();b.hide();b.removeClass('redactor-source-open');b.off('.redactor-source-events');a.show();a.html(d);c.removeClass('redactor-source-view');setTimeout(function(){if(e.isOffset())this.selection.restoreMarkers();else if(e.isOffsetEnd())this.editor.endFocus();else this.editor.startFocus();this.component.executeScripts()}.bind(this),0);this.app.broadcast('source.closed')},sync:function(){var a=this;var b=this.editor.getElement();var c=b.html();c=this.app.broadcast('syncBefore',c);c=this.cleaner.output(c);if(this._isSync(c)){if(this.timeout)clearTimeout(this.timeout);this.timeout=setTimeout(function(){a._syncing(c)},200)}},_build:function(){var a=this.source.getElement();var b=this.element.getElement();a.hide();if(!this.opts.grammarly){a.attr('data-gramm_editor',false)}if(!this.element.isType('textarea')){b.after(a)}},_buildClasses:function(){var a=this.source.getElement();a.addClass('redactor-source')},_syncing:function(a){a=this.app.broadcast('syncing',a);var b=this.source.getElement();b.val(a);this.app.broadcast('synced',a);this.app.broadcast('changed',a)},_isSync:function(a){if(this.syncedHtml!==a){this.syncedHtml=a;return true}return false},_onChangedSource:function(){var a=this.source.getElement();var b=a.val();this.app.broadcast('changed',b);this.app.broadcast('source.changed',b)},_onTabKey:function(e){if(e.keyCode!==9)return true;e.preventDefault();var a=this.source.getElement();var b=a.get();var c=b.selectionStart;a.val(a.val().substring(0,c)+"    "+a.val().substring(b.selectionEnd));b.selectionStart=b.selectionEnd=c+4},_onFocus:function(){this.app.broadcast('sourcefocus')},_disableButtons:function(){this.toolbar.disableButtons()},_enableButtons:function(){this.toolbar.enableButtons()},_setActiveSourceButton:function(){var a=this.toolbar.getButton('html');a.enable();a.setActive()},_setInactiveSourceButton:function(){var a=this.toolbar.getButton('html');a.setInactive()}});H.add('class','source.selection',{init:function(a){this.app=a;this.utils=a.utils;this.source=a.source;this.editor=a.editor;this.marker=a.marker;this.component=a.component;this.selection=a.selection;this.markersOffset=false;this.markersOffsetEnd=false},insertMarkersToEditor:function(){var a=this.editor.getElement();var b=this.marker.build('start');var c=this.marker.build('end');var d=this.component.getActive();if(d){this.marker.remove();var e=H.dom(d);e.after(c);e.after(b)}else if(window.getSelection&&this.selection.is()){this.marker.insert('both')}return this._getHtmlAndRemoveMarkers(a)},setSelectionOffsetSource:function(a){var b=0;var c=0;var d=this.source.getElement();if(a!==''){var e=this.utils.removeInvisibleChars(this.marker.buildHtml('start'));var f=this.utils.removeInvisibleChars(this.marker.buildHtml('end'));b=this._strpos(a,e);c=this._strpos(a,f)-f.toString().length-2;if(b===false){b=0;c=0}}d.get().setSelectionRange(b,c);d.get().scrollTop=0;setTimeout(function(){d.focus()}.bind(this),0)},isOffset:function(){return this.markersOffset},isOffsetEnd:function(){return this.markersOffsetEnd},insertMarkersToSource:function(a){var b=this.source.getElement();var c=this.marker.buildHtml('start');var d=this.marker.buildHtml('end');var e=c.toString().length;var f=this._enlargeOffset(a,b.get().selectionStart);var g=this._enlargeOffset(a,b.get().selectionEnd);var h=a.length;if(f===h){this.markersOffsetEnd=true}else if(f!==0&&g!==0){this.markersOffset=true;a=a.substr(0,f)+c+a.substr(f);a=a.substr(0,g+e)+d+a.substr(g+e)}else{this.markersOffset=false}return a},_getHtmlAndRemoveMarkers:function(a){var b=a.html();a.find('.redactor-selection-marker').remove();return b},_strpos:function(a,b,c){var i=a.indexOf(b,c);return i>=0?i:false},_enlargeOffset:function(a,b){var d=a.length;var c=0;if(a[b]==='>'){c++}else{for(var i=b;i<=d;i++){c++;if(a[i]==='>'){break}else if(a[i]==='<'||i===d){c=0;break}}}return b+c}});H.add('module','observer',{init:function(a){this.app=a;this.editor=a.editor;this.observerUnit=false},start:function(){if(window.MutationObserver){var a=this.editor.getElement();var b=a.get();this.observerUnit=this._build(b);this.observerUnit.observe(b,{attributes:true,subtree:true,childList:true,characterData:true,characterDataOldValue:true})}},stop:function(){if(this.observerUnit)this.observerUnit.disconnect()},_build:function(b){var c=this;return new MutationObserver(function(a){c._observe(a[a.length-1],b)})},_observe:function(a,b){if(this.app.isReadOnly()||(a.type==='attributes'&&a.target===b)){return}this.app.broadcast('observe');this.app.broadcast('trytosync');this.app.broadcast('placeholder.toggle')}});H.add('module','clicktoedit',{init:function(a){this.app=a;this.opts=a.opts;this.source=a.source;this.editor=a.editor;this.container=a.container;this.selection=a.selection},onstartclicktoedit:function(){this.start()},onenablereadonly:function(){if(!this._isEnabled())this.stop()},ondisablereadonly:function(){if(!this._isEnabled())this.start()},onstop:function(){this.stop()},start:function(){this._build()},stop:function(){if(this.buttonSave)this.buttonSave.stop();if(this.buttonCancel)this.buttonCancel.stop();this._destroy();this.app.broadcast('disable')},enable:function(){this.app.broadcast('clickStart');var a=this.editor.isEmpty();if(!a)this.selection.saveMarkers();this._setFocus();this._destroy();this.app.broadcast('enable');this.buttonSave.enable();this.buttonCancel.enable();if(!a)this.selection.restoreMarkers();if(a)this.editor.focus();var b=this.container.getElement();b.addClass('redactor-clicktoedit-enabled')},save:function(e){if(e)e.preventDefault();var a=this.source.getCode();this.app.broadcast('disable');this.app.broadcast('clickSave',a);this.app.broadcast('clickStop');this._build()},cancel:function(e){if(e)e.preventDefault();var a=this.saved;var b=this.editor.getElement();b.html(a);this.saved='';this.app.broadcast('disable');this.app.broadcast('clickCancel',a);this.app.broadcast('clickStop');this._build()},_build:function(){this.buttonSave=H.create('clicktoedit.button','save',this.app,this);this.buttonCancel=H.create('clicktoedit.button','cancel',this.app,this);this.buttonSave.stop();this.buttonCancel.stop();var a=this.editor.getElement();var b=this.container.getElement();a.on('click.redactor-click-to-edit mouseup.redactor-click-to-edit',this.enable.bind(this));b.addClass('redactor-over');b.removeClass('redactor-clicktoedit-enabled')},_isEnabled:function(){return this.container.getElement().hasClass('redactor-clicktoedit-enabled')},_destroy:function(){var a=this.editor.getElement();var b=this.container.getElement();a.off('.redactor-click-to-edit');b.removeClass('redactor-over redactor-clicktoedit-enabled')},_setFocus:function(){this.saved=this.source.getCode();this.buttonSave.start();this.buttonCancel.start()}});H.add('class','clicktoedit.button',{init:function(a,b,c){this.app=b;this.opts=b.opts;this.toolbar=b.toolbar;this.context=c;this.type=a;this.name=(a==='save')?'clickToSave':'clickToCancel';this.objected=false;this.enabled=false;this.namespace='.redactor-click-to-edit';this._build()},enable:function(){if(!this.objected)return;var a=this.opts[this.name];a.api='module.clicktoedit.'+this.type;this.toolbar.addButton(this.type,a);this.enabled=true},start:function(){if(this.objected)return;this.$button.off(this.namespace);this.$button.show();this.$button.on('click'+this.namespace,this.context[this.type].bind(this.context))},stop:function(){if(this.objected||!this.enabled)return;this.$button.hide()},_build:function(){this.objected=(typeof this.opts[this.name]==='object');if(!this.objected){this.$button=H.dom(this.opts[this.name]);this.enabled=true}}});H.add('module','statusbar',{init:function(a){this.app=a;this.opts=a.opts;this.element=a.element;this.statusbar=a.statusbar;this.container=a.container},start:function(){if(!this.element.isType('inline')){var a=this.statusbar.getElement();var b=this.container.getElement();a.addClass('redactor-statusbar');b.append(a)}}});H.add('module','contextbar',{init:function(a){this.app=a;this.opts=a.opts;this.uuid=a.uuid;this.$win=a.$win;this.$doc=a.$doc;this.$body=a.$body;this.editor=a.editor;this.toolbar=a.toolbar;this.detector=a.detector;this.$target=(this.toolbar.isTarget())?this.toolbar.getTargetElement():this.$body},onenablereadonly:function(){this.stop()},ondisablereadonly:function(){this.start()},oncontextbar:{close:function(){this.close()}},start:function(){if(this.opts.toolbarContext){var a=this.editor.getElement();this._build();a.on('click.redactor-context mouseup.redactor-context',this.open.bind(this));if(this.opts.scrollTarget){H.dom(this.opts.scrollTarget).on('scroll.redactor-context',this.close.bind(this))}}},stop:function(){var a=this.editor.getElement();a.off('.redactor-context');this.$doc.off('.redactor-context');this.$win.off('.redactor-context');if(this.$contextbar)this.$contextbar.remove();if(this.opts.scrollTarget){H.dom(this.opts.scrollTarget).off('.redactor-context')}},is:function(){return(this.$contextbar&&this.$contextbar.hasClass('open'))},set:function(e,a,b,c){this.$contextbar.html('');this.$el=H.dom(a);for(var d in b){var f=H.create('contextbar.button',this.app,b[d]);if(f.html()!==''){this.$contextbar.append(f)}}var g=this._buildPosition(e,this.$el,c);this.$contextbar.css(g);this.$contextbar.show();this.$contextbar.addClass('open');this.$doc.on('click.redactor-context mouseup.redactor-context',this.close.bind(this));this.$win.on('resize.redactor-context',this.close.bind(this))},open:function(e){setTimeout(function(){this.app.broadcast('contextbar',e,this)}.bind(this),0)},close:function(e){if(!this.$contextbar)return;if(e){var a=H.dom(e.target);if(this.$el&&a.closest(this.$el).length!==0){return}}this.$contextbar.hide();this.$contextbar.removeClass('open');this.$doc.off('.redactor.context')},_build:function(){this.$contextbar=H.dom('<div>');this.$contextbar.attr('id','redactor-context-toolbar-'+this.uuid);this.$contextbar.attr('dir',this.opts.direction);this.$contextbar.addClass('redactor-context-toolbar');this.$contextbar.hide();this.$target.append(this.$contextbar)},_buildPosition:function(e,a,b){var c,left;var d=this.toolbar.isTarget();var f=(d)?a.position():a.offset();var g=a.width();var h=a.height();var i=this.$contextbar.width();var j=this.$contextbar.height();var k=(d)?(this.$target.scrollTop()+this.$doc.scrollTop()):this.$doc.scrollTop();var l=this.$target.offset();var m=(d)?l.left:0;var n=(d)?l.top:0;if(!b){c=(e.clientY+k-j);left=(e.clientX-i/2)}else if(b==='top'){c=(f.top-j);left=(f.left+g/2-i/2)}else if(b==='bottom'){c=(f.top+h);left=(f.left+g/2-i/2)}if(left<0)left=0;return{top:(c-n)+'px',left:(left-m)+'px'}}});H.add('class','contextbar.button',{mixins:['dom'],init:function(a,b){this.app=a;this.obj=b;this._init()},_init:function(){this.parse('<a>');this.attr('href','#');this._buildTitle();this._buildMessage()},_buildTitle:function(){this.html(this.obj.title)},_buildMessage:function(){if(typeof this.obj.message!=='undefined'||typeof this.obj.api!=='undefined'){this.on('click',this._toggle.bind(this))}},_toggle:function(e){e.preventDefault();if(this.obj.message){this.app.broadcast(this.obj.message,this.obj.args)}else if(this.obj.api){this.app.api(this.obj.api,this.obj.args)}}});H.add('module','toolbar',{init:function(a){this.app=a;this.opts=a.opts;this.utils=a.utils;this.toolbar=a.toolbar;this.buttons=[];this.toolbarModule=false},onsource:{open:function(){if(!this.toolbar.isAir()&&this.toolbar.isFixed()){this.toolbarModule.resetPosition()}},opened:function(){if(this.toolbar.isAir()&&this.toolbarModule){this.toolbarModule.createSourceHelper()}},close:function(){if(this.toolbar.isAir()&&this.toolbarModule){this.toolbarModule.destroySourceHelper()}},closed:function(){if(this.toolbar.is()&&this.opts.air){this.toolbarModule.openSelected()}}},onobserve:function(){if(this.toolbar.is()){this.toolbar.observe()}},onfocus:function(){this._setExternalOnFocus()},onsourcefocus:function(){this._setExternalOnFocus()},onempty:function(){if(this.toolbar.isFixed()){this.toolbarModule.resetPosition()}},onenablereadonly:function(){if(this.toolbar.isAir()){this.toolbarModule.close()}},start:function(){if(this.toolbar.is()){this._buildButtons();this._initToolbar();this._initButtons()}},stop:function(){if(this.toolbarModule){this.toolbarModule.stop()}},_buildButtons:function(){this.buttons=this.opts.buttons.concat();this._buildImageButton();this._buildFileButton();this._buildSourceButton();this._buildAdditionalButtons();this._buildHiddenButtons()},_buildImageButton:function(){if(!this.opts.imageUpload)this.utils.removeFromArrayByValue(this.buttons,'image')},_buildFileButton:function(){if(!this.opts.fileUpload)this.utils.removeFromArrayByValue(this.buttons,'file')},_buildSourceButton:function(){if(!this.opts.source)this.utils.removeFromArrayByValue(this.buttons,'html')},_buildAdditionalButtons:function(){if(this.opts.buttonsAdd.length!==0){this.opts.buttonsAdd=this._removeExistButtons(this.opts.buttonsAdd);this.buttons=this.buttons.concat(this.opts.buttonsAdd)}if(this.opts.buttonsAddFirst.length!==0){this.opts.buttonsAddFirst=this._removeExistButtons(this.opts.buttonsAddFirst);this.buttons.unshift(this.opts.buttonsAddFirst)}var a,btns;if(this.opts.buttonsAddAfter!==false){a=this.buttons.indexOf(this.opts.buttonsAddAfter.after)+1;btns=this.opts.buttonsAddAfter.buttons;for(var i=0;i<btns.length;i++){this.buttons.splice(a+i,0,btns[i])}}if(this.opts.buttonsAddBefore!==false){a=this.buttons.indexOf(this.opts.buttonsAddBefore.before)+1;btns=this.opts.buttonsAddBefore.buttons;for(var i=0;i<btns.length;i++){this.buttons.splice(a-(1-i),0,btns[i])}}},_buildHiddenButtons:function(){if(this.opts.buttonsHide.length!==0){var a=this.opts.buttonsHide;for(var i=0;i<a.length;i++){this.utils.removeFromArrayByValue(this.buttons,a[i])}}},_removeExistButtons:function(a){for(var i=0;i<a.length;i++){if(this.opts.buttons.indexOf(a[i])!==-1){this.utils.removeFromArrayByValue(a,a[i])}}return a},_setExternalOnFocus:function(){if(!this.opts.air&&this.opts.toolbarExternal){this.toolbarModule.setExternal()}},_initToolbar:function(){this.toolbarModule=(this.opts.air)?H.create('toolbar.air',this.app):H.create('toolbar.standard',this.app)},_initButtons:function(){this.toolbar.setButtons(this.buttons);for(var i=0;i<this.buttons.length;i++){var a=this.buttons[i];if(H.buttons[a]){this.toolbar.addButton(a,H.buttons[a],false,false,true)}}}});H.add('class','toolbar.air',{init:function(a){this.app=a;this.uuid=a.uuid;this.$doc=a.$doc;this.$win=a.$win;this.utils=a.utils;this.editor=a.editor;this.animate=a.animate;this.toolbar=a.toolbar;this.container=a.container;this.inspector=a.inspector;this.selection=a.selection;this.clicks=0;this._init()},stop:function(){var a=this.toolbar.getWrapper();a.remove();var b=this.editor.getElement();b.off('.redactor-air-trigger-'+this.uuid);this.$doc.off('.redactor-air-'+this.uuid);this.$doc.off('.redactor-air-trigger-'+this.uuid);this.toolbar.stopObservers()},createSourceHelper:function(){this.$airHelper=H.dom('<span>');this.$airHelper.addClass('redactor-air-helper');this.$airHelper.html('<i class="re-icon-html"></i>');this.$airHelper.on('click',function(e){e.preventDefault();this.app.api('module.source.hide')}.bind(this));var a=this.container.getElement();a.append(this.$airHelper)},destroySourceHelper:function(){if(this.$airHelper)this.$airHelper.remove()},openSelected:function(){setTimeout(function(){if(this._isSelection())this._open(false)}.bind(this),0)},close:function(){this.$doc.off('.redactor-air-'+this.uuid);var a=this.toolbar.getElement();a.removeClass('open');a.hide()},_init:function(){this.toolbar.create();var a=this.toolbar.getWrapper();var b=this.toolbar.getElement();var c=this.editor.getElement();var d=this.container.getElement();a.addClass('redactor-toolbar-wrapper-air');b.addClass('redactor-air');b.hide();a.append(b);d.prepend(a);this.openSelected();this.$doc.on('mouseup.redactor-air-trigger-'+this.uuid,this._open.bind(this));c.on('keyup.redactor-air-trigger-'+this.uuid,this._openCmd.bind(this))},_isSelection:function(){return(this.selection.is()&&!this.selection.isCollapsed())},_isOpened:function(){var a=this.toolbar.getElement();return a.hasClass('open')},_open:function(e){var a=(e)?e.target:false;var b=(e)?H.dom(e.target):false;var c=this.inspector.parse(a);var d=(c.isComponent()&&!c.isComponentType('table'));var f=(c.isFigcaption());var g=(b&&b.closest('.redactor-modal').length!==0);var h=(e&&b.closest('.re-button').length!==0);var i=(e&&b.closest('.redactor-dropdown').length!==0);if(i||h||g||f||d||this.toolbar.isContextBar()||!this._isSelection()){return}var j=this.selection.getPosition();setTimeout(function(){if(this.app.isReadOnly())return;if(this._isSelection())this._doOpen(j)}.bind(this),1)},_openCmd:function(){if(this.selection.isAll()){var a=this.toolbar.getElement();var b=this.selection.getPosition();b.top=(b.top<20)?0:b.top-a.height();b.height=0;this._doOpen(b)}},_doOpen:function(a){var b=this.toolbar.getWrapper();var c=this.toolbar.getElement();var d=this.container.getElement();var e=d.offset();var f=0;var g=this.$win.width();var h=c.width();if(g<(a.left+h)){var i=this.selection.getPosition();f=h-i.width}b.css({left:(a.left-e.left-f)+'px',top:(a.top-e.top+a.height+this.$doc.scrollTop())+'px'});this.app.broadcast('airOpen');c.addClass('open');c.show();this.$doc.on('click.redactor-air-'+this.uuid,this._close.bind(this));this.$doc.on('keydown.redactor-air-'+this.uuid,this._close.bind(this));this.app.broadcast('airOpened')},_close:function(e){var a=(e)?H.dom(e.target):false;var b=(e&&a.closest('[data-dropdown], .redactor-dropdown-not-close').length!==0);var c=(!b&&e&&a.closest('.re-button').length!==0);if(!c&&(b||!this._isOpened())){return}this.app.broadcast('airClose');this.close();this.app.broadcast('airClosed')}});H.add('class','toolbar.fixed',{init:function(a){this.app=a;this.uuid=a.uuid;this.opts=a.opts;this.$doc=a.$doc;this.$win=a.$win;this.editor=a.editor;this.toolbar=a.toolbar;this.detector=a.detector;this.container=a.container;this._init()},stop:function(){this.$fixedTarget.off('.redactor-toolbar-'+this.uuid);this.$win.off('.redactor-toolbar-'+this.uuid)},reset:function(){var a=this.toolbar.getElement();var b=this.toolbar.getWrapper();b.css('height','');a.removeClass('redactor-toolbar-fixed');a.css({position:'',top:'',left:'',width:''});var c=this.toolbar.getDropdown();if(c)c.updatePosition()},_init:function(){this.$fixedTarget=(this.toolbar.isTarget())?this.toolbar.getTargetElement():this.$win;this._doFixed();if(this.toolbar.isTarget()){this.$win.on('scroll.redactor-toolbar-'+this.uuid,this._doFixed.bind(this));this.$win.on('resize.redactor-toolbar-'+this.uuid,this._doFixed.bind(this))}this.$fixedTarget.on('scroll.redactor-toolbar-'+this.uuid,this._doFixed.bind(this));this.$fixedTarget.on('resize.redactor-toolbar-'+this.uuid,this._doFixed.bind(this))},_doFixed:function(){var b=this.editor.getElement();var c=this.container.getElement();var d=this.toolbar.getElement();var e=this.toolbar.getWrapper();var f=c.parents().filter(function(a){return(getComputedStyle(a,null).display==='none')?a:false});if(f.length!==0)return;var g=(b.height()<100);var h=this.editor.isEmpty();if(g||h||this.editor.isSourceMode())return;var i=d.height();var j=60;var k=c.offset();var l=k.top;var m=l+c.height()-j;var n=this.$fixedTarget.scrollTop()+this.opts.toolbarFixedTopOffset;var o=(!this.toolbar.isTarget())?0:this.$fixedTarget.offset().top-this.$win.scrollTop();if(n>l&&n<m){var p=(this.detector.isDesktop())?'fixed':'absolute';o=(this.detector.isDesktop())?o:(n-l+this.opts.toolbarFixedTopOffset);if(this.detector.isMobile()){if(this.fixedScrollTimeout){clearTimeout(this.fixedScrollTimeout)}d.hide();this.fixedScrollTimeout=setTimeout(function(){d.show()},250)}e.height(i);d.addClass('redactor-toolbar-fixed');d.css({position:p,top:(o+this.opts.toolbarFixedTopOffset)+'px',width:c.width()+'px'});var q=this.toolbar.getDropdown();if(q)q.updatePosition();this.app.broadcast('toolbar.fixed')}else{this.reset();this.app.broadcast('toolbar.unfixed')}}});H.add('class','toolbar.standard',{init:function(a){this.app=a;this.opts=a.opts;this.uuid=a.uuid;this.toolbar=a.toolbar;this.container=a.container;this.isExternalMultiple=false;this.toolbarFixed=false;this._init()},stop:function(){var a=this.toolbar.getWrapper();a.remove();if(this.toolbarFixed)this.toolbarFixed.stop();if(this.opts.toolbarExternal)this._findToolbars();this.toolbar.stopObservers()},setExternal:function(){this._findToolbars();if(this.isExternalMultiple){this.$toolbars.hide();var a=this.$external.find('.redactor-toolbar-external-'+this.uuid);a.show()}},resetPosition:function(){if(this.toolbarFixed)this.toolbarFixed.reset()},_init:function(){this._build();if(this.opts.toolbarExternal){this._buildExternal()}else{this._buildFixed();var a=this.toolbar.getElement();a.show()}},_build:function(){this.toolbar.create();var a=this.toolbar.getWrapper();var b=this.toolbar.getElement();a.addClass('redactor-toolbar-wrapper');b.addClass('redactor-toolbar');b.hide();a.append(b);if(!this.opts.toolbarExternal){var c=this.container.getElement();c.prepend(a)}},_buildExternal:function(){this._initExternal();this._findToolbars();if(this.isExternalMultiple){this._hideToolbarsExceptFirst()}else{var a=this.toolbar.getElement();a.show()}},_buildFixed:function(){if(this.opts.toolbarFixed){this.toolbarFixed=H.create('toolbar.fixed',this.app)}},_initExternal:function(){var a=this.toolbar.getElement();var b=this.toolbar.getElement();a.addClass('redactor-toolbar-external redactor-toolbar-external-'+this.uuid);this.$external=H.dom(this.opts.toolbarExternal);this.$external.append(b)},_findToolbars:function(){this.$toolbars=this.$external.find('.redactor-toolbar-external');this.isExternalMultiple=(this.$toolbars.length>1)},_hideToolbarsExceptFirst:function(){this.$toolbars.hide();var a=this.$toolbars.first();a.show()}});H.add('module','line',{init:function(a){this.app=a;this.lang=a.lang;this.component=a.component;this.inspector=a.inspector;this.insertion=a.insertion},oncontextbar:function(e,a){var b=this.inspector.parse(e.target);if(b.isComponentType('line')){var c=b.getComponent();var d={"remove":{title:this.lang.get('delete'),api:'module.line.remove',args:c}};a.set(e,c,d,'bottom')}},insert:function(){var a=this.component.create('line');this.insertion.insertRaw(a)},remove:function(a){this.component.remove(a)}});H.add('class','line.component',{mixins:['dom','component'],init:function(a,b){this.app=a;return(b&&b.cmnt!==undefined)?b:this._init(b)},_init:function(a){var b,element;if(typeof a!=='undefined'){var c=H.dom(a);var d=c.get();if(d.tagName==='HR')element=d;else if(d.tagName==='FIGURE'){b=d;element=c.find('hr').get()}}this._buildWrapper(b);this._buildElement(element);this._initWrapper()},_buildElement:function(a){if(a){this.$element=H.dom(a)}else{this.$element=H.dom('<hr>');this.append(this.$element)}},_buildWrapper:function(a){a=a||'<figure>';this.parse(a)},_initWrapper:function(){this.addClass('redactor-component');this.attr({'data-redactor-type':'line','tabindex':'-1','contenteditable':false})}});H.add('module','link',{modals:{'link':'<form action="">                 <div class="form-item">                     <label for="modal-link-url">URL <span class="req">*</span></label>                     <input type="text" id="modal-link-url" name="url">                 </div>                 <div class="form-item">                     <label for="modal-link-text">## text ##</label>                     <input type="text" id="modal-link-text" name="text">                 </div>                 <div class="form-item form-item-title">                     <label for="modal-link-title">## title ##</label>                     <input type="text" id="modal-link-title" name="title">                 </div>                 <div class="form-item form-item-target">                     <label class="checkbox">                         <input type="checkbox" name="target"> ## link-in-new-tab ##                     </label>                 </div>             </form>'},init:function(a){this.app=a;this.opts=a.opts;this.lang=a.lang;this.caret=a.caret;this.utils=a.utils;this.inline=a.inline;this.editor=a.editor;this.inspector=a.inspector;this.insertion=a.insertion;this.selection=a.selection;this.isCurrentLink=false;this.currentText=false},onmodal:{link:{open:function(a,b){this._setFormData(b,a)},opened:function(a,b){this._setFormFocus(b)},update:function(a,b){var c=b.getData();if(this._validateData(b,c)){this._update(c)}},insert:function(a,b){var c=b.getData();if(this._validateData(b,c)){this._insert(c)}},unlink:function(){this._unlink()}}},onbutton:{link:{observe:function(a){this._observeButton(a)}}},ondropdown:{link:{observe:function(a){this._observeUnlink(a);this._observeEdit(a)}}},oncontextbar:function(e,a){var b=this._getCurrent();var c=this.inspector.parse(b);if(c.isLink()){var d=c.getLink();var f=H.dom(d);var g=H.dom('<a>');var h=f.attr('href');g.text(this._truncateText(h));g.attr('href',h);g.attr('target','_blank');var i={"link":{title:g},"edit":{title:this.lang.get('edit'),api:'module.link.open'},"unlink":{title:this.lang.get('unlink'),api:'module.link.unlink'}};a.set(e,d,i,'bottom')}},open:function(){this.$link=this._buildCurrent();this.app.api('module.modal.build',this._getModalData())},insert:function(a){this._insert(a)},update:function(a){this._update(a)},unlink:function(){this._unlink()},_observeButton:function(a){var b=this.selection.getCurrent();var c=this.inspector.parse(b);if(c.isPre()||c.isCode()){a.disable()}else{a.enable()}},_observeUnlink:function(a){var b=a.getItem('unlink');var c=this._getLinks();if(c.length===0)b.disable();else b.enable()},_observeEdit:function(a){var b=this._getCurrent();var c=a.getItem('link');var d=this.inspector.parse(b);var e=(d.isLink())?this.lang.get('link-edit'):this.lang.get('link-insert');c.setTitle(e)},_unlink:function(){this.app.api('module.modal.close');var a=[];var b=this._getLinks();this.selection.save();for(var i=0;i<b.length;i++){var c=H.create('link.component',this.app,b[i]);a.push(this.selection.getElement(b[i]));c.unwrap();this.app.broadcast('link.deleted',c)}this.selection.restore();for(var i=0;i<a.length;i++){var d=(a[i])?a[i]:this.editor.getElement();this.utils.normalizeTextNodes(d)}this._resetCurrent()},_update:function(a){this.app.api('module.modal.close');var b=this._getLinks();this._setLinkData(b,a,'updated');this._resetCurrent()},_insert:function(a){this.app.api('module.modal.close');var b=this._getLinks();if(!this._insertSingle(b,a)){this._removeInSelection(b);this._insertMultiple(a)}this._resetCurrent()},_removeInSelection:function(a){this.selection.save();for(var i=0;i<a.length;i++){var b=H.create('link.component',this.app,a[i]);var c=b.clone();b.unwrap();this.app.broadcast('link.deleted',c)}this.selection.restore()},_insertMultiple:function(a){var b=this.selection.getRange();if(b&&this._isCurrentTextChanged(a)){this._deleteContents(b)}var c=this.inline.format({tag:'a'});this._setLinkData(c,a,'inserted')},_insertSingle:function(a,b){var c=this.selection.getInline();if(a.length===1&&(a[0].textContext===this.selection.getText())||(c&&c.tagName==='A')){var d=H.create('link.component',this.app,a[0]);d.setData(b);this.caret.setAfter(d);this.app.broadcast('link.inserted',d);return true}return false},_setLinkData:function(a,b,c){b.text=(b.text.trim()==='')?this._truncateText(b.url):b.text;var d=(!this.currentText||this.currentText!==b.text);this.selection.save();for(var i=0;i<a.length;i++){var e=H.create('link.component',this.app,a[i]);var f={};if(b.text&&d)f.text=b.text;if(b.url)f.url=b.url;if(b.title!==undefined)f.title=b.title;if(b.target!==undefined)f.target=b.target;e.setData(f);this.app.broadcast('link.'+c,e)}setTimeout(this.selection.restore.bind(this.selection),0)},_deleteContents:function(a){var b=this.selection.getHtml();var c=this.utils.parseHtml(b);var d=c.nodes[0];if(d&&d.nodeType!==3){var e=d.tagName.toLowerCase();var f=document.createElement(e);this.insertion.insertNode(f,'start')}else{a.deleteContents()}},_getModalData:function(){var a;if(this._isLink()){a={update:{title:this.lang.get('save')},unlink:{title:this.lang.get('unlink'),type:'danger'},cancel:{title:this.lang.get('cancel')}}}else{a={insert:{title:this.lang.get('insert')},cancel:{title:this.lang.get('cancel')}}}var b={name:'link',title:(this._isLink())?this.lang.get('link-edit'):this.lang.get('link-insert'),handle:(this._isLink())?'update':'insert',commands:a};return b},_isLink:function(){return this.currentLink},_isCurrentTextChanged:function(a){return(this.currentText&&this.currentText!==a.text)},_buildCurrent:function(){var a=this._getCurrent();var b=this.inspector.parse(a);var c;if(b.isLink()){this.currentLink=true;c=b.getLink();c=H.create('link.component',this.app,c)}else{this.currentLink=false;c=H.create('link.component',this.app);var d={text:this.selection.getText()};c.setData(d)}return c},_getCurrent:function(){return this.selection.getInlinesAllSelected({tags:['a']})[0]},_getLinks:function(){var a=this.selection.getInlines({all:true,tags:['a']});var b=[];for(var i=0;i<a.length;i++){var c=this.inspector.parse(a[i]);if(c.isLink()){b.push(a[i])}}return b},_resetCurrent:function(){this.isCurrentLink=false;this.currentText=false},_truncateText:function(a){return(a&&a.length>this.opts.linkSize)?a.substring(0,this.opts.linkSize)+'...':a},_validateData:function(a,b){return(b.url.trim()==='')?a.setError('url'):true},_setFormFocus:function(a){a.getField('url').focus()},_setFormData:function(a,b){var c=this.$link.getData();var d={url:c.url,text:c.text,title:c.title,target:(this.opts.linkTarget||c.target)};if(!this.opts.linkNewTab)b.find('.form-item-target').hide();if(!this.opts.linkTitle)b.find('.form-item-title').hide();a.setData(d);this.currentText=a.getField('text').val()}});H.add('class','link.component',{mixins:['dom','component'],init:function(a,b){this.app=a;this.opts=a.opts;this.reUrl=/^(?:(?:(?:https?|ftp):)?\/\/)?(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[/?#]\S*)?$/i;return(b&&b.cmnt!==undefined)?b:this._init(b)},setData:function(a){for(var b in a){this._set(b,a[b])}},getData:function(){var a=['url','text','target','title'];var b={};for(var i=0;i<a.length;i++){b[a[i]]=this._get(a[i])}return b},_init:function(a){var b=H.dom(a);if(a===undefined){this.parse('<a>')}else{this.parse(b)}},_set:function(a,b){this['_set_'+a](b)},_get:function(a){return this['_get_'+a]()},_get_target:function(){return(this.attr('target'))?this.attr('target'):false},_get_url:function(){return this.attr('href')},_get_title:function(){return this.attr('title')},_get_text:function(){return this._getContext().text()},_getContext:function(){return this._findDeepestChild(this).element},_set_target:function(a){if(a===false)this.removeAttr('target');else if(a){this.attr('target',(a===true)?'_blank':a)}},_set_text:function(a){this._getContext().html(a)},_set_title:function(a){if(!a||a==='')this.removeAttr('title');else this.attr('title',a)},_set_url:function(a){if(this.opts.linkValidation){a=this._cleanUrl(a);if(this._isMailto(a)){a='mailto:'+a.replace('mailto:','')}else if(this._isUrl(a)&&a.search(/^(ftp|https?)/i)===-1){a='http://'+a.replace(/(ftp|https?):\/\//i,'')}}this.attr('href',a)},_isMailto:function(a){return(a.search('@')!==-1&&/(ftp|https?):\/\//i.test(a)===false)},_isUrl:function(a){return this.reUrl.test(a)},_cleanUrl:function(a){return a.trim().replace(/[^\W\w\D\d+&\'@#/%?=~_|!:,.;\(\)]/gi,'')},_findDeepestChild:function(d){var e={depth:0,element:d};d.children().each(function(a){var b=H.dom(a);if(a.outerHTML!==d.html()){return}else{var c=this._findDeepestChild(b);if(c.depth+1>e.depth){e={depth:1+c.depth,element:c.element}}}}.bind(this));return e}});H.add('module','modal',{init:function(a){this.app=a;this.lang=a.lang;this.$doc=a.$doc;this.$win=a.$win;this.$body=a.$body;this.animate=a.animate;this.detector=a.detector;this.selection=a.selection;this.$box=false;this.$modal=false;this.selectionMarkers=false;this.defaults={name:false,url:false,title:false,width:'600px',height:false,handle:false,commands:false}},build:function(a){this._open(a)},close:function(){this._close()},stop:function(){if(this.$box){this.$box.remove();this.$box=false;this.$modal=false;this.$doc.off('.redactor.modal');this.$win.off('.redactor.modal')}if(this.$overlay){this.$overlay.remove()}},resize:function(){this.$modal.setWidth(this.p.width);this.$modal.updatePosition()},_isOpened:function(){return(this.$modal&&this.$modal.hasClass('open'))},_open:function(a){this._buildDefaults(a);if(this.p.url)this._openUrl();else this._openTemplate()},_openUrl:function(){H.ajax.post({url:this.p.url,success:this._doOpen.bind(this)})},_openTemplate:function(){if(typeof H.modals[this.p.name]!=='undefined'){var a=this.lang.parse(H.modals[this.p.name]);this._doOpen(a)}},_doOpen:function(a){this.stop();if(this.selection.isCollapsed()){this.selection.save();this.selectionMarkers=false}else{this.selection.saveMarkers();this.selectionMarkers=true}if(!this.detector.isDesktop()){document.activeElement.blur()}this._createModal(a);this._buildModalBox();this._buildOverlay();this._buildModal();this._buildModalForm();this._buildModalCommands();this._broadcast('open');this.$modal.updatePosition();this._buildModalTabs();this.animate.start(this.$box,'fadeIn',this._opened.bind(this));this.animate.start(this.$overlay,'fadeIn')},_opened:function(){this.$modal.addClass('open');this.$box.on('mousedown.redactor.modal',this._close.bind(this));this.$doc.on('keyup.redactor.modal',this._handleEscape.bind(this));this.$win.on('resize.redactor.modal',this.resize.bind(this));this.$modal.getBody().find('input[type=text],input[type=url],input[type=email]').on('keydown.redactor.modal',this._handleEnter.bind(this));if(window.jQuery)jQuery(document).off('focusin.modal');this._broadcast('opened')},_close:function(e){if(!this.$box||!this._isOpened())return;if(e){if(!this._needToClose(e.target)){return}e.stopPropagation();e.preventDefault()}if(this.selectionMarkers)this.selection.restoreMarkers();else this.selection.restore();this.selectionMarkers=false;this._broadcast('close');this.animate.start(this.$box,'fadeOut',this._closed.bind(this));this.animate.start(this.$overlay,'fadeOut')},_closed:function(){this.$modal.removeClass('open');this.$box.off('.redactor.modal');this.$doc.off('.redactor.modal');this.$win.off('.redactor.modal');this._broadcast('closed')},_createModal:function(a){this.$modal=H.create('modal.element',this.app,a)},_broadcast:function(a){this.app.broadcast('modal.'+a,this.$modal,this.$modalForm);this.app.broadcast('modal.'+this.p.name+'.'+a,this.$modal,this.$modalForm)},_buildDefaults:function(a){this.p=H.extend({},this.defaults,a)},_buildModalBox:function(){this.$box=H.dom('<div>');this.$box.attr('id','redactor-modal');this.$box.addClass('redactor-animate-hide');this.$box.html('');this.$body.append(this.$box)},_buildOverlay:function(){this.$overlay=H.dom('#redactor-overlay');if(this.$overlay.length===0){this.$overlay=H.dom('<div>');this.$overlay.attr('id','redactor-overlay');this.$overlay.addClass('redactor-animate-hide');this.$body.prepend(this.$overlay)}},_buildModal:function(){this.$box.append(this.$modal);this.$modal.setTitle(this.p.title);this.$modal.setHeight(this.p.height);this.$modal.setWidth(this.p.width)},_buildModalCommands:function(){if(this.p.commands){var a=this.p.commands;var b=this.$modal.getFooter();for(var c in a){var d=H.dom('<button>');d.html(a[c].title);d.attr('data-command',c);if(c==='cancel'){d.attr('data-action','close');d.addClass('redactor-button-unstyled')}if(typeof a[c].type!=='undefined'&&a[c].type==='danger'){d.addClass('redactor-button-danger')}d.on('click',this._handleCommand.bind(this));b.append(d)}}},_buildModalTabs:function(){var d=this.$modal.getBody();var e=d.find('.redactor-modal-tab');var f=d.find('.redactor-modal-tabs');if(e.length>1){f=(f.length===0)?H.dom('<div>'):f.html('');f.addClass('redactor-modal-tabs');e.each(function(a,i){var b=H.dom(a);var c=H.dom('<a>');c.attr('href','#');c.attr('rel',i);c.text(b.attr('data-title'));c.on('click',this._showTab.bind(this));if(i===0){c.addClass('active')}f.append(c)}.bind(this));d.prepend(f)}},_buildModalForm:function(){this.$modalForm=H.create('modal.form',this.app,this.$modal.getForm())},_showTab:function(e){e.preventDefault();var a=H.dom(e.target);var b=a.attr('rel');var c=this.$modal.getBody();var d=c.find('.redactor-modal-tab');d.hide();d.eq(b).show();c.find('.redactor-modal-tabs a').removeClass('active');a.addClass('active')},_needToClose:function(a){var b=H.dom(a);if(b.attr('data-action')==='close'||this.$modal.isCloseNode(a)||b.closest('.redactor-modal').length===0){return true}return false},_handleCommand:function(e){var a=H.dom(e.target).closest('button');var b=a.attr('data-command');if(b!=='cancel')e.preventDefault();this._broadcast(b)},_handleEnter:function(e){if(e.which===13){if(this.p.handle){e.preventDefault();this._broadcast(this.p.handle)}}},_handleEscape:function(e){if(e.which===27)this._close()}});H.add('class','modal.element',{mixins:['dom'],init:function(a,b){this.app=a;this.opts=a.opts;this.$win=a.$win;this._init(b)},getForm:function(){return this.find('form')},getHeader:function(){return this.$modalHeader},getBody:function(){return this.$modalBody},getFooter:function(){return this.$modalFooter},setTitle:function(a){if(a)this.$modalHeader.html(a)},setWidth:function(a){a=(parseInt(a)>=this.$win.width())?'96%':a;this.css('max-width',a)},setHeight:function(a){if(a!==false)this.$modalBody.css('height',a)},updatePosition:function(){var a=this.width();this.css({'left':'50%','margin-left':'-'+(a/2)+'px'});var b=this.$win.height();var c=this.height();var d=(b/2-c/2);if(c<b&&d!==0){this.css('margin-top',d+'px')}},isCloseNode:function(a){return(a===this.$modalClose.get())},_init:function(a){this._build();this._buildClose();this._buildHeader();this._buildBody();this._buildFooter();this._buildTemplate(a)},_build:function(){this.parse('<div>');this.addClass('redactor-modal');this.attr('dir',this.opts.direction)},_buildClose:function(){this.$modalClose=H.dom('<span>');this.$modalClose.addClass('redactor-close');this.append(this.$modalClose)},_buildHeader:function(){this.$modalHeader=H.dom('<div>');this.$modalHeader.addClass('redactor-modal-header');this.append(this.$modalHeader)},_buildBody:function(){this.$modalBody=H.dom('<div>');this.$modalBody.addClass('redactor-modal-body');this.append(this.$modalBody)},_buildFooter:function(){this.$modalFooter=H.dom('<div>');this.$modalFooter.addClass('redactor-modal-footer');this.append(this.$modalFooter)},_buildTemplate:function(a){this.$modalBody.html(a)}});H.add('class','modal.form',{mixins:['dom'],init:function(a,b){this.app=a;this.build(b)},build:function(a){this.parse(a)},getData:function(){var c={};this.find('[name]').each(function(a){var b=H.dom(a);c[b.attr('name')]=b.val()});return c},setData:function(d){this.find('[name]').each(function(a){var b=H.dom(a);var c=b.attr('name');if(d.hasOwnProperty(c)){if(a.type&&a.type==='checkbox')a.checked=d[c];else b.val(d[c])}})},getField:function(a){return this.find('[name='+a+']')},setError:function(a){var b=this.getField(a);b.addClass('error');b.one(this._getFieldEventName(b.get()),this._clearError);return false},_clearError:function(){return H.dom(this).removeClass('error')},_getFieldEventName:function(a){return(a.tagName==='SELECT'||a.type==='checkbox'||a.type==='radio')?'change':'keyup'}});H.add('module','block',{init:function(a){this.app=a;this.block=a.block},format:function(a){var b=this.block.format(a);this.app.broadcast('format','block',b)},clearformat:function(){this.block.clearFormat()},clearstyle:function(){this.block.clearStyle()},clearclass:function(){this.block.clearClass()},clearattr:function(){this.block.clearAttr()},add:function(a,b){this.block.add(a,b)},toggle:function(a,b){this.block.toggle(a,b)},set:function(a,b){this.block.set(a,b)},remove:function(a,b){this.block.remove(a,b)}});H.add('module','inline',{init:function(a){this.app=a;this.inline=a.inline},format:function(a){var b=this.inline.format(a);this.app.broadcast('format','inline',b)},clearformat:function(){this.inline.clearFormat()},clearstyle:function(){this.inline.clearStyle()},clearclass:function(){this.inline.clearClass()},clearattr:function(){this.inline.clearAttr()},add:function(a,b){this.inline.add(a,b)},toggle:function(a,b){this.inline.toggle(a,b)},set:function(a,b){this.inline.set(a,b)},remove:function(a,b){this.inline.remove(a,b)}});H.add('module','autosave',{init:function(a){this.app=a;this.opts=a.opts;this.utils=a.utils;this.source=a.source},onsynced:function(){if(this.opts.autosave){this._send()}},_send:function(){var b=(this.opts.autosaveName)?this.opts.autosaveName:this.source.getName();var c={};c[b]=this.source.getCode();c=this.utils.extendData(c,this.opts.autosaveData);H.ajax.post({url:this.opts.autosave,data:c,success:function(a){this._complete(a,b,c)}.bind(this)})},_complete:function(a,b,c){var d=(a&&a.error)?'autosaveError':'autosave';this.app.broadcast(d,b,c,a)}});H.add('module','input',{init:function(a){this.app=a;this.opts=a.opts;this.utils=a.utils;this.editor=a.editor;this.keycodes=a.keycodes;this.element=a.element;this.selection=a.selection;this.insertion=a.insertion;this.inspector=a.inspector;this.autoparser=a.autoparser;this.lastShiftKey=false},onpaste:function(e,a){if(!this.opts.input)return;return H.create('input.paste',this.app,e,a)},onkeydown:function(e){if(!this.opts.input)return;var a=e.which;var b=H.create('input.shortcut',this.app,e);if(b.is())return;if((e.ctrlKey||e.metaKey)&&!e.altKey&&a===65){e.preventDefault();return this._selectAll()}var c=[this.keycodes.ENTER,this.keycodes.SPACE,this.keycodes.BACKSPACE,this.keycodes.DELETE];var d=(c.indexOf(a)!==-1);var f=((e.ctrlKey||e.metaKey)&&a===88);var g=((!e.ctrlKey&&!e.metaKey)&&((a>=48&&a<=57)||(a>=65&&a<=90)));if(this.selection.isAll()&&(f||(!e.ctrlKey&&!e.metaKey&&!e.altKey&&!e.shiftKey))){if(f){this.editor.disableNonEditables();this.app.broadcast('empty');return}if(this._isArrowKey(a))return true;if(d)e.preventDefault();if(this.element.isType('inline')){var h=this.editor.getElement();h.html('');this.editor.startFocus()}else{this.insertion.set(this.opts.emptyHtml)}if(d)return;else this.app.broadcast('empty')}if(this.opts.autoparse){this.autoparser.format(e,a)}if(g){if(this.selection.hasNonEditable()){e.preventDefault();return}}if(a===this.keycodes.ENTER){return H.create('input.enter',this.app,e,a)}else if(e.metaKey&&a===219){e.preventDefault();this.app.api('module.list.outdent');return}else if(a===this.keycodes.TAB||e.metaKey&&a===221){return H.create('input.tab',this.app,e,a)}else if(a===this.keycodes.SPACE){return H.create('input.space',this.app,e,a,this.lastShiftKey)}else if(this._isDeleteKey(a)){return H.create('input.delete',this.app,e,a)}else if(this._isArrowKey(a)){return H.create('input.arrow',this.app,e,a)}},onkeyup:function(e){if(!this.opts.input)return;var a=e.which;this.lastShiftKey=e.shiftKey;this.app.broadcast('contextbar.close');var b=H.create('input.shortcode',this.app,e,a);if(b.is())return;if(a===this.keycodes.BACKSPACE){var c=this.editor.getElement();var d=this.utils.trimSpaces(c.html());d=d.replace(/<br\s?\/?>/g,'');d=d.replace(/<div><\/div>/,'');if(d===''){e.preventDefault();this.editor.setEmpty();this.editor.startFocus();return}}if(this.editor.isEmpty()){this.app.broadcast('empty')}},start:function(){if(this.opts.shortcutsAdd){this.opts.shortcuts=H.extend({},true,this.opts.shortcuts,this.opts.shortcutsAdd)}},_selectAll:function(){var a=this.selection.getCurrent();var b=this.inspector.parse(a);var c;if(b.isComponentType('table')){c=b.getTable();this.selection.setAll(c);return}else if(b.isComponentType('code')){c=b.getComponentCodeElement();this.selection.setAll(c);return}this.selection.setAll()},_isArrowKey:function(a){return([this.keycodes.UP,this.keycodes.DOWN,this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(a)!==-1)},_isDeleteKey:function(a){return(a===this.keycodes.BACKSPACE||a===this.keycodes.DELETE)}});H.add('class','input.arrow',{init:function(a,e,b){this.app=a;this.opts=a.opts;this.utils=a.utils;this.caret=a.caret;this.offset=a.offset;this.marker=a.marker;this.editor=a.editor;this.keycodes=a.keycodes;this.component=a.component;this.inspector=a.inspector;this.selection=a.selection;this.key=b;this._init(e)},_init:function(e){if(this._isRightLeftKey()&&this._isExitVariable(e))return;if(this._isRightDownKey()){if(this._isExitOnDownRight(e))return;if(this._selectComponent(e,'End','next'))return}if(this._isLeftUpKey()){if(this._isExitOnUpLeft(e))return;if(this._selectComponent(e,'Start','prev'))return}if(this.key===this.keycodes.LEFT)this.utils.trimInvisibleChars('left');else if(this.key===this.keycodes.RIGHT)this.utils.trimInvisibleChars('right')},_isRightDownKey:function(){return([this.keycodes.DOWN,this.keycodes.RIGHT].indexOf(this.key)!==-1)},_isLeftUpKey:function(){return([this.keycodes.UP,this.keycodes.LEFT].indexOf(this.key)!==-1)},_isRightLeftKey:function(){return([this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(this.key)!==-1)},_isExitVariable:function(e){var a=this.selection.getCurrent();var b=this.inspector.parse(a);var c=b.getComponent();if(b.isComponentType('variable')&&b.isComponentActive()){e.preventDefault();var d=(this.key===this.keycodes.LEFT)?'setBefore':'setAfter';this.caret[d](c);return}},_isExitOnUpLeft:function(e){var a=this.selection.getCurrent();var b=this.selection.getBlock(a);var c=this.inspector.parse(a);var d=b.previousElementSibling;var f=this.caret.isStart(b);if(f&&d&&d.tagName==='TABLE'){e.preventDefault();this.caret.setEnd(d);return true}else if(c.isFigcaption()){b=c.getFigcaption();f=this.caret.isStart(b);var g=H.dom(b).closest('.redactor-component');if(f&&g.length!==0){e.preventDefault();this.caret.setEnd(g);return true}}else if(c.isTable()&&f){e.preventDefault();this.caret.setEnd(b.previousElementSibling);return true}else if(!c.isComponentEditable()&&c.isComponent()&&!c.isComponentType('variable')){var h=c.getComponent();if(h.previousElementSibling){e.preventDefault();this.component.clearActive();this.caret.setEnd(h.previousElementSibling);return true}}},_isExitOnDownRight:function(e){var a=this.editor.getElement();var b=this.selection.getCurrent();var c=this.inspector.parse(b);var d=this.caret.isEnd();var f,isEnd;if(c.isTable()){if(isEnd||d){return this._exitNextElement(e,c.getComponent())}}else if(c.isFigcaption()){f=c.getFigcaption();isEnd=this.caret.isEnd(f);if(isEnd||d){return this._exitNextElement(e,c.getComponent())}}else if(c.isComponentType('code')){var g=c.getComponent();var h=H.dom(c.getComponentCodeElement()).closest('pre');isEnd=this.caret.isEnd(f);var i=(h&&h.get().nextElementSibling);if(isEnd&&!i){return this._exitNextElement(e,g)}}else if(c.isPre()||c.isBlockquote()||c.isDl()){if(d){if(c.isPre())return this._exitNextElement(e,c.getPre());else if(c.isBlockquote())return this._exitNextElement(e,c.getBlockquote());else if(c.isDl())return this._exitNextElement(e,c.getDl())}}else if(c.isList()){var j=H.dom(b).parents('ul, ol',a).last();isEnd=this.caret.isEnd(j);if(isEnd||d){return this._exitNextElement(e,j.get())}}else if(c.isComponent()&&!c.isComponentType('variable')&&c.getTag()!=='span'){this.component.clearActive();return this._exitNextElement(e,c.getComponent())}},_exitNextElement:function(e,a){e.preventDefault();if(a.nextElementSibling)this.caret.setStart(a.nextElementSibling);else this.utils.createMarkup(a);return true},_selectComponent:function(e,a,b){var c=this.selection.getCurrent();var d=this.selection.getBlock(c);var f=this.utils.findSiblings(c,b);var g=this.utils.findSiblings(d,b);if(f&&this.caret['is'+a](c)){this._selectComponentItem(e,f,a)}else if(g&&this.caret['is'+a](d)){this._selectComponentItem(e,g,a)}},_selectComponentItem:function(e,a,b){if(this.component.isNonEditable(a)){e.preventDefault();this.caret['set'+b](a);return true}}});H.add('class','input.delete',{init:function(a,e,b){this.app=a;this.opts=a.opts;this.caret=a.caret;this.utils=a.utils;this.editor=a.editor;this.marker=a.marker;this.keycodes=a.keycodes;this.component=a.component;this.inspector=a.inspector;this.selection=a.selection;this.key=b;this._init(e)},_init:function(e){if(this._removeActiveComponent(e))return;if(this._removeAllSelectedTable(e))return;if(this.key===this.keycodes.BACKSPACE){var a=this.editor.getElement();var b=this.utils.trimSpaces(a.html());if(b===this.opts.emptyHtml){e.preventDefault();return}}if(this._detectVariableOrNonEditable()||this.selection.hasNonEditable()){e.preventDefault();return}if(this.selection.isCollapsed()){if(this.key===this.keycodes.BACKSPACE)this._traverseBackspace(e);else if(this.key===this.keycodes.DELETE)this._traverseDelete(e)}if(this.key===this.keycodes.BACKSPACE)this.utils.trimInvisibleChars('left');this._removeUnwantedStyles();this._removeEmptySpans();this._removeSpanTagsInHeadings();this._removeInlineTagsInPre()},_detectVariableOrNonEditable:function(){var a=this.selection.getBlock();var b=this.caret.isStart(a);var c=this.caret.isEnd(a);var d;if(this.key===this.keycodes.BACKSPACE&&b){d=a.previousSibling;if(this._isNonEditable(d))return true}else if(this.key===this.keycodes.DELETE&&c){d=a.nextSibling;if(this._isNonEditable(d))return true}var e=this.selection.getCurrent();var f=this.caret.isStart(e);var g=this.caret.isEnd(e);var h=(this.selection.getTextBeforeCaret().trim()==='');var i=(this.selection.getTextAfterCaret().trim()==='');if(this.key===this.keycodes.BACKSPACE&&f&&!h){d=e.previousSibling;if(this._isVariable(d)){this.caret.setEnd(d);return true}else if(this._isNonEditable(d))return true}else if(this.key===this.keycodes.DELETE&&g&&!i){d=e.nextSibling;if(this._isVariable(d)){this.caret.setStart(d);return true}else if(this._isNonEditable(d))return true}},_isVariable:function(a){return(H.dom(a).closest('[data-redactor-type="variable"]').length!==0)},_isNonEditable:function(a){return(H.dom(a).closest('.non-editable').length!==0)},_getBlock:function(){var a=this.editor.getElement();var b=this.selection.getBlock();var c=this.inspector.parse(b);b=(c.isList())?H.dom(b).parents('ul, ol',a).last().get():b;b=(c.isDl())?c.getDl():b;b=(c.isTable())?c.getTable():b;return b},_traverseDelete:function(e){var a=this.selection.getCurrent();var b=this.inspector.parse(a);var c,isEnd,$next;if(b.isFigcaption()){c=b.getFigcaption();isEnd=this.caret.isEnd(c);if(isEnd){e.preventDefault();return}}else if(b.isComponentType('code')){c=b.getComponent();isEnd=this.caret.isEnd(c);if(isEnd){e.preventDefault();return}}c=this._getBlock();var d=this.utils.findSiblings(c,'next');if(!d)return;isEnd=this.caret.isEnd(c);var f=this.inspector.parse(d);var g=(d.tagName==='P'||d.tagName==='DIV');if(isEnd&&f.isComponentEditable()){e.preventDefault();this.component.remove(d,false);return}else if(isEnd&&f.isComponent()){e.preventDefault();this.caret.setStart(d);if(this.utils.isEmptyHtml(c.innerHTML)){H.dom(c).remove()}return}else if(isEnd&&f.isList()){var h=H.dom(c);$next=H.dom(d);if(b.isList()){e.preventDefault();h.append($next);$next.unwrap();return}else{var i=$next.children('li').first();var j=i.find('ul, ol');if(j.length!==0){e.preventDefault();$next.prepend(j);j.unwrap();h.append(i);i.unwrap();return}}}else if(isEnd&&!b.isList()&&!b.isTable()&&g&&!this.utils.isEmptyHtml(c.innerHTML)){e.preventDefault();var k=H.dom(c);$next=H.dom(d);k.append($next);$next.unwrap();return}},_traverseBackspace:function(e){var a=this.selection.getCurrent();var b=this.inspector.parse(a);var c,isStart,$prev,$currentList;if(b.isFigcaption()){c=b.getFigcaption();isStart=this.caret.isStart(c);if(isStart){e.preventDefault();return}}else if(b.isComponentType('code')){c=b.getComponent();isStart=this.caret.isStart(c);if(isStart&&c.previousElementSibling){e.preventDefault();this.caret.setEnd(c.previousElementSibling);return true}}c=this._getBlock();var d=this.utils.findSiblings(c,'prev');if(!d){setTimeout(this._replaceBlock.bind(this),1);return}isStart=this.caret.isStart(c);var f=this.inspector.parse(d);var g=(d.tagName==='P'||d.tagName==='DIV');if(isStart&&f.isComponentEditable()){e.preventDefault();this.component.remove(d,false);return}else if(isStart&&f.isComponent()){e.preventDefault();this.caret.setStart(d);if(this.utils.isEmptyHtml(c.innerHTML)){H.dom(c).remove()}return}else if(isStart&&b.isList()){e.preventDefault();$currentList=H.dom(c);$prev=H.dom(d);if(f.isList()){$currentList.children('li').first().prepend(this.marker.build('start'));$prev.append($currentList);$currentList.unwrap();this.selection.restoreMarkers()}else{var h=$currentList.children('li').first();var i=h.get();var j=h.find('ul, ol');var k=this.utils.replaceToTag(i,this.opts.markup);if(this.opts.breakline)k.attr('data-redactor-tag','br');$currentList.before(k);this.caret.setStart(k);if(j.length!==0){$currentList.prepend(j);j.unwrap()}}return}else if(isStart&&g){e.preventDefault();var l=this.utils.createInvisibleChar();var m=H.dom(c);$prev=H.dom(d);this.caret.setEnd($prev);m.prepend(l);$prev.append(m.contents());m.remove();return}},_replaceBlock:function(){var a=this.selection.getBlock();var b=H.dom(a);if(this.opts.markup==='p'&&a&&this._isNeedToReplaceBlock(a)){var c=document.createElement(this.opts.markup);b.replaceWith(c);this.caret.setStart(c)}if(this.opts.breakline&&a&&a.tagName==='DIV'){b.attr('data-redactor-tag','br')}},_isNeedToReplaceBlock:function(a){return(a.tagName==='DIV'&&this.utils.isEmptyHtml(a.innerHTML))},_removeActiveComponent:function(e){var a=this.selection.getCurrent();var b=this.inspector.parse(a);var c=b.getComponent();if(b.isComponent()&&this.component.isActive(c)){e.preventDefault();this.component.remove(c);return true}},_removeAllSelectedTable:function(e){var a=this.selection.getCurrent();var b=this.inspector.parse(a);var c=b.getTable();if(c&&this.selection.isAll(c)){e.preventDefault();this.component.remove(c);return true}},_removeUnwantedStyles:function(){var b=this.editor.getElement();setTimeout(function(){var a=b.find('*[style]');a.not('img, figure, iframe, [data-redactor-style-cache], [data-redactor-span]').removeAttr('style')},0)},_removeEmptySpans:function(){var b=this.editor.getElement();setTimeout(function(){b.find('span').each(function(a){if(a.attributes.length===0){H.dom(a).replaceWith(a.childNodes)}})},0)},_removeSpanTagsInHeadings:function(){var c=this.editor.getElement();setTimeout(function(){c.find('h1, h2, h3, h4, h5, h6').each(function(a){var b=H.dom(a);if(b.closest('figure').length===0){b.find('span').not('.redactor-component, .non-editable, .redactor-selection-marker, [data-redactor-style-cache], [data-redactor-span]').unwrap()}})},1)},_removeInlineTagsInPre:function(){var c=this.editor.getElement();var d=this.opts.inlineTags;setTimeout(function(){c.find('pre').each(function(a){var b=H.dom(a);if(b.closest('figure').length===0){b.find(d.join(',')).not('code, .redactor-selection-marker').unwrap()}})},1)}});H.add('class','input.enter',{init:function(a,e){this.app=a;this.opts=a.opts;this.utils=a.utils;this.caret=a.caret;this.editor=a.editor;this.insertion=a.insertion;this.selection=a.selection;this.inspector=a.inspector;this._init(e)},_init:function(e){if(!this.opts.enterKey)return this._disable(e);var a=this.app.broadcast('enter',e);if(a===false)return e.preventDefault();if(this.selection.hasNonEditable()){e.preventDefault();return}if(e.ctrlKey||e.shiftKey)return this._insertBreak(e);if(this._isExit(e))return;this._traverse(e)},_disable:function(e){e.preventDefault();var a=this.selection.getRange();if(a&&!a.collapsed)a.deleteContents()},_insertBreak:function(e){e.preventDefault();var a=this.selection.getCurrent();var b=this.inspector.parse(a);if((b.isComponent()&&!b.isComponentEditable())||b.isCode())return;else if(b.isPre())this.insertion.insertNewline();else this.insertion.insertBreakLine()},_isExit:function(e){var a=this.editor.getElement();var b=this.selection.getBlock();var c=this.inspector.parse(b);var d=this.caret.isEnd(b);var f=this.selection.getCurrent();var g=f.previousSibling;if(c.isBlockquote()){var h=(d&&this._isExitableBlock(b,'P'));var i=(d&&this._isExitableDblBreak(g));if(h||i){return this._exitFromElement(e,((i)?g:b),c.getBlockquote())}}else if(!c.isComponentType('code')&&c.isPre()){if(d){var j=b.innerHTML;j=this.utils.removeInvisibleChars(j);if(j.match(/(\n\n\n)$/)!==null){H.dom(g.previousSibling.previousSibling).remove();return this._exitFromElement(e,g,b)}}}else if(c.isDl()){if(d&&this._isExitableBlock(b,'DT')){return this._exitFromElement(e,b,c.getDl())}}else if(c.isList()){var k=H.dom(f).parents('ul, ol',a).last();d=this.caret.isEnd(k);if(d&&this._isExitableBlock(b,'LI')){return this._exitFromElement(e,b,k)}}else if(c.isComponent()&&c.isComponentActive()&&!c.isFigcaption()&&!c.isComponentEditable()){return this._exitFromElement(e,false,c.getComponent())}},_isExitableDblBreak:function(a){var b=(a)?a.nextSibling:false;if(b){var c=this.utils.removeInvisibleChars(b.textContent);return(b.nodeType===3&&c.trim()==='')}},_isExitableBlock:function(a,b){return(a&&a.tagName===b&&this.utils.isEmptyHtml(a.innerHTML))},_exitFromElement:function(e,a,b){e.preventDefault();if(a)H.dom(a).remove();this.utils.createMarkup(b);return true},_exitNextElement:function(e,a){e.preventDefault();if(a.nextSibling)this.caret.setStart(a.nextSibling);else this.utils.createMarkup(a);return true},_traverse:function(e){var a=this.selection.getCurrent();var b=this.selection.isText();var c=this.selection.getBlock();var d=this.inspector.parse(a);var f=(c)?c.tagName.toLowerCase():false;if(d.isPre()){e.preventDefault();return this.insertion.insertNewline()}else if(d.isBlockquote()){c=this.selection.getBlock(a);if(c&&c.tagName==='BLOCKQUOTE'){e.preventDefault();return this.insertion.insertBreakLine()}}else if(d.isFigcaption()){c=d.getFigcaption();var g=this.caret.isEnd(c);var h=this.caret.isEnd();if(g||h){return this._exitNextElement(e,d.getComponent())}else{e.preventDefault();return}}else if(d.isDl()){e.preventDefault();return this._traverseDl(a)}else if(b||(this.opts.breakline&&f==='div')){e.preventDefault();return this.insertion.insertBreakLine()}else{setTimeout(this._replaceBlock.bind(this),1);return}},_traverseDl:function(a){var b=this.selection.getBlock(a);var c=this.inspector.parse(b);var d=c.getTag();var e=H.dom(b);var f=e.get().nextSibling||false;var g=H.dom(f);var h=(f&&g.is('dd'));var i=(f&&g.is('dt'));var j=this.caret.isEnd(b);if(d==='dt'&&!h&&j){var k=document.createElement('dd');e.after(k);this.caret.setStart(k);return}else if(d==='dd'&&!i&&j){var l=document.createElement('dt');e.after(l);this.caret.setStart(l);return}return this.insertion.insertBreakLine()},_replaceBlock:function(){var a=this.selection.getBlock();var b=H.dom(a);if(this.opts.markup==='p'&&a&&this._isNeedToReplaceBlock(a)){var c=document.createElement(this.opts.markup);b.replaceWith(c);this.caret.setStart(c)}else{if(a){if(this.utils.isEmptyHtml(a.innerHTML)){this._clearBlock(b,a)}else{var d=this.utils.getFirstNode(a);if(d&&d.tagName==='BR'){H.dom(d).remove();this.caret.setStart(a)}}}}if(a&&this._isNeedToCleanBlockStyle(a)&&this.opts.cleanOnEnter){b.removeAttr('class style')}if(this.opts.breakline&&a&&a.tagName==='DIV'){b.attr('data-redactor-tag','br')}},_clearBlock:function(a,b){if(this.opts.cleanInlineOnEnter||b.innerHTML==='<br>'){a.html('')}this.caret.setStart(b)},_isNeedToReplaceBlock:function(a){return(a.tagName==='DIV'&&this.utils.isEmptyHtml(a.innerHTML))},_isNeedToCleanBlockStyle:function(a){return(a.tagName==='P'&&this.utils.isEmptyHtml(a.innerHTML))}});H.add('class','input.paste',{init:function(a,e,b,c,d){this.app=a;this.opts=a.opts;this.editor=a.editor;this.cleaner=a.cleaner;this.container=a.container;this.inspector=a.inspector;this.insertion=a.insertion;this.selection=a.selection;this.autoparser=a.autoparser;this.pasteHtml=c;this.pointInserted=d;this.dataTransfer=b;this._init(e)},_init:function(e){var a=this.dataTransfer||e.clipboardData;var b=this.selection.getCurrent();var c=this.inspector.parse(b);this.dropPasted=this.dataTransfer;this.isRawCode=(c.isPre()||c.isCode());this.editor.enablePasting();this.editor.saveScroll();if(!this.dropPasted){this.selection.saveMarkers()}if(this.isRawCode||!a){var d;if(!this.isRawCode&&!a&&window.clipboardData){d=window.clipboardData.getData("text")}else{d=a.getData("text/plain")}e.preventDefault();this._insert(e,d);return}else if(this.pasteHtml){e.preventDefault();this._insert(e,this.pasteHtml)}else{var f=a.getData('URL');var g=(this._isPlainText(a))?a.getData("text/plain"):a.getData("text/html");g=(!f||f==='')?g:f;if(a.files.length>0&&g===''){var h=[];for(var i=0;i<a.files.length;i++){var j=a.files[i]||a.items[i].getAsFile();if(j)h.push(j)}if(h.length>0){e.preventDefault();this._insertFiles(e,h);return}}e.preventDefault();this._insert(e,g)}},_isPlainText:function(a){var b=a.getData("text/plain");var c=a.getData("text/html");if(b&&c){var d=document.createElement("div");d.innerHTML=c;if(d.textContent===b){return!d.querySelector(":not(meta)")}}else{return(b!==null)}},_restoreSelection:function(){this.editor.restoreScroll();this.editor.disablePasting();if(!this.dropPasted){this.selection.restoreMarkers()}},_insert:function(e,a){var b=this.app.broadcast('pasteBefore',a);a=(b===undefined)?a:b;a=(this.isRawCode)?a:this.cleaner.paste(a);a=(this.isRawCode)?this.cleaner.encodePhpCode(a):a;b=this.app.broadcast('pasting',a);a=(b===undefined)?a:b;this._restoreSelection();if(!this.opts.input)return;if(this.opts.autoparse&&this.opts.autoparsePaste){a=this.autoparser.parse(a)}var c=(this.dropPasted)?this.insertion.insertToPoint(e,a,this.pointInserted):this.insertion.insertHtml(a);this.app.broadcast('pasted',c);this.app.broadcast('autoparseobserve')},_insertFiles:function(e,a){this._restoreSelection();var b=(this.opts.imageTypes.indexOf(a[0].type)!==-1);var c=(typeof this.dropPasted==='undefined');if(b)this.app.broadcast('dropimage',e,a,c);else this.app.broadcast('dropfile',e,a,c)}});H.add('class','input.shortcode',{init:function(a,e,b){this.app=a;this.opts=a.opts;this.utils=a.utils;this.marker=a.marker;this.keycodes=a.keycodes;this.selection=a.selection;this.worked=false;if(b===this.keycodes.SPACE)this._init()},is:function(){return this.worked},_init:function(){var a=this.selection.getCurrent();if(a&&a.nodeType===3){var b=this.utils.removeInvisibleChars(a.textContent);var c=this.opts.shortcodes;for(var d in c){var e=new RegExp('^'+this.utils.escapeRegExp(d));var f=b.match(e);if(f!==null){if(typeof c[d].format!=='undefined'){return this._format(c[d].format,a,e)}}}}},_format:function(a,b,c){var d=this.marker.insert('start');b=d.previousSibling;var e=b.textContent;e=this.utils.trimSpaces(e);e=e.replace(c,'');b.textContent=e;var f=(a==='ul'||a==='ol')?'module.list.toggle':'module.block.format';this.app.api(f,a);this.selection.restoreMarkers();this.worked=true}});H.add('class','input.shortcut',{init:function(a,e){this.app=a;this.opts=a.opts;this.worked=false;this.hotkeys={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};this.hotkeysShiftNums={"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":": ","'":"\"",",":"<",".":">","/":"?","\\":"|"};this._init(e)},is:function(){return this.worked},_init:function(e){if(this.opts.shortcuts===false){if((e.ctrlKey||e.metaKey)&&(e.which===66||e.which===73))e.preventDefault();return}for(var a in this.opts.shortcuts){this._build(e,a,this.opts.shortcuts[a])}},_build:function(e,a,b){var c=a.split(',');var d=c.length;for(var i=0;i<d;i++){if(typeof c[i]==='string'){this._handler(e,c[i].trim(),b)}}},_handler:function(e,a,b){a=a.toLowerCase().split(" ");var c=this.hotkeys[e.keyCode];var d=String.fromCharCode(e.which).toLowerCase();var f="",possible={};var g=["alt","ctrl","meta","shift"];for(var i=0;i<g.length;i++){var h=g[i];if(e[h+'Key']&&c!==h){f+=h+'+'}}if(c)possible[f+c]=true;if(d){possible[f+d]=true;possible[f+this.hotkeysShiftNums[d]]=true;if(f==="shift+"){possible[this.hotkeysShiftNums[d]]=true}}var j=a.length;for(var i=0;i<j;i++){if(possible[a[i]]){e.preventDefault();this.worked=true;if(b.message){this.app.broadcast(b.message,b.args)}else if(b.api){this.app.api(b.api,b.args)}return}}}});H.add('class','input.space',{init:function(a,e,b,c){this.app=a;this.keycodes=a.keycodes;this.insertion=a.insertion;this.selection=a.selection;this.key=b;this.lastShiftKey=c;this._init(e)},_init:function(e){if(this.selection.hasNonEditable()){e.preventDefault();return}if(!this.lastShiftKey&&this.key===this.keycodes.SPACE&&(e.ctrlKey||e.shiftKey)&&!e.metaKey){e.preventDefault();this.insertion.insertChar('&nbsp;');return}}});H.add('class','input.tab',{init:function(a,e){this.app=a;this.opts=a.opts;this.inspector=a.inspector;this.insertion=a.insertion;this.selection=a.selection;this._init(e)},_init:function(e){if(!this.opts.tabKey)return;var a=this.app.broadcast('tab',e);if(a===false)return e.preventDefault();this._traverse(e)},_traverse:function(e){var a=this.selection.getCurrent();var b=this.inspector.parse(a);if(!b.isComponent()&&e.shiftKey){return this._insertHardTab(e,4)}if(b.isList()){e.preventDefault();return this.app.api('module.list.indent')}if(b.isPre()||(b.isComponentType('code')&&!b.isFigcaption())){return this._tabCode(e)}if(this.opts.tabAsSpaces!==false){return this._insertHardTab(e,this.opts.tabAsSpaces)}},_insertHardTab:function(e,a){e.preventDefault();var b=document.createTextNode(Array(a+1).join('\u00a0'));return this.insertion.insertNode(b,'end')},_tabCode:function(e){e.preventDefault();var a=(this.opts.preSpaces)?document.createTextNode(Array(this.opts.preSpaces+1).join('\u00a0')):document.createTextNode('\t');return this.insertion.insertNode(a,'end')}});H.add('module','upload',{init:function(a){this.app=a;this.opts=a.opts;this.lang=a.lang;this.utils=a.utils;this.editor=a.editor;this.progress=a.progress;this.defaults={event:false,element:false,name:false,files:false,url:false,data:false,paramName:false}},build:function(a){this.p=H.extend(this.defaults,a);this.$el=H.dom(this.p.element);if(this.$el.get().tagName==='INPUT')this._buildInput();else this._buildBox()},send:function(a){this.p=H.extend(this.defaults,a);this.$uploadbox=this.editor.getElement();this._send(this.p.event,this.p.files)},complete:function(a,e){this._complete(a,e)},_buildInput:function(){this.box=false;this.prefix='';this.$uploadbox=H.dom('<div class="upload-box" />');this.$el.hide();this.$el.after(this.$uploadbox);if(this.opts.multipleUpload)this.$el.attr('multiple','multiple');else this.$el.removeAttr('multiple');this._buildPlaceholder();this._buildEvents()},_buildBox:function(){this.box=true;this.prefix='box-';this.$uploadbox=this.$el;this.$uploadbox.attr('ondragstart','return false;');this.$uploadbox.on('drop.redactor.upload',this._onDropBox.bind(this));this.$uploadbox.on('dragover.redactor.upload',this._onDragOver.bind(this));this.$uploadbox.on('dragleave.redactor.upload',this._onDragLeave.bind(this))},_buildPlaceholder:function(){this.$placeholder=H.dom('<div class="upload-placeholder" />');this.$placeholder.html(this.lang.get('upload-label'));this.$uploadbox.append(this.$placeholder)},_buildEvents:function(){this.$el.on('change.redactor.upload',this._onChange.bind(this));this.$uploadbox.on('click.redactor.upload',this._onClick.bind(this));this.$uploadbox.on('drop.redactor.upload',this._onDrop.bind(this));this.$uploadbox.on('dragover.redactor.upload',this._onDragOver.bind(this));this.$uploadbox.on('dragleave.redactor.upload',this._onDragLeave.bind(this))},_onClick:function(e){e.preventDefault();this.$el.click()},_onChange:function(e){this._send(e,this.$el.get().files)},_onDrop:function(e){e.preventDefault();this._clear();this._setStatusDrop();this._send(e)},_onDragOver:function(e){e.preventDefault();this._setStatusHover();return false},_onDragLeave:function(e){e.preventDefault();this._removeStatusHover();return false},_onDropBox:function(e){e.preventDefault();this._clear();this._setStatusDrop();this._send(e)},_removeStatusHover:function(){this.$uploadbox.removeClass('upload-'+this.prefix+'hover')},_setStatusDrop:function(){this.$uploadbox.addClass('upload-'+this.prefix+'drop')},_setStatusHover:function(){this.$uploadbox.addClass('upload-'+this.prefix+'hover')},_setStatusError:function(){this.$uploadbox.addClass('upload-'+this.prefix+'error')},_setStatusSuccess:function(){this.$uploadbox.addClass('upload-'+this.prefix+'success')},_clear:function(){var a=['drop','hover','error','success'];for(var i=0;i<a.length;i++){this.$uploadbox.removeClass('upload-'+this.prefix+a[i])}this.$uploadbox.removeAttr('ondragstart')},_send:function(e,a){e=e.originalEvent||e;a=(a)?a:e.dataTransfer.files;var b=new FormData();var c=this._getUploadParam();b=this._buildData(c,a,b);b=this.utils.extendData(b,this.p.data);var d=this.app.broadcast('upload.start',e,b,a);if(d!==false){this._sendData(b,a,e)}},_sendData:function(b,c,e){this.progress.show();if(typeof this.p.url==='function'){var d=this.p.url(b,c,e,this);if(!(d instanceof Promise)){this._complete(d,e)}}else{H.ajax.post({url:this.p.url,data:b,before:function(a){return this.app.broadcast('upload.beforeSend',a)}.bind(this),success:function(a){this._complete(a,e)}.bind(this)})}},_getUploadParam:function(){return(this.p.paramName)?this.p.paramName:'file'},_buildData:function(a,b,c){if(b.length===1){c.append(a+'[]',b[0])}else if(b.length>1&&this.opts.multipleUpload!==false){for(var i=0;i<b.length;i++){c.append(a+'[]',b[i])}}return c},_complete:function(a,e){this._clear();this.progress.hide();if(a&&a.error){this._setStatusError();this.app.broadcast('upload.'+this.p.name+'.error',a,e);this.app.broadcast('upload.error',a)}else{this._setStatusSuccess();this.app.broadcast('upload.'+this.p.name+'.complete',a,e);this.app.broadcast('upload.complete',a);setTimeout(this._clear.bind(this),500)}}});H.add('class','code.component',{mixins:['dom','component'],init:function(a,b){this.app=a;return(b&&b.cmnt!==undefined)?b:this._init(b)},_init:function(a){var b;if(typeof a!=='undefined'){var c=H.dom(a);var d=c.closest('figure');if(d.length!==0){this.parse(d)}else{this.parse('<figure>');this.append(a)}b=this.find('pre code, pre').last()}else{b=H.dom('<pre>');this.parse('<figure>');this.append(b)}this._initElement(b);this._initWrapper()},_initElement:function(a){a.attr({'tabindex':'-1','contenteditable':true})},_initWrapper:function(){this.addClass('redactor-component');this.attr({'data-redactor-type':'code','tabindex':'-1','contenteditable':false})}});H.add('module','form',{init:function(a){this.app=a;this.lang=a.lang;this.component=a.component;this.inspector=a.inspector},onform:{remove:function(a){this._remove(a)}},oncontextbar:function(e,a){var b=this.inspector.parse(e.target);if(b.isComponentType('form')){var c=b.getComponent();var d={"remove":{title:this.lang.get('delete'),api:'module.form.remove',args:c}};a.set(e,c,d,'top')}},_remove:function(a){this.component.remove(a)}});H.add('class','form.component',{mixins:['dom','component'],init:function(a,b){this.app=a;this.utils=a.utils;return(b&&b.cmnt!==undefined)?b:this._init(b)},_init:function(a){if(typeof a!=='undefined'){var b=H.dom(a);var c=b.closest('form');if(c.length!==0){var d=this.utils.replaceToTag(a,'figure');this.parse(d)}else{this.parse('<figure>');this.append(a)}}else{this.parse('<figure>')}this._initWrapper()},_initWrapper:function(){this.addClass('redactor-component');this.attr({'data-redactor-type':'form','tabindex':'-1','contenteditable':false})}});H.add('module','image',{modals:{'image':'<div class="redactor-modal-tab" data-title="## upload ##"><form action="">                 <input type="file" name="file">             </form></div>','imageedit':'<div class="redactor-modal-group">                 <div id="redactor-modal-image-preview" class="redactor-modal-side"></div>                 <form action="" class="redactor-modal-area">                     <div class="form-item">                         <label for="modal-image-title"> ## title ##</label>                         <input type="text" id="modal-image-title" name="title" />                     </div>                     <div class="form-item">                         <label for="modal-image-caption">## caption ##</label>                         <input type="text" id="modal-image-caption" name="caption" aria-label="## caption ##" />                     </div>                     <div class="form-item form-item-align">                         <label>## image-position ##</label>                         <select name="align" aria-label="## image-position ##">                             <option value="none">## none ##</option>                             <option value="left">## left ##</option>                             <option value="center">## center ##</option>                             <option value="right">## right ##</option>                         </select>                     </div>                     <div class="form-item">                         <label for="modal-image-url">## link ##</label>                         <input type="text" id="modal-image-url" name="url" aria-label="## link ##" />                     </div>                     <div class="form-item">                         <label class="checkbox"><input type="checkbox" name="target" aria-label="## link-in-new-tab ##"> ## link-in-new-tab ##</label>                     </div>                 </form>             </div>'},init:function(a){this.app=a;this.opts=a.opts;this.lang=a.lang;this.caret=a.caret;this.utils=a.utils;this.editor=a.editor;this.storage=a.storage;this.component=a.component;this.inspector=a.inspector;this.insertion=a.insertion;this.selection=a.selection;this.justResized=false},oninsert:function(){this._observeImages()},onstarted:function(){this.storage.observeImages();if(this.opts.imageResizable){this.resizer=H.create('image.resize',this.app)}this._observeImages()},ondropimage:function(e,a,b){if(!this.opts.imageUpload)return;var c={url:this.opts.imageUpload,event:(b)?false:e,files:a,name:'imagedrop',data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api('module.upload.send',c)},onstop:function(){if(this.resizer)this.resizer.stop()},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),'image')},onimageresizer:{stop:function(){if(this.resizer)this.resizer.hide()}},onsource:{open:function(){if(this.resizer)this.resizer.hide()},closed:function(){this._observeImages();if(this.resizer)this.resizer.rebuild()}},onupload:{complete:function(){this._observeImages()},image:{complete:function(a){this._insert(a)},error:function(a){this._uploadError(a)}},imageedit:{complete:function(a){this._change(a)},error:function(a){this._uploadError(a)}},imagedrop:{complete:function(a,e){this._insert(a,e)},error:function(a){this._uploadError(a)}},imagereplace:{complete:function(a){this._change(a,false)},error:function(a){this._uploadError(a)}}},onmodal:{image:{open:function(a,b){this._setUpload(b)}},imageedit:{open:function(a,b){this._setFormData(a,b)},opened:function(a,b){this._setFormFocus(b)},remove:function(){this._remove(this.$image)},save:function(a,b){this._save(a,b)}}},onimage:{observe:function(){this._observeImages()},resized:function(){this.justResized=true}},oncontextbar:function(e,a){if(this.justResized){this.justResized=false;return}var b=this.selection.getCurrent();var c=this.inspector.parse(b);if(!c.isFigcaption()&&c.isComponentType('image')){var d=c.getComponent();var f={"edit":{title:this.lang.get('edit'),api:'module.image.open'},"remove":{title:this.lang.get('delete'),api:'module.image.remove',args:d}};a.set(e,d,f)}},open:function(){this.$image=this._getCurrent();this.app.api('module.modal.build',this._getModalData())},insert:function(a){this._insert(a)},remove:function(a){this._remove(a)},_getModalData:function(){var a;if(this._isImage()&&this.opts.imageEditable){a={name:'imageedit',width:'800px',title:this.lang.get('edit'),handle:'save',commands:{save:{title:this.lang.get('save')},remove:{title:this.lang.get('delete'),type:'danger'},cancel:{title:this.lang.get('cancel')}}}}else{a={name:'image',title:this.lang.get('image')}}return a},_isImage:function(){return this.$image},_getCurrent:function(){var a=this.selection.getCurrent();var b=this.inspector.parse(a);return(b.isComponentType('image')&&b.isComponentActive())?this.component.create('image',b.getComponent()):false},_insert:function(a,e){this.app.api('module.modal.close');if(Array.isArray(a)){var b={};for(var i=0;i<a.length;i++){b=H.extend(b,a[i])}a=b}else if(typeof a==='string'){a={"file":{url:a}}}if(typeof a==='object'){var c=(Object.keys(a).length>1);if(c){this._insertMultiple(a,e)}else{this._insertSingle(a,e)}}},_insertSingle:function(a,e){for(var b in a){var c=this._createImageAndStore(a[b]);var d=(e)?this.insertion.insertToPoint(e,c):this.insertion.insertHtml(c);this._removeSpaceBeforeFigure(d[0]);this.component.setActive(d[0]);this.app.broadcast('image.uploaded',d[0],a)}},_insertMultiple:function(a,e){var z=0;var b=[];var c;for(var d in a){z++;var f=this._createImageAndStore(a[d]);if(z===1){b=(e)?this.insertion.insertToPoint(e,f):this.insertion.insertHtml(f)}else{var g=H.dom(b[0]);g.after(f);b=[f.get()];this.app.broadcast('image.inserted',f)}c=b[0];this._removeSpaceBeforeFigure(b[0]);this.app.broadcast('image.uploaded',b[0],a)}this.component.setActive(c)},_createImageAndStore:function(a){var b=this.component.create('image');b.addClass('redactor-uploaded-figure');b.setData({src:a.url,id:(a.id)?a.id:this.utils.getRandomId()});this.storage.add('image',b.getElement());return b},_removeSpaceBeforeFigure:function(a){if(!a)return;var b=a.previousSibling;if(b){this._removeInvisibleSpace(b);this._removeInvisibleSpace(b.previousSibling)}},_removeInvisibleSpace:function(a){if(a&&a.nodeType===3&&this.utils.searchInvisibleChars(a.textContent)!==-1){a.parentNode.removeChild(a)}},_save:function(a,b){var c=b.getData();var d={title:c.title,link:{url:c.url,target:c.target}};if(this.opts.imageCaption)d.caption=c.caption;if(this.opts.imagePosition)d.align=c.align;this.$image.setData(d);if(this.resizer)this.resizer.rebuild();this.app.broadcast('image.changed',this.$image);this.app.api('module.modal.close')},_change:function(a,b){if(typeof a==='string'){a={"file":{url:a}}}if(typeof a==='object'){var c;for(var d in a){c=H.dom('<img>');c.attr('src',a[d].url);this.$image.changeImage(a[d]);this.app.broadcast('image.changed',this.$image,a);this.app.broadcast('image.uploaded',this.$image,a);break}if(b!==false){c.on('load',function(){this.$previewBox.html(c)}.bind(this))}}},_uploadError:function(a){this.app.broadcast('image.uploadError',a)},_remove:function(a){this.app.api('module.modal.close');this.component.remove(a)},_observeImages:function(){var c=this.editor.getElement();var d=this;c.find('img').each(function(a){var b=H.dom(a);b.off('.drop-to-replace');b.on('dragover.drop-to-replace dragenter.drop-to-replace',function(e){e.preventDefault();return});b.on('drop.drop-to-replace',function(e){if(!d.app.isDragComponentInside()){return d._setReplaceUpload(e,b)}})})},_setFormData:function(a,b){this._buildPreview();this._buildPreviewUpload();var c=this.$image.getData();var d={title:c.title};if(this.opts.imageCaption)d.caption=c.caption;else a.find('.form-item-caption').hide();if(this.opts.imagePosition)d.align=c.align;else a.find('.form-item-align').hide();if(c.link){d.url=c.link.url;if(c.link.target)d.target=true}b.setData(d)},_setFormFocus:function(a){a.getField('title').focus()},_setReplaceUpload:function(e,a){e=e.originalEvent||e;e.stopPropagation();e.preventDefault();if(!this.opts.imageUpload)return;this.$image=this.component.create('image',a);var b={url:this.opts.imageUpload,files:e.dataTransfer.files,name:'imagereplace',data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api('module.upload.send',b);return},_setUpload:function(a){var b={url:this.opts.imageUpload,element:a.getField('file'),name:'image',data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api('module.upload.build',b)},_buildPreview:function(){this.$preview=H.dom('#redactor-modal-image-preview');var a=this.$image.getData();var b=H.dom('<img>');b.attr('src',a.src);this.$previewBox=H.dom('<div>');this.$previewBox.append(b);this.$preview.html('');this.$preview.append(this.$previewBox)},_buildPreviewUpload:function(){if(!this.opts.imageUpload)return;var a=H.dom('<div class="desc">');a.html(this.lang.get('upload-change-label'));this.$preview.append(a);var b={url:this.opts.imageUpload,element:this.$previewBox,name:'imageedit',paramName:this.opts.imageUploadParam};this.app.api('module.upload.build',b)}});H.add('class','image.component',{mixins:['dom','component'],init:function(a,b){this.app=a;this.opts=a.opts;this.selection=a.selection;return(b&&b.cmnt!==undefined)?b:this._init(b)},setData:function(a){for(var b in a){this._set(b,a[b])}},getData:function(){var a=['src','title','caption','align','link','id'];var b={};for(var i=0;i<a.length;i++){b[a[i]]=this._get(a[i])}return b},getElement:function(){return this.$element},changeImage:function(a){this.$element.attr('src',a.url)},_init:function(a){var b=H.dom(a);var c=b.closest('figure');if(a===undefined){this.$element=H.dom('<img>');this.parse('<figure>');this.append(this.$element)}else if(c.length===0){this.parse('<figure>');this.$element=b;this.$element.wrap(this)}else{this.parse(c);this.$element=this.find('img')}this._initWrapper()},_set:function(a,b){this['_set_'+a](b)},_get:function(a){return this['_get_'+a]()},_set_src:function(a){this.$element.attr('src',a)},_set_id:function(a){this.$element.attr('data-image',a)},_set_title:function(a){a=a.trim().replace(/(<([^>]+)>)/ig,"");if(a===''){this.$element.removeAttr('alt');this.$element.removeAttr('title')}else{this.$element.attr('alt',a);this.$element.attr('title',a)}},_set_caption:function(a){var b=this.find('figcaption');if(b.length===0){b=H.dom('<figcaption>');b.attr('contenteditable','true');this.append(b)}if(a==='')b.remove();else b.html(a);return b},_set_align:function(a){var b='';var c='';var d='';var e=this;if(typeof this.opts.imagePosition==='object'){var f=this.opts.imagePosition;for(var g in f){e.removeClass(f[g])}var h=(typeof f[a]!=='undefined')?f[a]:false;if(h){e.addClass(h)}}else{switch(a){case'left':b='left';c='0 '+this.opts.imageFloatMargin+' '+this.opts.imageFloatMargin+' 0';break;case'right':b='right';c='0 0 '+this.opts.imageFloatMargin+' '+this.opts.imageFloatMargin;break;case'center':d='center';break}e.css({'float':b,'margin':c,'text-align':d});e.attr('rel',e.attr('style'))}},_set_link:function(a){var b=this._findLink();if(a.url===''){if(b)b.unwrap();return}if(!b){b=H.dom('<a>');this.$element.wrap(b)}b.attr('href',a.url);if(a.target)b.attr('target',a.target);else b.removeAttr('target');return b},_get_src:function(){return this.$element.attr('src')},_get_id:function(){return this.$element.attr('data-image')},_get_title:function(){var a=this.$element.attr('alt');var b=this.$element.attr('title');if(a)return a;else if(b)return b;else return''},_get_caption:function(){var a=this.find('figcaption');if(a.length===0){return''}else{return a.html()}},_get_align:function(){var a='';if(typeof this.opts.imagePosition==='object'){a='none';var b=this.opts.imagePosition;for(var c in b){if(this.hasClass(b[c])){a=c;break}}}else{a=(this.css('text-align')==='center')?'center':this.css('float')}return a},_get_link:function(){var a=this._findLink();if(a){var b=(a.attr('target'))?true:false;return{url:a.attr('href'),target:b}}},_initWrapper:function(){this.addClass('redactor-component');this.attr({'data-redactor-type':'image','tabindex':'-1','contenteditable':false})},_findLink:function(){var b=this.find('a').filter(function(a){return(H.dom(a).closest('figcaption').length===0)});if(b.length!==0){return b}return false}});H.add('class','image.resize',{init:function(a){this.app=a;this.$doc=a.$doc;this.$win=a.$win;this.$body=a.$body;this.editor=a.editor;this.toolbar=a.toolbar;this.inspector=a.inspector;this.$target=(this.toolbar.isTarget())?this.toolbar.getTargetElement():this.$body;this._init()},rebuild:function(){this._setResizerPosition()},hide:function(){this.$target.find('#redactor-image-resizer').remove()},stop:function(){var a=this.editor.getElement();a.off('.redactor.image-resize');this.$doc.off('.redactor.image-resize');this.$win.off('resize.redactor.image-resize');this.hide()},_init:function(){var a=this.editor.getElement();a.on('click.redactor.image-resize',this._build.bind(this));this.$win.on('resize.redactor.image-resize',this._setResizerPosition.bind(this))},_build:function(e){this.$target.find('#redactor-image-resizer').remove();var a=this.inspector.parse(e.target);var b=this.editor.getElement();if(a.isComponentType('image')){this.$resizableBox=b;this.$resizableImage=H.dom(a.getImageElement());this.$resizer=H.dom('<span>');this.$resizer.attr('id','redactor-image-resizer');this.$target.append(this.$resizer);this._setResizerPosition();this.$resizer.on('mousedown touchstart',this._set.bind(this))}},_setResizerPosition:function(){if(this.$resizer){var a=this.toolbar.isTarget();var b=this.$target.offset();var c=7;var d=(a)?(c-b.top+this.$target.scrollTop()):c;var e=(a)?(c-b.left):c;var f=this.$resizableImage.offset();var g=this.$resizableImage.width();var h=this.$resizableImage.height();var i=this.$resizer.width();var j=this.$resizer.height();this.$resizer.css({top:(f.top+h-j+d)+'px',left:(f.left+g-i+e)+'px'})}},_set:function(e){e.preventDefault();this.resizeHandle={x:e.pageX,y:e.pageY,el:this.$resizableImage,ratio:this.$resizableImage.width()/this.$resizableImage.height(),h:this.$resizableImage.height()};e=e.originalEvent||e;if(e.targetTouches){this.resizeHandle.x=e.targetTouches[0].pageX;this.resizeHandle.y=e.targetTouches[0].pageY}this.app.broadcast('contextbar.close');this.app.broadcast('image.resize',this.$resizableImage);this._start()},_start:function(){this.$doc.on('mousemove.redactor.image-resize touchmove.redactor.image-resize',this._move.bind(this));this.$doc.on('mouseup.redactor.image-resize touchend.redactor.image-resize',this._stop.bind(this))},_stop:function(){this.$doc.off('.redactor.image-resize');this.app.broadcast('image.resized',this.$resizableImage)},_move:function(e){e.preventDefault();e=e.originalEvent||e;var a=this.resizeHandle.h;if(e.targetTouches)a+=(e.targetTouches[0].pageY-this.resizeHandle.y);else a+=(e.pageY-this.resizeHandle.y);var b=a*this.resizeHandle.ratio;if(a<50||b<100)return;if(this._getResizableBoxWidth()<=b)return;this.resizeHandle.el.attr({width:b,height:a});this.resizeHandle.el.width(b);this.resizeHandle.el.height(a);this._setResizerPosition()},_getResizableBoxWidth:function(){var a=this.$resizableBox.width();return a-parseInt(this.$resizableBox.css('padding-left'))-parseInt(this.$resizableBox.css('padding-right'))}});H.add('module','file',{modals:{'file':'<div class="redactor-modal-tab" data-title="## upload ##"><form action="">                 <div class="form-item form-item-title">                     <label for="modal-file-title"> ## filename ## <span class="desc">(## optional ##)</span></label>                     <input type="text" id="modal-file-title" name="title" />                 </div>                 <input type="file" name="file">             </form></div>'},init:function(a){this.app=a;this.opts=a.opts;this.lang=a.lang;this.caret=a.caret;this.utils=a.utils;this.storage=a.storage;this.component=a.component;this.inspector=a.inspector;this.insertion=a.insertion;this.selection=a.selection},onstarted:function(){this.storage.observeFiles()},ondropfile:function(e,a,b){if(!this.opts.fileUpload)return;var c={url:this.opts.fileUpload,event:(b)?false:e,files:a,name:'filedrop',data:this.opts.fileData};this.app.api('module.upload.send',c)},onmodal:{file:{open:function(a,b){this._setFormData(a,b);this._setUpload(b)},opened:function(a,b){this._setFormFocus(b);this.$form=b}}},onupload:{file:{complete:function(a){this._insert(a)},error:function(a){this._uploadError(a)}},filedrop:{complete:function(a,e){this._insert(a,e)},error:function(a){this._uploadError(a)}}},oncontextbar:function(e,a){var b=this.selection.getCurrent();var c=this.inspector.parse(b);if(c.isFile()){var d=c.getFile();var f={"remove":{title:this.lang.get('delete'),api:'module.file.remove',args:d}};a.set(e,d,f,'bottom')}},open:function(){this._open()},insert:function(a){this._insert(a)},remove:function(a){this._remove(a)},_open:function(){this.app.api('module.modal.build',this._getModalData())},_getModalData:function(){var a={name:'file',title:this.lang.get('file')};return a},_insert:function(a,e){this.app.api('module.modal.close');if(typeof a!=='object')return;if(Array.isArray(a)){var b={};for(var i=0;i<a.length;i++){b=H.extend(b,a[i])}a=b}var c=(Object.keys(a).length>1);if(c){this._insertMultiple(a,e)}else{this._insertSingle(a,e)}this.$form=false},_insertSingle:function(a,e){var b=[];for(var c in a){var d=this._createFileAndStore(a[c]);if(this.opts.fileAttachment){b=this._insertAsAttachment(d)}else{b=(e)?this.insertion.insertToPoint(e,d):this.insertion.insertRaw(d)}this.app.broadcast('file.uploaded',b[0],a)}},_insertMultiple:function(a,e){var z=0;var b=[];var c;for(var d in a){z++;var f=this._createFileAndStore(a[d]);if(this.opts.fileAttachment){b=this._insertAsAttachment(f,a)}else{if(z===1){b=(e)?this.insertion.insertToPoint(e,f):this.insertion.insertRaw(f)}else{var g=H.dom(b[0]);g.after(f).after(' ');b=[f.get()];this.app.broadcast('file.inserted',f)}}c=f;this.app.broadcast('file.uploaded',b[0],a)}if(!this.opts.fileAttachment){this.caret.setAfter(c)}},_insertAsAttachment:function(a,b){var c=H.dom(this.opts.fileAttachment);var d=a.wrapAttachment();c.append(d);var e=[d.get()];this.app.broadcast('file.appended',e[0],b);return e},_createFileAndStore:function(a){var b=(this.$form)?this.$form.getData():false;var c=(a.name)?a.name:a.url;var d=(!this.opts.fileAttachment&&b&&b.title!=='')?b.title:this._truncateUrl(c);var e=this.component.create('file');e.attr('href',a.url);e.attr('data-file',(a.id)?a.id:this.utils.getRandomId());e.attr('data-name',a.name);e.html(d);this.storage.add('file',e);return e},_remove:function(a){this.selection.save();var b=this.component.create('file',a);var c=this.app.broadcast('file.delete',b);if(c!==false){b.unwrap();this.selection.restore();this.app.broadcast('file.deleted',b)}else{this.selection.restore()}},_truncateUrl:function(a){return(a.search(/^http/)!==-1&&a.length>20)?a.substring(0,20)+'...':a},_setUpload:function(a){var b={url:this.opts.fileUpload,element:a.getField('file'),name:'file',data:this.opts.fileData,paramName:this.opts.fileUploadParam};this.app.api('module.upload.build',b)},_setFormData:function(a,b){if(this.opts.fileAttachment){a.find('.form-item-title').hide()}else{b.setData({title:this.selection.getText()})}},_setFormFocus:function(a){a.getField('title').focus()},_uploadError:function(a){this.app.broadcast('file.uploadError',a)}});H.add('class','file.component',{mixins:['dom','component'],init:function(a,b){this.app=a;this.opts=a.opts;return(b&&b.cmnt!==undefined)?b:this._init(b)},wrapAttachment:function(){this.$wrapper=H.dom('<span class="redactor-file-item">');this.$remover=H.dom('<span class="redactor-file-remover">');this.$remover.html('&times;');this.$remover.on('click',this.removeAttachment.bind(this));this.$wrapper.append(this);this.$wrapper.append(this.$remover);return this.$wrapper},removeAttachment:function(e){e.preventDefault();var a=this.app.broadcast('file.delete',this,this.$wrapper);if(a!==false){this.$wrapper.remove();this.app.broadcast('file.deleted',this);this.app.broadcast('file.removeAttachment',this)}},_init:function(a){if(a===undefined){this.parse('<a>')}else{var b=H.dom(a).closest('a');this.parse(b)}}});H.add('module','buffer',{init:function(a){this.app=a;this.opts=a.opts;this.editor=a.editor;this.offset=a.offset;this.keycodes=a.keycodes;this.selection=a.selection;this.state=false;this.passed=false;this.keyPressed=false;this.savedHtml=false;this.savedOffset=false;this.undoStorage=[];this.redoStorage=[]},onkeydown:function(e){this._listen(e)},onsyncing:function(){if(!this.keyPressed){this.trigger()}this.keyPressed=false},onstate:function(e,a,b){if((e&&(e.ctrlKey||e.metaKey))||(e&&(this._isUndo(e)||this._isRedo(e)))){return}this.passed=false;this._saveState(a,b)},onenable:function(){this.clear()},clear:function(){this.state=false;this.undoStorage=[];this.redoStorage=[]},undo:function(){this._getUndo()},redo:function(){this._getRedo()},trigger:function(){if(this.state&&this.passed===false)this._setUndo()},_saveState:function(a,b){var c=this.editor.getElement();this.state={html:a||c.html(),offset:b||this.offset.get()}},_listen:function(e){var a=e.which;var b=e.ctrlKey||e.metaKey;var c=b||e.shiftKey||e.altKey;var d=[this.keycodes.SPACE,this.keycodes.ENTER,this.keycodes.BACKSPACE,this.keycodes.DELETE,this.keycodes.TAB,this.keycodes.LEFT,this.keycodes.RIGHT,this.keycodes.UP,this.keycodes.DOWN];if(this._isUndo(e)){e.preventDefault();this.undo();return}else if(this._isRedo(e)){e.preventDefault();this.redo();return}else if(!b&&d.indexOf(a)!==-1){c=true;this.trigger()}else if(b&&(a===88||a===67)){c=true;this.trigger()}if(!c&&!this._hasUndo()){this.trigger()}this.keyPressed=true},_isUndo:function(e){var a=e.which;var b=e.ctrlKey||e.metaKey;return(b&&a===90&&!e.shiftKey&&!e.altKey)},_isRedo:function(e){var a=e.which;var b=e.ctrlKey||e.metaKey;return(b&&(a===90&&e.shiftKey||a===89&&!e.shiftKey)&&!e.altKey)},_setUndo:function(){var a=this.undoStorage[this.undoStorage.length-1];if(typeof a==='undefined'||a[0]!==this.state.html){this.undoStorage.push([this.state.html,this.state.offset]);this._removeOverStorage()}},_setRedo:function(){var a=this.editor.getElement();var b=this.offset.get();var c=a.html();this.redoStorage.push([c,b]);this.redoStorage=this.redoStorage.slice(0,this.opts.bufferLimit)},_getUndo:function(){if(!this._hasUndo())return;this.passed=true;var a=this.editor.getElement();var b=this.undoStorage.pop();this._setRedo();a.html(b[0]);this.offset.set(b[1]);this.selection.restore();this.app.broadcast('undo',b[0],b[1])},_getRedo:function(){if(!this._hasRedo())return;this.passed=true;var a=this.editor.getElement();var b=this.redoStorage.pop();this._setUndo();a.html(b[0]);this.offset.set(b[1]);this.app.broadcast('redo',b[0],b[1])},_removeOverStorage:function(){if(this.undoStorage.length>this.opts.bufferLimit){this.undoStorage=this.undoStorage.slice(0,(this.undoStorage.length-this.opts.bufferLimit))}},_hasUndo:function(){return(this.undoStorage.length!==0)},_hasRedo:function(){return(this.redoStorage.length!==0)}});H.add('module','list',{init:function(a){this.app=a;this.opts=a.opts;this.utils=a.utils;this.block=a.block;this.toolbar=a.toolbar;this.inspector=a.inspector;this.selection=a.selection},onbutton:{list:{observe:function(a){this._observeButton(a)}}},ondropdown:{list:{observe:function(a){this._observeDropdown(a)}}},toggle:function(a){var b=this._getBlocks();var c=this.selection.getBlock();var d=H.dom(c).parents('ul, ol','.redactor-in').last();if(b.length===0&&d.length!==0){b=[d.get()]}if(c&&(c.tagName==='TD'||c.tagName==='TH')){b=this.block.format('div')}this.selection.saveMarkers();b=(b.length!==0&&this._isUnformat(a,b))?this._unformat(a,b):this._format(a,b);this.selection.restoreMarkers();return b},indent:function(){var a=this.selection.isCollapsed();var b=this.selection.getCurrent();var c=this.inspector.parse(b);var d=(c.isList())?c.getListItem():false;var e=H.dom(d);var f=e.prevElement();var g=f.get();var h=(a&&d&&g&&g.tagName==='LI');if(h){this.selection.saveMarkers();f=H.dom(g);var i=f.children('ul, ol');var j=e.closest('ul, ol');if(i.length!==0){i.append(e)}else{var k=j.get().tagName.toLowerCase();var l=H.dom('<'+k+'>');l.append(e);f.append(l)}this.selection.restoreMarkers()}},outdent:function(){var a=this.selection.isCollapsed();var b=this.selection.getCurrent();var c=this.inspector.parse(b);var d=(c.isList())?c.getListItem():false;var e=H.dom(d);if(a&&d){var f=e.parent();var g=f.closest('li','.redactor-in');var h=e.prevElement();var j=e.nextElement();var k=h.get();var l=j.get();var m,nextList,$newList,$nextList;var n=(k===false);var o=(k!==false&&l!==false);var p=(!n&&l===false);this.selection.saveMarkers();if(g.length!==0){if(o){m=this._getAllNext(e.get());$newList=H.dom('<'+f.get().tagName.toLowerCase()+'>');for(var i=0;i<m.length;i++){$newList.append(m[i])}g.after(e);e.append($newList)}else{g.after(e);if(f.children().length===0){f.remove()}else{if(n)e.append(f)}}}else{var q=this._createUnformatContainer(e);var r=q.find('ul, ol').first();if(n)f.before(q);else if(p)f.after(q);else if(o){$newList=H.dom('<'+f.get().tagName.toLowerCase()+'>');m=this._getAllNext(e.get());for(var i=0;i<m.length;i++){$newList.append(m[i])}f.after(q);q.after($newList)}if(r.length!==0){$nextList=q.nextElement();nextList=$nextList.get();if(nextList&&nextList.tagName===f.get().tagName){H.dom(nextList).prepend(r);r.unwrap()}else{q.after(r)}}e.remove()}this.selection.restoreMarkers()}},_getAllNext:function(a){var b=[];while(a){var c=H.dom(a).nextElement();a=c.get();if(a)b.push(a);else return b}return b},_isUnformat:function(a,b){var c=0;for(var i=0;i<b.length;i++){if(b[i].nodeType!==3){var d=b[i].tagName.toLowerCase();if(d===a||d==='figure'){c++}}}return(c===b.length)},_format:function(a,b){var c=['p','div','blockquote','pre','h1','h2','h3','h4','h5','h6','ul','ol'];var d=this._uniteBlocks(b,c);var e=[];for(var f in d){var g=d[f];var h=this._createList(a,d[f]);for(var i=0;i<g.length;i++){var j;if(g[i].nodeType!==3&&(g[i].tagName==='UL'||g[i].tagName==='OL')){var k=H.dom(g[i]);j=k.contents();h.append(j);if(this.utils.isEmpty(k))k.remove()}else{j=this._createListItem(g[i]);this.utils.normalizeTextNodes(j);h.append(j)}}e.push(h.get())}return e},_uniteBlocks:function(a,b){var z=0;var c={0:[]};var d=false;for(var i=0;i<a.length;i++){var e=H.dom(a[i]);var f=e.closest('th, td');if(f.length!==0){if(f.get()!==d){z++;c[z]=[]}if(this._isUniteBlock(a[i],b)){c[z].push(a[i])}}else{if(this._isUniteBlock(a[i],b)){c[z].push(a[i])}else{z++;c[z]=[]}}d=f.get()}return c},_isUniteBlock:function(a,b){return(a.nodeType===3||b.indexOf(a.tagName.toLowerCase())!==-1)},_createList:function(a,b){var c=b[b.length-1];var d=H.dom(c);var e=H.dom('<'+a+'>');d.after(e);return e},_createListItem:function(a){var b=H.dom('<li>');if(a.nodeType===3){b.append(a)}else{var c=H.dom(a);b.append(c.contents());c.remove()}return b},_unformat:function(c,d){if(d.length===1){var e=H.dom(d[0]);var f=e.find('li');var g=this.selection.getNodes({tags:['li']});var h=this.selection.getBlock();var j=H.dom(h).closest('li');if(g.length===0&&j.length!==0){g=[j.get()]}if(g.length===f.length){return this._unformatEntire(d[0])}var k=this._getItemsPosition(f,g);if(k==='Top'){return this._unformatAtSide('before',g,e)}else if(k==='Bottom'){g.reverse();return this._unformatAtSide('after',g,e)}else if(k==='Middle'){var l=H.dom(g[g.length-1]);var m=false;var n=false;var o=H.dom('<'+e.get().tagName.toLowerCase()+'>');f.each(function(a){if(m){var b=H.dom(a);if(b.closest('.redactor-split-item').length===0&&(n===false||b.closest(n).length===0)){b.addClass('redactor-split-item')}n=b}if(a===l.get()){m=true}});f.filter('.redactor-split-item').each(function(a){var b=H.dom(a);b.removeClass('redactor-split-item');o.append(a)});e.after(o);g.reverse();for(var i=0;i<g.length;i++){var p=H.dom(g[i]);var q=this._createUnformatContainer(p);e.after(q);q.find('ul, ol').remove();p.remove()}return}}else{for(var i=0;i<d.length;i++){if(d[i].nodeType!==3&&d[i].tagName.toLowerCase()===c){this._unformatEntire(d[i])}}}},_unformatEntire:function(d){var e=H.dom(d);var f=e.find('li');f.each(function(a){var b=H.dom(a);var c=this._createUnformatContainer(b);b.remove();e.before(c)}.bind(this));e.remove()},_unformatAtSide:function(d,e,f){for(var i=0;i<e.length;i++){var g=H.dom(e[i]);var h=this._createUnformatContainer(g);f[d](h);var j=h.find('ul, ol').first();g.append(j);j.each(function(a){var b=H.dom(a);var c=b.closest('li');if(c.get()===e[i]){b.unwrap();c.addClass('r-unwrapped')}});if(this.utils.isEmptyHtml(g.html()))g.remove()}f.find('.r-unwrapped').each(function(a){var b=H.dom(a);if(b.html().trim()==='')b.remove();else b.removeClass('r-unwrapped')})},_getItemsPosition:function(a,b){var c='Middle';var d=b[0];var e=b[b.length-1];var f=a.first().get();var g=a.last().get();if(f===d&&g!==e){c='Top'}else if(f!==d&&g===e){c='Bottom'}return c},_createUnformatContainer:function(a){var b=H.dom('<'+this.opts.markup+'>');if(this.opts.breakline)b.attr('data-redactor-tag','br');b.append(a.contents());return b},_getBlocks:function(){return this.selection.getBlocks({first:true})},_observeButton:function(){var a=this.selection.getCurrent();var b=this.inspector.parse(a);var c=(b.isPre()||b.isCode()||b.isFigcaption());this._observeButtonsList(c,['lists','ul','ol','outdent','indent']);var d=this.toolbar.getButton('outdent');var e=this.toolbar.getButton('indent');this._observeIndent(e,d)},_observeDropdown:function(a){var b=a.getItem('outdent');var c=a.getItem('indent');this._observeIndent(c,b)},_observeIndent:function(a,b){var c=this.selection.isCollapsed();var d=this.selection.getCurrent();var e=this.inspector.parse(d);var f=(e.isList())?e.getListItem():false;var g=H.dom(f);var h=g.prevElement();var i=h.get();var j=(c&&f&&i&&i.tagName==='LI');if(b){if(f&&c)b.enable();else b.disable()}if(a){if(f&&j)a.enable();else a.disable()}},_observeButtonsList:function(a,b){for(var i=0;i<b.length;i++){var c=this.toolbar.getButton(b[i]);if(c){if(a)c.disable();else c.enable()}}}});H.add('class','video.component',{mixins:['dom','component'],init:function(a,b){this.app=a;return(b&&b.cmnt!==undefined)?b:this._init(b)},_init:function(a){if(typeof a!=='undefined'){var b=H.dom(a);var c=b.closest('figure');if(c.length!==0){this.parse(c)}else{this.parse('<figure>');this.append(a)}}else{this.parse('<figure>')}this._initWrapper()},_initWrapper:function(){this.addClass('redactor-component');this.attr({'data-redactor-type':'video','tabindex':'-1','contenteditable':false})}});window.Redactor=window.$R=H;window.addEventListener('load',function(){H('[data-redactor]')})}());